<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HSK Flashcards</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Noto+Serif+SC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="supabase-client.js"></script>
<style>
  :root {
    --cream: #f0ebe0; --cream-dark: #e5dfd2; --cream-mid: #ede8dc;
    --gold: #8b6914; --gold-light: #c4a035; --red: #8b1a1a; --red-light: #c0392b;
    --ink: #2c2416; --ink-light: #5a4e3a; --ink-muted: #8a7a62;
    --green: #2d5a3d; --blue: #1a3a5c; --card-bg: #faf7f2; --border: rgba(139,105,20,0.2);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'EB Garamond', Georgia, serif; background: var(--cream); color: var(--ink); min-height: 100vh; background-image: radial-gradient(ellipse at 20% 50%, rgba(139,105,20,0.04) 0%, transparent 60%), radial-gradient(ellipse at 80% 20%, rgba(139,26,26,0.03) 0%, transparent 50%); }
  header {
    background: var(--cream); border-bottom: 1px solid var(--border);
    padding: 0 32px; display: flex; align-items: center;
    justify-content: space-between; height: 64px;
    position: sticky; top: 0; z-index: 100; gap: 16px;
  }
  .logo { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
  .logo-char { font-family: 'Noto Serif SC', serif; font-size: 32px; color: var(--red); font-weight: 700; line-height: 1; }
  .logo-text { font-size: 11px; letter-spacing: 0.22em; color: var(--ink-muted); text-transform: uppercase; }
  /* Stats moved to below-header strip */
  .header-stats { display: none; }
  .stat { text-align: center; }
  .stat-num { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 600; color: var(--ink); line-height: 1; }
  .stat-label { font-size: 10px; letter-spacing: 0.15em; color: var(--ink-muted); text-transform: uppercase; margin-top: 2px; }
  /* Stats strip below nav */
  .stats-strip {
    background: var(--cream); border-bottom: 1px solid var(--border);
    padding: 0 32px; display: flex; align-items: center; justify-content: center;
    gap: 48px;
  }
  .stats-strip .stat { padding: 10px 0; }
  .script-toggle { display: flex; background: var(--cream-dark); border-radius: 40px; padding: 3px; border: 1px solid var(--border); flex-shrink: 0; }
  .script-btn { background: none; border: none; font-family: 'EB Garamond', serif; font-size: 13px; letter-spacing: 0.06em; padding: 5px 14px; border-radius: 30px; cursor: pointer; color: var(--ink-muted); transition: all 0.25s; white-space: nowrap; }
  .script-btn.active { background: var(--card-bg); color: var(--gold); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .user-area { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border); background: var(--cream-dark); display: flex; align-items: center; justify-content: center; font-family: 'Noto Serif SC', serif; font-size: 14px; color: var(--gold); overflow: hidden; flex-shrink: 0; }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-name { font-size: 14px; color: var(--ink-light); max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .logout-btn { border: 1px solid var(--border); background: none; border-radius: 30px; padding: 5px 12px; font-family: 'EB Garamond', serif; font-size: 13px; color: var(--ink-muted); cursor: pointer; transition: all 0.2s; letter-spacing: 0.04em; white-space: nowrap; }
  .logout-btn:hover { border-color: var(--red); color: var(--red); }
  nav { border-bottom: 1px solid var(--border); padding: 0 48px; display: flex; align-items: center; gap: 6px; background: var(--cream); flex-wrap: wrap; }
  .nav-label { font-size: 11px; letter-spacing: 0.2em; color: var(--ink-muted); text-transform: uppercase; margin-right: 10px; }
  .level-btn { border: 1px solid transparent; background: none; padding: 10px 18px; font-family: 'EB Garamond', serif; font-size: 14px; cursor: pointer; color: var(--ink-light); border-radius: 4px; transition: all 0.2s; margin: 8px 2px; }
  .level-btn:hover { border-color: var(--border); }
  .level-btn.active { background: var(--gold); color: #fff; border-color: var(--gold); }
  main { max-width: 740px; margin: 0 auto; padding: 36px 24px 60px; }
  .progress-counters { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .counter-pill { display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); border-radius: 30px; padding: 6px 18px; font-size: 14px; color: var(--ink-light); background: var(--card-bg); }
  .counter-dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot-red { background: var(--red-light); } .dot-blue { background: var(--blue); } .dot-green { background: var(--green); }
  .progress-bar-wrap { height: 6px; background: var(--cream-dark); border-radius: 3px; margin-bottom: 32px; overflow: hidden; }
  .progress-bar { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--red) 0%, var(--gold) 100%); transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
  .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; padding: 60px 56px; min-height: 340px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 4px 24px rgba(44,36,22,0.06); animation: fadeSlide 0.35s ease; }
  @keyframes fadeSlide { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .hsk-badge { display: inline-block; font-size: 10px; letter-spacing: 0.15em; border: 1px solid var(--gold-light); color: var(--gold); padding: 2px 8px; border-radius: 2px; margin-bottom: 12px; }
  .card-top { margin-bottom: 20px; }
  .card-chinese { font-family: 'Noto Serif SC', serif; font-size: 80px; color: var(--ink); font-weight: 400; line-height: 1.05; }
  .card-pinyin { font-family: 'Playfair Display', serif; font-size: 32px; font-style: italic; color: var(--red); margin-top: 12px; }
  .card-meaning { font-size: 16px; color: var(--ink-light); margin-top: 4px; }
  .card-example { margin-top: 20px; padding: 16px 20px; background: rgba(139,105,20,0.05); border-left: 3px solid var(--gold); border-radius: 0 3px 3px 0; }
  .card-example-label { font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 8px; }
  .card-example-zh { font-family: 'Noto Serif SC', serif; font-size: 20px; color: var(--ink); line-height: 1.5; }
  .card-example-py { font-family: 'Playfair Display', serif; font-size: 14px; font-style: italic; color: var(--red); margin-top: 4px; }
  .card-example-en { font-size: 13px; color: var(--ink-muted); margin-top: 4px; }
  .reveal-btn { width: 100%; margin-top: 32px; padding: 22px; border: 1.5px dashed var(--border); background: none; border-radius: 3px; font-family: 'EB Garamond', serif; font-size: 20px; color: var(--ink-muted); cursor: pointer; letter-spacing: 0.08em; transition: all 0.2s; }
  .reveal-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(139,105,20,0.04); }
  .card-answer { animation: fadeSlide 0.25s ease; }
  .card-alt-label { font-size: 13px; color: var(--ink-muted); margin-top: 6px; }
  .card-alt-label span { font-family: 'Noto Serif SC', serif; font-size: 15px; color: var(--ink-light); }
  .card-divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  .speak-row { display: flex; gap: 10px; margin-bottom: 24px; }
  .speak-btn { display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); background: none; border-radius: 3px; padding: 9px 18px; font-family: 'EB Garamond', serif; font-size: 15px; color: var(--ink-light); cursor: pointer; transition: all 0.2s; }
  .speak-btn:hover { background: var(--cream-dark); color: var(--ink); }
  .speak-icon { width: 18px; height: 18px; }
  .section-label { font-size: 10px; letter-spacing: 0.25em; color: var(--ink-muted); text-transform: uppercase; text-align: center; display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .section-label::before, .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .chars-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 32px; }
  .char-tile { border: 1px solid var(--border); border-radius: 3px; padding: 12px 18px; text-align: center; background: var(--card-bg); min-width: 66px; transition: all 0.2s; }
  .char-tile:hover { border-color: var(--gold-light); box-shadow: 0 2px 8px rgba(139,105,20,0.1); }
  .char-tile-char { font-family: 'Noto Serif SC', serif; font-size: 30px; color: var(--ink); display: block; }
  .recall-row { display: flex; gap: 12px; margin-top: 8px; }
  .recall-btn { flex: 1; border: none; padding: 16px 10px; border-radius: 6px; font-family: 'EB Garamond', serif; cursor: pointer; transition: all 0.18s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .recall-btn:active { transform: scale(0.97); }
  .recall-btn-label { font-size: 18px; font-weight: 600; }
  .recall-icon { font-size: 16px; line-height: 1; }
  .recall-again { background: #fef2f2; color: #c0392b; }
  .recall-again:hover { background: #fde8e8; box-shadow: 0 4px 14px rgba(192,57,43,0.18); }
  .recall-good  { background: #f0faf4; color: #1e7e45; }
  .recall-good:hover  { background: #e3f7ec; box-shadow: 0 4px 14px rgba(30,126,69,0.18); }
  .loading { text-align: center; padding: 80px; }
  .loading-char { font-family: 'Noto Serif SC', serif; font-size: 56px; color: var(--gold); animation: pulse 1.5s ease infinite; }
  @keyframes pulse { 0%,100%{opacity:.3} 50%{opacity:1} }
  .loading-text { color: var(--ink-muted); font-size: 15px; margin-top: 12px; font-style: italic; }
  .done-state { text-align: center; padding: 60px 40px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; animation: fadeSlide 0.4s ease; }
  .done-char { font-family: 'Noto Serif SC', serif; font-size: 72px; color: var(--gold); margin-bottom: 16px; }
  .done-title { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--ink); margin-bottom: 10px; }
  .done-subtitle { color: var(--ink-muted); font-size: 16px; font-style: italic; }
  .restart-btn { margin-top: 28px; border: 1px solid var(--gold); background: none; padding: 12px 32px; border-radius: 3px; font-family: 'EB Garamond', serif; font-size: 16px; color: var(--gold); cursor: pointer; letter-spacing: 0.08em; transition: all 0.2s; }
  .restart-btn:hover { background: var(--gold); color: #fff; }

  /* â”€â”€ Daily Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .daily-bar-section {
    position: relative;
    margin-bottom: 28px;
  }
  .daily-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 10px;
  }
  .daily-bar-label {
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }
  .daily-bar-count {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    color: var(--ink-light);
    transition: color 0.6s ease;
  }
  .daily-bar-count.complete { color: #2d7a4f; font-weight: 600; }

  .daily-bar-track {
    height: 10px;
    background: var(--cream-dark);
    border-radius: 99px;
    overflow: visible;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(44,36,22,0.08);
  }
  .daily-bar-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
    transition: width 0.7s cubic-bezier(0.4, 0, 0.2, 1), background 0.8s ease;
    position: relative;
    min-width: 0;
    box-shadow: 0 1px 4px rgba(139,105,20,0.35);
  }
  .daily-bar-fill.complete {
    background: linear-gradient(90deg, #2d7a4f 0%, #4aaa76 100%);
    box-shadow: 0 1px 8px rgba(45,122,79,0.4);
  }
  /* Shimmer animation while in progress */
  .daily-bar-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 99px;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    background-size: 200% 100%;
    animation: shimmer 2.2s ease infinite;
  }
  .daily-bar-fill.complete::after { display: none; }
  @keyframes shimmer {
    0%   { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }
  /* Glowing dot at the tip */
  .daily-bar-fill::before {
    content: '';
    position: absolute;
    right: -1px;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--gold-light);
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px var(--gold-light), 0 2px 6px rgba(139,105,20,0.4);
    transition: background 0.8s ease, box-shadow 0.8s ease;
    opacity: 1;
  }
  .daily-bar-fill.complete::before {
    background: #4aaa76;
    box-shadow: 0 0 0 2px #4aaa76, 0 2px 8px rgba(45,122,79,0.5);
  }
  /* Hide dot when bar is empty */
  .daily-bar-fill[style*="width: 0"]::before,
  .daily-bar-fill[style*="width:0"]::before { opacity: 0; }

  /* Milestone ticks */
  .daily-bar-ticks {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 10px;
    pointer-events: none;
  }
  .daily-bar-tick {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background: rgba(255,255,255,0.5);
  }

  /* â”€â”€ Toast Notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #fff;
    border-radius: 16px;
    padding: 18px 28px 18px 22px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow:
      0 8px 32px rgba(44,36,22,0.14),
      0 2px 8px rgba(44,36,22,0.08),
      0 0 0 1px rgba(45,122,79,0.15);
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.2,0.8,0.3,1);
    max-width: 420px;
    width: calc(100vw - 48px);
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }
  .toast-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2d7a4f 0%, #4aaa76 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    animation: toastPop 0.5s cubic-bezier(0.2,0.8,0.3,1) 0.1s both;
  }
  @keyframes toastPop {
    from { transform: scale(0.5); opacity: 0; }
    to   { transform: scale(1);   opacity: 1; }
  }
  .toast-icon svg { width: 22px; height: 22px; stroke: #fff; }
  .toast-body { flex: 1; min-width: 0; }
  .toast-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    color: #1a3a2a;
    font-weight: 600;
    margin-bottom: 3px;
  }
  .toast-msg {
    font-family: 'EB Garamond', serif;
    font-size: 14px;
    color: #5a7a68;
    line-height: 1.4;
  }
  .toast-close {
    background: none;
    border: none;
    cursor: pointer;
    color: #aaa;
    padding: 4px;
    border-radius: 50%;
    transition: color 0.2s;
    flex-shrink: 0;
    line-height: 1;
  }
  .toast-close:hover { color: #555; }

  /* Confetti burst */
  .confetti-canvas {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9998;
  }


  /* â”€â”€ Settings icon in header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .settings-btn {
    display: flex; align-items: center; justify-content: center;
    width: 36px; height: 36px; border-radius: 50%;
    border: 1px solid var(--border); background: none; cursor: pointer;
    color: var(--ink-muted); transition: all 0.22s; flex-shrink: 0;
  }
  .settings-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(139,105,20,0.05); transform: rotate(30deg); }
  .settings-btn svg { width: 17px; height: 17px; }

  /* â”€â”€ Overlay backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .overlay {
    position: fixed; inset: 0; background: rgba(44,36,22,0.45);
    z-index: 1000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease; backdrop-filter: blur(2px);
  }
  .overlay.show { opacity: 1; pointer-events: auto; }

  /* â”€â”€ Shared modal base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal {
    position: fixed; z-index: 1001;
    background: var(--card-bg); border: 1px solid var(--border);
    box-shadow: 0 20px 60px rgba(44,36,22,0.18), 0 4px 16px rgba(44,36,22,0.08);
    display: flex; flex-direction: column;
  }
  .modal-header {
    padding: 28px 32px 0;
    display: flex; align-items: flex-start; justify-content: space-between;
    flex-shrink: 0;
  }
  .modal-title {
    font-family: 'Playfair Display', serif; font-size: 22px;
    color: var(--ink); margin-bottom: 4px;
  }
  .modal-sub { font-size: 14px; color: var(--ink-muted); font-style: italic; }
  .modal-close {
    background: none; border: none; cursor: pointer; color: var(--ink-muted);
    padding: 4px; border-radius: 50%; transition: color 0.2s; margin-top: -4px;
    flex-shrink: 0;
  }
  .modal-close:hover { color: var(--ink); }
  .modal-body { padding: 24px 32px; overflow-y: auto; flex: 1; }
  .modal-footer {
    padding: 20px 32px 28px; border-top: 1px solid var(--border);
    display: flex; gap: 10px; justify-content: flex-end; flex-shrink: 0;
  }

  /* â”€â”€ Onboarding modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .onboarding-modal {
    top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.92);
    border-radius: 8px; width: 100%; max-width: 440px;
    transition: transform 0.35s cubic-bezier(0.2,0.8,0.3,1), opacity 0.3s ease;
    opacity: 0;
  }
  .onboarding-modal.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  .onboarding-hero {
    text-align: center; padding: 36px 32px 12px;
  }
  .onboarding-char {
    font-family: 'Noto Serif SC', serif; font-size: 64px; color: var(--red);
    font-weight: 700; line-height: 1; display: block; margin-bottom: 16px;
    filter: drop-shadow(0 2px 10px rgba(139,26,26,0.2));
  }
  .onboarding-title {
    font-family: 'Playfair Display', serif; font-size: 24px; color: var(--ink); margin-bottom: 8px;
  }
  .onboarding-sub {
    font-size: 15px; color: var(--ink-muted); font-style: italic; line-height: 1.5;
  }
  .target-picker {
    display: flex; flex-direction: column; align-items: center; gap: 20px;
    padding: 28px 0 8px;
  }
  .target-display {
    font-family: 'Playfair Display', serif; font-size: 72px; color: var(--gold);
    line-height: 1; transition: all 0.15s ease; min-width: 120px; text-align: center;
  }
  .target-display-sub {
    font-size: 14px; color: var(--ink-muted); margin-top: -8px; text-align: center;
    letter-spacing: 0.08em;
  }
  .target-slider {
    width: 100%; -webkit-appearance: none; appearance: none;
    height: 6px; border-radius: 3px; outline: none; cursor: pointer;
    background: linear-gradient(90deg, var(--gold) 0%, var(--gold) var(--pct, 20%), var(--cream-dark) var(--pct, 20%), var(--cream-dark) 100%);
    transition: background 0.1s;
  }
  .target-slider::-webkit-slider-thumb {
    -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%;
    background: var(--gold); border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(139,105,20,0.4); cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .target-slider::-webkit-slider-thumb:hover { transform: scale(1.15); box-shadow: 0 3px 12px rgba(139,105,20,0.5); }
  .target-presets {
    display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
  }
  .preset-btn {
    border: 1px solid var(--border); background: none; border-radius: 20px;
    padding: 6px 16px; font-family: 'EB Garamond', serif; font-size: 14px;
    color: var(--ink-light); cursor: pointer; transition: all 0.18s;
  }
  .preset-btn:hover { border-color: var(--gold); color: var(--gold); }
  .preset-btn.active { background: var(--gold); border-color: var(--gold); color: #fff; }

  /* â”€â”€ Settings panel (slide-in from right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .settings-panel {
    top: 0; right: 0; bottom: 0; width: 100%; max-width: 400px;
    border-radius: 0; border-right: none;
    transform: translateX(100%); opacity: 1;
    transition: transform 0.35s cubic-bezier(0.2,0.8,0.3,1);
  }
  .settings-panel.show { transform: translateX(0); }

  /* Settings sections */
  .settings-section {
    margin-bottom: 28px; padding-bottom: 28px;
    border-bottom: 1px solid var(--border);
  }
  .settings-section:last-child { border-bottom: none; margin-bottom: 0; }
  .settings-section-title {
    font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--ink-muted); margin-bottom: 16px;
  }
  .settings-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; gap: 16px;
  }
  .settings-row-label { font-size: 15px; color: var(--ink); }
  .settings-row-sub { font-size: 12px; color: var(--ink-muted); margin-top: 1px; }

  /* Number input stepper */
  .stepper {
    display: flex; align-items: center; gap: 0;
    border: 1px solid var(--border); border-radius: 4px; overflow: hidden;
  }
  .stepper-btn {
    background: var(--cream-dark); border: none; width: 34px; height: 34px;
    font-size: 18px; cursor: pointer; color: var(--ink-light);
    transition: background 0.15s; display: flex; align-items: center; justify-content: center;
  }
  .stepper-btn:hover { background: var(--cream); color: var(--gold); }
  .stepper-val {
    width: 52px; text-align: center; font-family: 'Playfair Display', serif;
    font-size: 18px; color: var(--ink); background: var(--card-bg);
    border: none; padding: 0; outline: none;
  }

  /* Toggle switch */
  .toggle-wrap { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
  .toggle-wrap input { opacity: 0; width: 0; height: 0; }
  .toggle-track {
    position: absolute; inset: 0; border-radius: 12px;
    background: var(--cream-dark); border: 1px solid var(--border);
    cursor: pointer; transition: background 0.25s, border-color 0.25s;
  }
  .toggle-track::before {
    content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%;
    background: #fff; top: 2px; left: 2px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
  }
  .toggle-wrap input:checked + .toggle-track { background: var(--gold); border-color: var(--gold); }
  .toggle-wrap input:checked + .toggle-track::before { transform: translateX(20px); }

  /* Segment control */
  .segment {
    display: flex; border: 1px solid var(--border); border-radius: 4px;
    overflow: hidden; background: var(--cream-dark);
  }
  .segment-btn {
    flex: 1; border: none; background: none; padding: 8px 12px;
    font-family: 'EB Garamond', serif; font-size: 14px; cursor: pointer;
    color: var(--ink-muted); transition: all 0.18s; white-space: nowrap;
  }
  .segment-btn.active {
    background: var(--card-bg); color: var(--gold);
    box-shadow: inset 0 1px 4px rgba(0,0,0,0.06);
  }

  /* Select dropdown */
  .settings-select {
    border: 1px solid var(--border); background: var(--card-bg); border-radius: 4px;
    padding: 7px 10px; font-family: 'EB Garamond', serif; font-size: 15px;
    color: var(--ink); cursor: pointer; outline: none; min-width: 110px;
  }
  .settings-select:focus { border-color: var(--gold); }

  /* Danger zone */
  .danger-btn {
    width: 100%; border: 1px solid rgba(139,26,26,0.25); background: none;
    border-radius: 3px; padding: 10px; font-family: 'EB Garamond', serif;
    font-size: 15px; color: var(--red); cursor: pointer; transition: all 0.2s;
    text-align: left;
  }
  .danger-btn:hover { background: rgba(139,26,26,0.04); border-color: var(--red); }

  /* Primary / secondary modal buttons */
  .btn-primary {
    border: 1px solid var(--gold); background: var(--gold); border-radius: 3px;
    padding: 10px 24px; font-family: 'EB Garamond', serif; font-size: 16px;
    color: #fff; cursor: pointer; transition: all 0.2s; letter-spacing: 0.04em;
  }
  .btn-primary:hover { background: #7a5c12; border-color: #7a5c12; }
  .btn-secondary {
    border: 1px solid var(--border); background: none; border-radius: 3px;
    padding: 10px 20px; font-family: 'EB Garamond', serif; font-size: 16px;
    color: var(--ink-light); cursor: pointer; transition: all 0.2s;
  }
  .btn-secondary:hover { border-color: var(--ink-muted); color: var(--ink); }

  @media (max-width: 700px) {
    header { padding: 0 16px; gap: 10px; }
    nav { padding: 0 12px; }
    .logo-text { display: none; }
    .user-name { display: none; }
    .stats-strip { gap: 28px; padding: 0 16px; }
    main { padding: 20px 12px; }
    .card { padding: 36px 24px; min-height: 260px; }
    .card-chinese { font-size: 56px; }
    .recall-label { display: none !important; }
    .toast { bottom: 20px; }
    .settings-panel { max-width: 100%; }
    .modal-body { padding: 20px; }
    .modal-header { padding: 20px 20px 0; }
    .modal-footer { padding: 16px 20px 24px; }
    .onboarding-char { font-size: 48px; }
    .target-display { font-size: 56px; }
  }

  /* â”€â”€ In-app paywall â”€â”€ */
  .paywall-state {
    text-align: center; padding: 48px 24px 40px;
    animation: fadeInUp 0.35s ease;
  }
  .paywall-state .pw-char {
    font-family: 'Noto Serif SC', serif;
    font-size: 72px; color: var(--red); line-height: 1; margin-bottom: 16px; display: block;
  }
  .paywall-state .pw-title {
    font-family: 'Playfair Display', serif;
    font-size: 24px; color: var(--ink); font-weight: 600; margin-bottom: 8px;
  }
  .paywall-state .pw-desc {
    font-size: 15px; color: var(--ink-muted); font-style: italic;
    line-height: 1.55; max-width: 320px; margin: 0 auto 24px;
  }
  .paywall-state .pw-price {
    font-family: 'Playfair Display', serif;
    font-size: 40px; color: var(--ink); font-weight: 600; margin-bottom: 4px;
  }
  .paywall-state .pw-note {
    font-size: 13px; color: var(--ink-muted); margin-bottom: 28px;
  }
  .paywall-state .pw-buy {
    display: inline-block; padding: 15px 36px;
    background: var(--red); color: #fff; border: none; border-radius: 5px;
    font-family: 'EB Garamond', serif; font-size: 18px; letter-spacing: 0.04em;
    cursor: pointer; transition: background 0.2s; margin-bottom: 14px;
  }
  .paywall-state .pw-buy:hover { background: #a01e1e; }
  .paywall-state .pw-buy:disabled { opacity: 0.6; pointer-events: none; }
  .paywall-state .pw-also {
    font-size: 13px; color: var(--ink-muted); margin-top: 14px;
  }
  .paywall-state .pw-also a { color: var(--gold); cursor: pointer; }

</style>
</head>
<body>
<header>
  <a class="logo" href="index.html" style="text-decoration:none;color:inherit">
    <div class="logo-char">æ¼¢</div>
    <div class="logo-text">HSK Flashcards</div>
  </a>
  <div class="script-toggle">
    <button class="script-btn active" onclick="setScript('simplified',this)">Simplified</button>
    <button class="script-btn" onclick="setScript('traditional',this)">Traditional</button>
  </div>
  <div class="user-area">
    <button class="settings-btn" onclick="openSettings()" aria-label="Settings" title="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
      </svg>
    </button>
    <div class="user-avatar" id="userAvatar">æ¼¢</div>
    <span class="user-name" id="userName"></span>
    <button class="logout-btn" onclick="logout()">Sign out</button>
  </div>
</header>
<nav>
  <span class="nav-label">Level:</span>
  <button class="level-btn" onclick="setLevel('all',this)">All HSK</button>
  <button class="level-btn active" onclick="setLevel(1,this)">HSK 1</button>
  <button class="level-btn" onclick="setLevel(2,this)">HSK 2</button>
  <button class="level-btn" onclick="setLevel(3,this)">HSK 3</button>
  <button class="level-btn" onclick="setLevel(4,this)">HSK 4</button>
  <button class="level-btn" onclick="setLevel(5,this)">HSK 5</button>
  <button class="level-btn" onclick="setLevel(6,this)">HSK 6</button>
</nav>
<!-- Stats strip -->
<div class="stats-strip">
  <div class="stat"><div class="stat-num" id="statDue">â€”</div><div class="stat-label">Due Today</div></div>
  <div class="stat"><div class="stat-num" id="statReviewed">0</div><div class="stat-label">Reviewed</div></div>
  <div class="stat"><div class="stat-num" id="statStreak">1</div><div class="stat-label">Day Streak</div></div>
</div>
<main>
  <!-- Daily Progress Bar -->
  <div class="daily-bar-section">
    <div class="daily-bar-header">
      <span class="daily-bar-label">Daily Target</span>
      <span class="daily-bar-count" id="dailyBarCount">0 / 20 cards</span>
    </div>
    <div class="daily-bar-track">
      <div class="daily-bar-fill" id="dailyBarFill" style="width:0%"></div>
      <div class="daily-bar-ticks" id="dailyBarTicks"></div>
    </div>
  </div>

  <div class="progress-counters">
    <div class="counter-pill"><span class="counter-dot dot-red"></span><span id="countNew">â€”</span> New</div>
    <div class="counter-pill"><span class="counter-dot dot-blue"></span><span id="countReview">0</span> Review</div>
    <div class="counter-pill"><span class="counter-dot dot-green"></span><span id="countDone">0</span> Done</div>
  </div>
  <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
  <div id="cardContainer">
    <div class="loading"><div class="loading-char">æ¼¢</div><div class="loading-text">Loading 5,000 wordsâ€¦</div></div>
  </div>
</main>

<!-- Toast notification -->
<div class="toast" id="toast" role="alert" aria-live="polite">
  <div class="toast-icon">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20 6L9 17l-5-5"/>
    </svg>
  </div>
  <div class="toast-body">
    <div class="toast-title">Daily target reached! ðŸŽ‰</div>
    <div class="toast-msg">Well done â€” your daily target is met! Now keep going!</div>
  </div>
  <button class="toast-close" onclick="dismissToast()" aria-label="Dismiss">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
  </button>
</div>
<canvas class="confetti-canvas" id="confettiCanvas"></canvas>

<!-- Shared overlay -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<!-- â”€â”€ Settings Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal settings-panel" id="settingsPanel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal-header">
    <div>
      <div class="modal-title" id="settingsTitle">Settings</div>
      <div class="modal-sub">Customise your study experience</div>
    </div>
    <button class="modal-close" onclick="closeSettings()" aria-label="Close settings">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>

  <div class="modal-body">

    <!-- Study Goals -->
    <div class="settings-section">
      <div class="settings-section-title">Study Goals</div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Daily target</div>
          <div class="settings-row-sub">Cards to complete each day</div>
        </div>
        <div class="stepper">
          <button class="stepper-btn" onclick="stepTarget(-5)">âˆ’</button>
          <input class="stepper-val" id="settingsTarget" type="number" value="20" min="5" max="200" onchange="clampTarget()">
          <button class="stepper-btn" onclick="stepTarget(5)">+</button>
        </div>
      </div>
    </div>

    <!-- Display -->
    <div class="settings-section">
      <div class="settings-section-title">Display</div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Default script</div>
          <div class="settings-row-sub">Shown when app loads</div>
        </div>
        <div class="segment" id="scriptSegment">
          <button class="segment-btn active" onclick="setSegment('scriptSegment', this, 'preferredScript', 'simplified')">Simplified</button>
          <button class="segment-btn" onclick="setSegment('scriptSegment', this, 'preferredScript', 'traditional')">Traditional</button>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Default HSK level</div>
          <div class="settings-row-sub">Level selected on load</div>
        </div>
        <select class="settings-select" id="settingsLevel" onchange="settingChanged('defaultLevel', this.value)">
          <option value="all">All HSK</option>
          <option value="1">HSK 1</option>
          <option value="2">HSK 2</option>
          <option value="3">HSK 3</option>
          <option value="4">HSK 4</option>
          <option value="5">HSK 5</option>
          <option value="6">HSK 6</option>
        </select>
      </div>
    </div>

    <!-- Audio -->
    <div class="settings-section">
      <div class="settings-section-title">Audio</div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Auto-play on reveal</div>
          <div class="settings-row-sub">Speak the word when you reveal a card</div>
        </div>
        <label class="toggle-wrap">
          <input type="checkbox" id="settingsAutoPlay" checked onchange="settingChanged('autoPlayAudio', this.checked)">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Voice persona</div>
          <div class="settings-row-sub">Chinese voice used for playback</div>
        </div>
        <select class="settings-select" id="settingsVoice" style="max-width:180px" onchange="settingChanged('voiceName', this.value)">
          <option value="">Loading voicesâ€¦</option>
        </select>
      </div>
      <div class="settings-row" id="voiceNoSupportRow" style="display:none">
        <div class="settings-row-sub" style="color:#c0392b">No Chinese voices found on this device. Install a Chinese language pack in your OS settings.</div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Speech speed</div>
          <div class="settings-row-sub">How fast words are spoken</div>
        </div>
        <div class="segment" id="speedSegment">
          <button class="segment-btn" onclick="setSegment('speedSegment', this, 'speechRate', 0.6)">Slow</button>
          <button class="segment-btn active" onclick="setSegment('speedSegment', this, 'speechRate', 0.85)">Normal</button>
          <button class="segment-btn" onclick="setSegment('speedSegment', this, 'speechRate', 1.15)">Fast</button>
        </div>
      </div>
      <div class="settings-row" style="padding-top:0">
        <button class="speak-btn" onclick="testVoice()" style="border:1px solid var(--gold);color:var(--gold)">
          <svg class="speak-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15.536 8.464a5 5 0 010 7.072M9 9.5l-2 1.5H4v3h3l2 1.5V9.5z" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Test voice
        </button>
      </div>
    </div>

    <!-- Analytics -->
    <div class="settings-section">
      <div class="settings-section-title">Analytics</div>
      <div class="settings-row">
        <div>
          <div class="settings-row-label">Session tracking</div>
          <div class="settings-row-sub">Save study sessions to Firebase</div>
        </div>
        <label class="toggle-wrap">
          <input type="checkbox" id="settingsTracking" checked onchange="settingChanged('trackingEnabled', this.checked)">
          <span class="toggle-track"></span>
        </label>
      </div>

    </div>

    <!-- Account -->
    <div class="settings-section">
      <div class="settings-section-title">Account</div>
      <div class="settings-row" style="padding-bottom:0">
        <div>
          <div class="settings-row-label" id="settingsUserName">â€”</div>
          <div class="settings-row-sub" id="settingsUserEmail">â€”</div>
        </div>
        <div class="user-avatar" id="settingsAvatar" style="width:38px;height:38px;font-size:16px">æ¼¢</div>
      </div>
    </div>

    <!-- Danger zone -->
    <div class="settings-section" style="border-bottom:none">
      <div class="settings-section-title">Account Actions</div>
      <button class="danger-btn" onclick="logout()">
        Sign out of HSK Flashcards
      </button>
    </div>

  </div>

  <div class="modal-footer">
    <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
    <button class="btn-primary" id="settingsSaveBtn" onclick="saveSettings()">Save changes</button>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allVocab=[], script='simplified', currentLevel=1;
let queue=[], doneCount=0, reviewed=0, cardsCorrect=0, currentCard=null;
let sessionNewSet=new Set(); // keys of new cards added to this session's queue

// â”€â”€â”€ FSRS-4 Algorithm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Weights from FSRS-4 default parameters (19 values)
const FSRS_W=[
  0.40255,1.18385,3.173,15.69105,7.1949,
  0.5345, 1.4604, 0.0046,1.54575,0.1192,
  1.01925,1.9395, 0.11,  0.29605,2.2698,
  0.2315, 2.9898, 0.51655,0.6621
];
const FSRS_F=19/81, FSRS_C=-0.5, FSRS_DESIRED_R=0.9;
const NEW_PER_DAY=20, MAX_INTERVAL=365;
const FSRS_KEY='hsk_fsrs_v1';

// Retrievability after t days with stability s
function fsrsR(t,s){ return Math.pow(1+FSRS_F*(t/s),FSRS_C); }

// Interval (days) at which R drops to desired retention
function fsrsInterval(s){
  const t=(s/FSRS_F)*(Math.pow(FSRS_DESIRED_R,1/FSRS_C)-1);
  return Math.max(1,Math.min(MAX_INTERVAL,Math.round(t)));
}

// Initial stability after first review (grade 1â€“4)
function fsrsS0(g){ return FSRS_W[g-1]; }

// Initial difficulty after first review
function fsrsD0(g){ return Math.max(1,Math.min(10,FSRS_W[4]-Math.exp(FSRS_W[5]*(g-1))+1)); }

// Stability after a successful review (grade 2,3,4)
function fsrsSSuccess(d,s,r,g){
  const alpha=1+(11-d)*Math.pow(s,-FSRS_W[9])*(Math.exp(FSRS_W[10]*(1-r))-1)
    *(g===2?FSRS_W[15]:1)*(g===4?FSRS_W[16]:1)*Math.exp(FSRS_W[8]);
  return Math.max(0.1,s*alpha);
}

// Stability after forgetting (grade 1)
function fsrsSFail(d,s,r){
  const sf=Math.pow(d,-FSRS_W[12])*(Math.pow(s+1,FSRS_W[13])-1)
    *Math.exp(FSRS_W[14]*(1-r))*FSRS_W[11];
  return Math.max(0.1,Math.min(sf,s));
}

// Update difficulty after n-th review
function fsrsDNext(d,g){
  const dp=d+(-FSRS_W[6]*(g-3))*((10-d)/9);
  return Math.max(1,Math.min(10,FSRS_W[7]*fsrsD0(4)+(1-FSRS_W[7])*dp));
}

// Compute next {s, d, interval} given current card state and grade (1 or 3)
function fsrsNext(cardState,grade){
  if(!cardState){
    const s=Math.max(0.1,fsrsS0(grade));
    const d=fsrsD0(grade);
    const interval=grade===1?1:fsrsInterval(s);
    return {s,d,interval};
  }
  const t=Math.max(1,daysBetween(cardState.rev,todayStr()));
  const r=fsrsR(t,cardState.s);
  let s,d;
  if(grade===1){
    s=fsrsSFail(cardState.d,cardState.s,r);
    d=Math.max(1,Math.min(10,cardState.d-FSRS_W[6]*(1-3)*((10-cardState.d)/9)));
  } else {
    s=fsrsSSuccess(cardState.d,cardState.s,r,grade);
    d=fsrsDNext(cardState.d,grade);
  }
  return {s,d,interval:grade===1?1:fsrsInterval(s)};
}

// Format interval as human-readable string
function fmtInterval(days){
  if(days<=1) return '1 day';
  if(days<7)  return days+' days';
  if(days<30) return Math.round(days/7)+'w';
  if(days<365)return Math.round(days/30)+'mo';
  return Math.round(days/365)+'yr';
}

// â”€â”€â”€ FSRS Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadFsrs(){ try{return JSON.parse(localStorage.getItem(FSRS_KEY)||'{}')}catch(e){return{}} }
function saveFsrs(st){ localStorage.setItem(FSRS_KEY,JSON.stringify(st)); }

// â”€â”€â”€ Supabase sync (non-blocking â€” localStorage stays the source of truth) â”€â”€â”€â”€
let _sbUser = null;   // cached user, set on load
let _sbSessionId = null;

async function sbSyncInit() {
  if (!window._sb) return;
  try {
    _sbUser = await sbGetUser();
    if (!_sbUser) return;

    // Pull all card states from Supabase and merge into localStorage
    const { data, error } = await window._sb
      .from('card_states')
      .select('character,stability,difficulty,due_date,last_review')
      .eq('user_id', _sbUser.id);

    if (error || !data?.length) return;

    const local = loadFsrs();
    let changed = false;
    for (const row of data) {
      const loc = local[row.character];
      // Supabase wins if local has no entry OR Supabase review is more recent
      if (!loc || (row.last_review && row.last_review > (loc.rev || ''))) {
        local[row.character] = { s: row.stability, d: row.difficulty, due: row.due_date, rev: row.last_review };
        changed = true;
      }
    }
    if (changed) saveFsrs(local);
  } catch (e) { console.warn('[sb] sync init error:', e); }
}

function sbSyncCard(char, state) {
  if (!window._sb || !_sbUser) return;
  window._sb.from('card_states').upsert({
    user_id:     _sbUser.id,
    character:   char,
    stability:   state.s,
    difficulty:  state.d,
    due_date:    state.due,
    last_review: state.rev,
  }, { onConflict: 'user_id,character' }).then(({ error }) => {
    if (error) console.warn('[sb] card sync error:', error.message);
  });
}

async function sbStartSession(level) {
  if (!window._sb || !_sbUser) return;
  try {
    const { data, error } = await window._sb.from('study_sessions')
      .insert({ user_id: _sbUser.id, level, started_at: new Date().toISOString() })
      .select('id').single();
    if (!error && data) _sbSessionId = data.id;
  } catch(e) {}
}

async function sbEndSession(cardsReviewed, cardsCorrect, newCards, durationSecs) {
  if (!window._sb || !_sbUser || !_sbSessionId) return;
  try {
    await window._sb.from('study_sessions').update({
      ended_at:       new Date().toISOString(),
      cards_reviewed: cardsReviewed,
      cards_correct:  cardsCorrect,
      new_cards:      newCards,
      duration_secs:  durationSecs,
    }).eq('id', _sbSessionId);
    _sbSessionId = null;
  } catch(e) {}
}

// â”€â”€â”€ Date Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr(){ return new Date().toISOString().slice(0,10); }
function addDays(s,n){ const d=new Date(s+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function daysBetween(a,b){ return Math.round((new Date(b+'T00:00:00')-new Date(a+'T00:00:00'))/86400000); }

// â”€â”€â”€ Daily Target â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAILY_TARGET_DEFAULT = 20;
let dailyTarget = DAILY_TARGET_DEFAULT;
let dailyDone   = 0;          // cards completed today (correct only = good + perfect)
let targetNotified = false;   // only fire the toast once per session

function initDailyBar(target) {
  dailyTarget = target || DAILY_TARGET_DEFAULT;
  // Draw milestone ticks at 25%, 50%, 75%
  const ticks = document.getElementById('dailyBarTicks');
  ticks.innerHTML = [25, 50, 75].map(p =>
    `<div class="daily-bar-tick" style="left:${p}%"></div>`
  ).join('');
  updateDailyBar();
}

function updateDailyBar() {
  const pct  = Math.min(100, (dailyDone / dailyTarget) * 100);
  const fill = document.getElementById('dailyBarFill');
  const lbl  = document.getElementById('dailyBarCount');
  const done = pct >= 100;

  fill.style.width = pct + '%';
  fill.classList.toggle('complete', done);
  lbl.classList.toggle('complete', done);
  lbl.textContent = `${dailyDone} / ${dailyTarget} cards${done ? ' âœ“' : ''}`;

  if (done && !targetNotified) {
    targetNotified = true;
    setTimeout(showToast, 400);   // slight delay so bar animation finishes first
  }
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;

function showToast() {
  const el = document.getElementById('toast');
  el.classList.add('show');
  launchConfetti();
  clearTimeout(toastTimer);
  toastTimer = setTimeout(dismissToast, 6000);
}

function dismissToast() {
  document.getElementById('toast').classList.remove('show');
  clearTimeout(toastTimer);
}

// â”€â”€â”€ Confetti burst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchConfetti() {
  const canvas = document.getElementById('confettiCanvas');
  const ctx    = canvas.getContext('2d');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;

  const COLOURS = ['#8b6914','#c4a035','#2d7a4f','#4aaa76','#8b1a1a','#f0ebe0','#1a3a5c'];
  const pieces  = Array.from({ length: 90 }, () => ({
    x:   Math.random() * canvas.width,
    y:   Math.random() * canvas.height * 0.4 - canvas.height * 0.2,
    r:   4 + Math.random() * 5,
    d:   1.5 + Math.random() * 2.5,
    c:   COLOURS[Math.floor(Math.random() * COLOURS.length)],
    t:   Math.random() * Math.PI * 2,
    s:   (Math.random() - 0.5) * 3,
    rot: Math.random() * Math.PI,
    rsp: (Math.random() - 0.5) * 0.1,
  }));

  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.globalAlpha = Math.max(0, 1 - frame / 140);
      ctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r * 0.5);
      ctx.restore();
      p.y   += p.d;
      p.x   += p.s;
      p.rot += p.rsp;
      p.t   += 0.05;
    });
    frame++;
    if (frame < 150) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

// â”€â”€â”€ Session Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sessionId=null, sessionStart=null, levelBreakdown={};

async function startSession(){
  sessionStart = Date.now();
  levelBreakdown = {};
  cardsCorrect = 0;
  sbStartSession(currentLevel);  // non-blocking Supabase session
}

async function endSession(){
  if(!sessionStart) return;
  const duration = Math.round((Date.now() - sessionStart) / 1000);
  sbEndSession(reviewed, cardsCorrect, sessionNewSet?.size || 0, duration);  // non-blocking
  sessionId=null; sessionStart=null;
}

// End session on page close
window.addEventListener('beforeunload', () => {
  if(sessionStart && reviewed > 0) {
    const duration = Math.round((Date.now()-sessionStart)/1000);
    sbEndSession(reviewed, cardsCorrect, sessionNewSet?.size || 0, duration);
  }
});

// â”€â”€ calcStreak: count consecutive daily study days â”€â”€
function calcStreak(prog){
  if(!prog||!prog.lastStudyDate) return 0;
  const today=new Date().toISOString().split('T')[0];
  const last=prog.lastStudyDate;
  if(last===today) return prog.streak||1;
  const diff=(new Date(today)-new Date(last))/(1000*60*60*24);
  return diff<=1 ? (prog.streak||1) : 0;
}

// â”€â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ Vocab loading (lazy by level) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Loads only the active level first so first cards appear in <1s,
// then streams remaining levels silently in the background.
const vocabCache = {};   // level â†’ words array, keyed 1-6 or 'all'
const examplesCache = {}; // simplified character â†’ {zh, py, en}

// â”€â”€ Inline vocab: HSK1 & HSK2 pre-seeded (zero network fetch for first cards) â”€â”€
(function(){
  const h1=[{"s":"çˆ±","t":"æ„›","p":"Ã i","m":"to love; affection; to be fond of","h":1},{"s":"å…«","t":"å…«","p":"bÄ","m":"eight; 8","h":1},{"s":"çˆ¸çˆ¸","t":"çˆ¸çˆ¸","p":"bÃ  ba","m":"(informal) father; CL:å€‹|ä¸ª; ä½[wÃ¨i]","h":1},{"s":"æ¯å­","t":"æ¯å­","p":"bÄ“i zi","m":"cup; glass; CL:å€‹|ä¸ª","h":1},{"s":"åŒ—äº¬","t":"åŒ—äº¬","p":"BÄ›i jÄ«ng","m":"Beijing; capital of People's Republic of China; Peking","h":1},{"s":"æœ¬","t":"æœ¬","p":"bÄ›n","m":"roots or stems of plants; origin; source","h":1},{"s":"ä¸å®¢æ°”","t":"ä¸å®¢æ°£","p":"bÃ¹ kÃ¨ qi","m":"you're welcome; impolite; rude","h":1},{"s":"ä¸","t":"ä¸","p":"bÃ¹","m":"(negative prefix); not; no","h":1},{"s":"èœ","t":"èœ","p":"cÃ i","m":"dish (type of food); vegetables; vegetable","h":1},{"s":"èŒ¶","t":"èŒ¶","p":"chÃ¡","m":"tea; tea plant; CL:æ¯","h":1},{"s":"åƒ","t":"åƒ","p":"chÄ«","m":"to eat; to consume; to eat at (a cafeteria etc)","h":1},{"s":"å‡ºç§Ÿè½¦","t":"é½£ç§Ÿè»Š","p":"chÅ« zÅ« chÄ“","m":"taxi; (Taiwan) rental car","h":1},{"s":"æ‰“ç”µè¯","t":"æ‰“é›»è©±","p":"dÇŽ diÃ n huÃ ","m":"to make a telephone call","h":1},{"s":"å¤§","t":"å¤§","p":"dÃ ","m":"big; huge; large","h":1},{"s":"çš„","t":"çš„","p":"de","m":"of; ~'s (possessive particle); (used after an attribute)","h":1},{"s":"ç‚¹","t":"é»ž","p":"diÇŽn","m":"point; dot; drop","h":1},{"s":"ç”µè„‘","t":"é›»è…¦","p":"diÃ n nÇŽo","m":"computer; CL:è‡º|å°[tÃ¡i]","h":1},{"s":"ç”µè§†","t":"é›»è¦–","p":"diÃ n shÃ¬","m":"television; TV; CL:è‡º|å°","h":1},{"s":"ç”µå½±","t":"é›»å½±","p":"diÃ n yÇng","m":"movie; film; CL:éƒ¨","h":1},{"s":"ä¸œè¥¿","t":"æ±è¥¿","p":"dÅng xi","m":"thing; stuff; person","h":1},{"s":"éƒ½","t":"éƒ½","p":"dÅu","m":"all; both; entirely","h":1},{"s":"è¯»","t":"è®€","p":"dÃº","m":"to read; to study; reading of word (i.e. pronunciation)","h":1},{"s":"å¯¹ä¸èµ·","t":"å°ä¸èµ·","p":"duÃ¬ bu qÇ","m":"unworthy; to let down; I'm sorry","h":1},{"s":"å¤š","t":"å¤š","p":"duÅ","m":"many; much; a lot of","h":1},{"s":"å¤šå°‘","t":"å¤šå°‘","p":"duÅ shao","m":"how much; how many; which (number)","h":1},{"s":"å„¿å­","t":"å…’å­","p":"Ã©r zi","m":"son","h":1},{"s":"äºŒ","t":"äºŒ","p":"Ã¨r","m":"two; 2; stupid (Beijing dialect)","h":1},{"s":"é¥­é¦†","t":"é£¯é¤¨","p":"fÃ n guÇŽn","m":"restaurant; CL:å®¶[jiÄ]","h":1},{"s":"é£žæœº","t":"é£›æ©Ÿ","p":"fÄ“i jÄ«","m":"airplane; CL:æž¶[jiÃ ]","h":1},{"s":"åˆ†é’Ÿ","t":"åˆ†é¾","p":"fÄ“n zhÅng","m":"minute","h":1},{"s":"é«˜å…´","t":"é«˜èˆˆ","p":"gÄo xÃ¬ng","m":"happy; glad; willing (to do sth)","h":1},{"s":"ä¸ª","t":"å€‹","p":"gÃ¨","m":"variant of å€‹|ä¸ª[gÃ¨]","h":1},{"s":"å·¥ä½œ","t":"å·¥ä½œ","p":"gÅng zuÃ²","m":"to work; (of a machine) to operate; job","h":1},{"s":"ç‹—","t":"ç‹—","p":"gÇ’u","m":"dog; CL:éš»|åª; æ¢|æ¡[tiÃ¡o]","h":1},{"s":"æ±‰è¯­","t":"æ¼¢èªž","p":"HÃ n yÇ”","m":"Chinese language; CL:é–€|é—¨[mÃ©n]","h":1},{"s":"å¥½","t":"å¥½","p":"hÇŽo","m":"good; well; proper","h":1},{"s":"å–","t":"å–","p":"hÄ“","m":"to drink; My goodness!","h":1},{"s":"å’Œ","t":"å’Œ","p":"hÃ©","m":"and; together with; with","h":1},{"s":"å¾ˆ","t":"å¾ˆ","p":"hÄ›n","m":"(adverb of degree); quite; very","h":1},{"s":"åŽé¢","t":"å¾Œéºµ","p":"hÃ²u mian","m":"rear; back; behind","h":1},{"s":"å›ž","t":"è¿´","p":"huÃ­","m":"to curve; to return; to revolve","h":1},{"s":"ä¼š","t":"æœƒ","p":"huÃ¬","m":"can; be possible; be able to","h":1},{"s":"ç«è½¦ç«™","t":"ç«è»Šç«™","p":"huÇ’ chÄ“ zhÃ n","m":"train station","h":1},{"s":"å‡ ","t":"å¹¾","p":"jÇ","m":"how much; how many; several","h":1},{"s":"å®¶","t":"å‚¢","p":"jiÄ","m":"home; family; classifier for families or businesses","h":1},{"s":"å«","t":"å«","p":"jiÃ o","m":"to shout; to call; to order","h":1},{"s":"ä»Šå¤©","t":"ä»Šå¤©","p":"jÄ«n tiÄn","m":"today; at the present; now","h":1},{"s":"ä¹","t":"ä¹","p":"jiÇ”","m":"nine; 9","h":1},{"s":"å¼€","t":"é–‹","p":"kÄi","m":"to open; to start; to turn on","h":1},{"s":"çœ‹","t":"çœ‹","p":"kÃ n","m":"to see; to look at; to read","h":1},{"s":"çœ‹è§","t":"çœ‹è¦‹","p":"kÃ n jiÃ n","m":"to see; to catch sight of","h":1},{"s":"å—","t":"å¡Š","p":"kuÃ i","m":"lump (of earth); chunk; piece","h":1},{"s":"æ¥","t":"ä¾†","p":"lÃ¡i","m":"to come; to arrive; to come round","h":1},{"s":"è€å¸ˆ","t":"è€å¸«","p":"lÇŽo shÄ«","m":"teacher; CL:å€‹|ä¸ª; ä½[wÃ¨i]","h":1},{"s":"äº†","t":"çž­","p":"le","m":"(modal particle intensifying preceding clause); (completed action marker)","h":1},{"s":"å†·","t":"å†·","p":"lÄ›ng","m":"cold","h":1},{"s":"é‡Œ","t":"è£","p":"lÇ","m":"li (Chinese mile); 500 meters (modern); home","h":1},{"s":"é›¶","t":"é›¶","p":"lÃ­ng","m":"zero; nought; zero sign","h":1},{"s":"å…­","t":"å…­","p":"liÃ¹","m":"six; 6","h":1},{"s":"å¦ˆå¦ˆ","t":"åª½åª½","p":"mÄ ma","m":"mama; mommy; mother","h":1},{"s":"å—","t":"å—Ž","p":"ma","m":"(question tag)","h":1},{"s":"ä¹°","t":"è²·","p":"mÇŽi","m":"to buy; to purchase","h":1},{"s":"çŒ«","t":"è²“","p":"mÄo","m":"cat; CL:éš»|åª[zhÄ«]","h":1},{"s":"æ²¡","t":"æ²’","p":"mÃ©i","m":"(negative prefix for verbs); have not; not","h":1},{"s":"æ²¡å…³ç³»","t":"æ²’é—œä¿‚","p":"mÃ©i guÄn xi","m":"it doesn't matter","h":1},{"s":"ç±³é¥­","t":"ç±³é£¯","p":"mÇ fÃ n","m":"(cooked) rice","h":1},{"s":"æ˜Žå¤©","t":"æ˜Žå¤©","p":"mÃ­ng tiÄn","m":"tomorrow","h":1},{"s":"åå­—","t":"åå­—","p":"mÃ­ng zi","m":"name (of a person or thing); CL:å€‹|ä¸ª[gÃ¨]","h":1},{"s":"å“ª","t":"å“ª","p":"nÇŽ","m":"how; which","h":1},{"s":"é‚£","t":"é‚£","p":"nÃ ","m":"that; those; then (in that case)","h":1},{"s":"å‘¢","t":"å‘¢","p":"ne","m":"particle indicating that a previously asked question is to be applied to the preceding word (\"What about ...?\"; \"And ...?\"); particle for inquiring about location (\"Where is ...?\")","h":1},{"s":"èƒ½","t":"èƒ½","p":"nÃ©ng","m":"to be able to; to be capable of; ability","h":1},{"s":"ä½ ","t":"ä½ ","p":"nÇ","m":"you (informal; as opposed to courteous æ‚¨)","h":1},{"s":"å¹´","t":"å¹´","p":"niÃ¡n","m":"year; CL:å€‹|ä¸ª[gÃ¨]","h":1},{"s":"å¥³å„¿","t":"å¥³å…’","p":"nÇš Ã©r","m":"daughter","h":1},{"s":"æœ‹å‹","t":"æœ‹å‹","p":"pÃ©ng you","m":"friend; CL:å€‹|ä¸ª; ä½[wÃ¨i]","h":1},{"s":"æ¼‚äº®","t":"æ¼‚äº®","p":"piÃ o liang","m":"pretty; beautiful","h":1},{"s":"è‹¹æžœ","t":"è˜‹æžœ","p":"pÃ­ng guÇ’","m":"apple; CL:å€‹|ä¸ª; é¡†|é¢—[kÄ“]","h":1},{"s":"ä¸ƒ","t":"ä¸ƒ","p":"qÄ«","m":"seven; 7","h":1},{"s":"é’±","t":"éŒ¢","p":"qiÃ¡n","m":"coin; money; CL:ç­†|ç¬”[bÇ]","h":1},{"s":"å‰é¢","t":"å‰éºµ","p":"qiÃ¡n miÃ n","m":"ahead; in front; preceding","h":1},{"s":"è¯·","t":"è«‹","p":"qÇng","m":"to ask; to invite; please (do sth)","h":1},{"s":"åŽ»","t":"åŽ»","p":"qÃ¹","m":"to go; to go to (a place); to cause to go or send (sb)","h":1},{"s":"çƒ­","t":"ç†±","p":"rÃ¨","m":"to warm up; to heat up; hot (of weather)","h":1},{"s":"äºº","t":"äºº","p":"rÃ©n","m":"man; person; people","h":1},{"s":"è®¤è¯†","t":"èªè­˜","p":"rÃ¨n shi","m":"to know; to recognize; to be familiar with","h":1},{"s":"æ—¥","t":"æ—¥","p":"rÃ¬","m":"sun; day; date","h":1},{"s":"ä¸‰","t":"ä¸‰","p":"sÄn","m":"three; 3","h":1},{"s":"å•†åº—","t":"å•†åº—","p":"shÄng diÃ n","m":"store; shop; CL:å®¶","h":1},{"s":"ä¸Š","t":"ä¸Š","p":"shÃ ng","m":"on top; upon; above","h":1},{"s":"ä¸Šåˆ","t":"ä¸Šåˆ","p":"shÃ ng wÇ”","m":"morning; CL:å€‹|ä¸ª[gÃ¨]","h":1},{"s":"å°‘","t":"å°‘","p":"shÇŽo","m":"few; little; lack","h":1},{"s":"è°","t":"èª°","p":"shÃ©i","m":"who; also pr. [shuÃ­]","h":1},{"s":"ä»€ä¹ˆ","t":"ä»€éº¼","p":"shÃ©n me","m":"what?; who?; something","h":1},{"s":"å","t":"å","p":"shÃ­","m":"ten; 10","h":1},{"s":"æ—¶å€™","t":"æ™‚å€™","p":"shÃ­ hou","m":"time; length of time; moment","h":1},{"s":"æ˜¯","t":"æ˜¯","p":"shÃ¬","m":"is; are; am","h":1},{"s":"ä¹¦","t":"æ›¸","p":"shÅ«","m":"book; letter; CL:æœ¬","h":1},{"s":"æ°´","t":"æ°´","p":"shuÇ","m":"water; river; liquid","h":1},{"s":"æ°´æžœ","t":"æ°´æžœ","p":"shuÇ guÇ’","m":"fruit; CL:å€‹|ä¸ª[gÃ¨]","h":1},{"s":"ç¡è§‰","t":"ç¡è¦º","p":"shuÃ¬ jiÃ o","m":"to go to bed; to sleep","h":1},{"s":"è¯´è¯","t":"èªªè©±","p":"shuÅ huÃ ","m":"to speak; to say; to talk","h":1},{"s":"å››","t":"å››","p":"sÃ¬","m":"four; 4","h":1},{"s":"å²","t":"æ­²","p":"suÃ¬","m":"classifier for years (of age); year; year (of crop harvests)","h":1},{"s":"ä»–","t":"ä»–","p":"tÄ","m":"he or him; (used for either sex when the sex is unknown or unimportant); (used before sb's name for emphasis)","h":1},{"s":"å¥¹","t":"å¥¹","p":"tÄ","m":"she","h":1},{"s":"å¤ª","t":"å¤ª","p":"tÃ i","m":"highest; greatest; too (much)","h":1},{"s":"å¤©æ°”","t":"å¤©æ°£","p":"tiÄn qÃ¬","m":"weather","h":1},{"s":"å¬","t":"è½","p":"tÄ«ng","m":"to listen; to hear; to obey","h":1},{"s":"åŒå­¦","t":"åŒå­¸","p":"tÃ³ng xuÃ©","m":"to study at the same school; fellow student; classmate","h":1},{"s":"å–‚","t":"å–‚","p":"wÃ¨i","m":"to feed","h":1},{"s":"æˆ‘","t":"æˆ‘","p":"wÇ’","m":"I; me; my","h":1},{"s":"æˆ‘ä»¬","t":"æˆ‘å€‘","p":"wÇ’ men","m":"we; us; ourselves","h":1},{"s":"äº”","t":"äº”","p":"wÇ”","m":"five; 5","h":1},{"s":"å–œæ¬¢","t":"å–œæ­¡","p":"xÇ huan","m":"to like; to be fond of","h":1},{"s":"ä¸‹","t":"ä¸‹","p":"xiÃ ","m":"down; downwards; below","h":1},{"s":"ä¸‹åˆ","t":"ä¸‹åˆ","p":"xiÃ  wÇ”","m":"afternoon; CL:å€‹|ä¸ª[gÃ¨]; p.m.","h":1},{"s":"ä¸‹é›¨","t":"ä¸‹é›¨","p":"xiÃ  yÇ”","m":"to rain; rainy","h":1},{"s":"å…ˆç”Ÿ","t":"å…ˆç”Ÿ","p":"xiÄn sheng","m":"teacher; husband; doctor (topolect)","h":1},{"s":"çŽ°åœ¨","t":"ç¾åœ¨","p":"xiÃ n zÃ i","m":"now; at present; at the moment","h":1},{"s":"æƒ³","t":"æƒ³","p":"xiÇŽng","m":"to think; to believe; to suppose","h":1},{"s":"å°","t":"å°","p":"xiÇŽo","m":"small; tiny; few","h":1},{"s":"å°å§","t":"å°å§","p":"xiÇŽo jie","m":"young lady; miss; (slang) prostitute","h":1},{"s":"äº›","t":"äº›","p":"xiÄ“","m":"some; few; several","h":1},{"s":"å†™","t":"å¯«","p":"xiÄ›","m":"to write","h":1},{"s":"è°¢è°¢","t":"è¬è¬","p":"xiÃ¨ xie","m":"to thank; thanks","h":1},{"s":"æ˜ŸæœŸ","t":"æ˜ŸæœŸ","p":"xÄ«ng qÄ«","m":"week; CL:å€‹|ä¸ª[gÃ¨]; day of the week","h":1},{"s":"å­¦ç”Ÿ","t":"å­¸ç”Ÿ","p":"xuÃ© sheng","m":"student; schoolchild","h":1},{"s":"å­¦ä¹ ","t":"å­¸ç¿’","p":"xuÃ© xÃ­","m":"to learn; to study","h":1},{"s":"å­¦æ ¡","t":"å­¸æ ¡","p":"xuÃ© xiÃ o","m":"school; CL:æ‰€[suÇ’]","h":1},{"s":"ä¸€","t":"ä¸€","p":"yÄ«","m":"one; 1; single","h":1},{"s":"è¡£æœ","t":"è¡£æœ","p":"yÄ« fu","m":"clothes; CL:ä»¶; å¥—[tÃ o]","h":1},{"s":"åŒ»ç”Ÿ","t":"é†«ç”Ÿ","p":"yÄ« shÄ“ng","m":"doctor; CL:å€‹|ä¸ª; ä½","h":1},{"s":"åŒ»é™¢","t":"é†«é™¢","p":"yÄ« yuÃ n","m":"hospital; CL:æ‰€; å®¶","h":1},{"s":"æ¤…å­","t":"æ¤…å­","p":"yÇ zi","m":"chair; CL:æŠŠ; å¥—[tÃ o]","h":1},{"s":"æœ‰","t":"æœ‰","p":"yÇ’u","m":"to have; there is; there are","h":1},{"s":"æœˆ","t":"æœˆ","p":"yuÃ¨","m":"moon; month; CL:å€‹|ä¸ª","h":1},{"s":"åœ¨","t":"åœ¨","p":"zÃ i","m":"(located) at; (to be) in; to exist","h":1},{"s":"å†è§","t":"å†è¦‹","p":"zÃ i jiÃ n","m":"goodbye; see you again later","h":1},{"s":"æ€Žä¹ˆ","t":"æ€Žéº¼","p":"zÄ›n me","m":"variant of æ€Žéº¼|æ€Žä¹ˆ[zÄ›n me]","h":1},{"s":"æ€Žä¹ˆæ ·","t":"æ€Žéº¼æ¨£","p":"zÄ›n me yÃ ng","m":"how?; how about?; how was it?","h":1},{"s":"è¿™","t":"é€™","p":"zhÃ¨","m":"this; these; (commonly pr.  before a classifier","h":1},{"s":"ä¸­å›½","t":"ä¸­åœ‹","p":"ZhÅng guÃ³","m":"China; Middle Kingdom","h":1},{"s":"ä¸­åˆ","t":"ä¸­åˆ","p":"zhÅng wÇ”","m":"noon; midday; CL:å€‹|ä¸ª[gÃ¨]","h":1},{"s":"ä½","t":"ä½","p":"zhÃ¹","m":"to live; to dwell; to stay","h":1},{"s":"æ¡Œå­","t":"æ¡Œå­","p":"zhuÅ zi","m":"table; desk; CL:å¼µ|å¼ ","h":1},{"s":"å­—","t":"å­—","p":"zÃ¬","m":"letter; symbol; character","h":1},{"s":"æ˜¨å¤©","t":"æ˜¨å¤©","p":"zuÃ³ tiÄn","m":"yesterday","h":1},{"s":"å","t":"å","p":"zuÃ²","m":"to sit; to take a seat; to take (a bus","h":1},{"s":"åš","t":"åš","p":"zuÃ²","m":"to do; to make; to produce","h":1}];
  const h2=[{"s":"å§","t":"å§","p":"ba","m":"(modal particle indicating suggestion or surmise); ...right?; ...OK?","h":2},{"s":"ç™½","t":"ç™½","p":"bÃ¡i","m":"white; snowy; pure","h":2},{"s":"ç™¾","t":"ç™¾","p":"bÇŽi","m":"hundred; numerous; all kinds of","h":2},{"s":"å¸®åŠ©","t":"å¹«åŠ©","p":"bÄng zhÃ¹","m":"assistance; aid; to help","h":2},{"s":"æŠ¥çº¸","t":"å ±ç´™","p":"bÃ o zhÇ","m":"newspaper; newsprint; CL:ä»½","h":2},{"s":"æ¯”","t":"æ¯”","p":"bÇ","m":"(particle used for comparison and \"-er than\"); to compare; to contrast","h":2},{"s":"åˆ«","t":"å½†","p":"biÃ©","m":"to leave; to depart; to separate","h":2},{"s":"é•¿","t":"é•·","p":"chÃ¡ng","m":"length; long; forever","h":2},{"s":"å”±æ­Œ","t":"å”±æ­Œ","p":"chÃ ng gÄ“","m":"to sing a song","h":2},{"s":"å‡º","t":"é½£","p":"chÅ«","m":"to go out; to come out; to occur","h":2},{"s":"ç©¿","t":"ç©¿","p":"chuÄn","m":"to bore through; to pierce; to perforate","h":2},{"s":"èˆ¹","t":"èˆ¹","p":"chuÃ¡n","m":"a boat; vessel; ship","h":2},{"s":"æ¬¡","t":"æ¬¡","p":"cÃ¬","m":"next in sequence; second; the second (day","h":2},{"s":"ä»Ž","t":"å¾ž","p":"cÃ³ng","m":"from; via; passing through","h":2},{"s":"é”™","t":"éŒ¯","p":"cuÃ²","m":"mistake; wrong; bad","h":2},{"s":"æ‰“ç¯®çƒ","t":"æ‰“ç±ƒçƒ","p":"dÃ¡ lÃ¡n qiÃº","m":"Play basketball","h":2},{"s":"å¤§å®¶","t":"å¤§å‚¢","p":"dÃ  jiÄ","m":"everyone; influential family; great expert","h":2},{"s":"ä½†æ˜¯","t":"ä½†æ˜¯","p":"dÃ n shÃ¬","m":"but; however","h":2},{"s":"åˆ°","t":"åˆ°","p":"dÃ o","m":"to (a place); until (a time); up to","h":2},{"s":"å¾—","t":"å¾—","p":"de","m":"structural particle: used after a verb (or adjective as main verb); linking it to following phrase indicating effect; degree","h":2},{"s":"å¾—","t":"å¾—","p":"dÄ›i","m":"to have to; must; ought to","h":2},{"s":"å¼Ÿå¼Ÿ","t":"å¼Ÿå¼Ÿ","p":"dÃ¬ di","m":"younger brother; CL:å€‹|ä¸ª; ä½[wÃ¨i]","h":2},{"s":"ç¬¬ä¸€","t":"ç¬¬ä¸€","p":"dÃ¬ yÄ«","m":"first; number one","h":2},{"s":"æ‡‚","t":"æ‡‚","p":"dÇ’ng","m":"to understand; to know","h":2},{"s":"æˆ¿é—´","t":"æˆ¿é–“","p":"fÃ¡ng jiÄn","m":"room; CL:é–“|é—´[jiÄn]","h":2},{"s":"éžå¸¸","t":"éžå¸¸","p":"fÄ“i chÃ¡ng","m":"unusual; extraordinary; extreme","h":2},{"s":"æœåŠ¡å‘˜","t":"æœå‹™å“¡","p":"fÃº wÃ¹ yuÃ¡n","m":"waiter; waitress; attendant","h":2},{"s":"é«˜","t":"é«˜","p":"gÄo","m":"high; tall; above average","h":2},{"s":"å‘Šè¯‰","t":"å‘Šè¨´","p":"gÃ o su","m":"to tell; to inform; to let know","h":2},{"s":"å“¥å“¥","t":"å“¥å“¥","p":"gÄ“ ge","m":"older brother; CL:å€‹|ä¸ª; ä½[wÃ¨i]","h":2},{"s":"ç»™","t":"çµ¦","p":"gÄ›i","m":"to; for; for the benefit of","h":2},{"s":"å…¬å…±æ±½è½¦","t":"å…¬å…±æ±½è»Š","p":"gÅng gÃ²ng qÃ¬ chÄ“","m":"bus; CL:è¼›|è¾†; ç­[bÄn]","h":2},{"s":"å…¬æ–¤","t":"å…¬æ–¤","p":"gÅng jÄ«n","m":"kilogram (kg)","h":2},{"s":"å…¬å¸","t":"å…¬å¸","p":"gÅng sÄ«","m":"(business) company; company; firm","h":2},{"s":"è´µ","t":"è²´","p":"guÃ¬","m":"expensive; noble; your (name)","h":2},{"s":"è¿˜","t":"é‚„","p":"hÃ¡i","m":"still; still in progress; still more","h":2},{"s":"å­©å­","t":"å­©å­","p":"hÃ¡i zi","m":"child","h":2},{"s":"å¥½åƒ","t":"å¥½åƒ","p":"hÇŽo chÄ«","m":"tasty; delicious","h":2},{"s":"å·","t":"è™Ÿ","p":"hÃ o","m":"ordinal number; day of a month; mark","h":2},{"s":"é»‘","t":"é»‘","p":"hÄ“i","m":"black; dark; (loanword) to hack","h":2},{"s":"çº¢","t":"ç´…","p":"hÃ³ng","m":"red; popular; revolutionary","h":2},{"s":"æ¬¢è¿Ž","t":"æ­¡è¿Ž","p":"huÄn yÃ­ng","m":"to welcome; welcome","h":2},{"s":"è¿˜","t":"é‚„","p":"huÃ¡n","m":"to pay back; to return","h":2},{"s":"å›žç­”","t":"è¿´ç­”","p":"huÃ­ dÃ¡","m":"to reply; to answer; the answer","h":2},{"s":"æœºåœº","t":"æ©Ÿå ´","p":"jÄ« chÇŽng","m":"airport; airfield; CL:å®¶","h":2},{"s":"é¸¡è›‹","t":"é›žè›‹","p":"jÄ« dÃ n","m":"(chicken) egg; hen's egg; CL:å€‹|ä¸ª","h":2},{"s":"ä»¶","t":"ä»¶","p":"jiÃ n","m":"item; component; classifier for events","h":2},{"s":"æ•™å®¤","t":"æ•™å®¤","p":"jiÃ o shÃ¬","m":"classroom; CL:é–“|é—´[jiÄn]","h":2},{"s":"å§å§","t":"å§å§","p":"jiÄ› jie","m":"older sister; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"ä»‹ç»","t":"ä»‹ç´¹","p":"jiÃ¨ shÃ o","m":"to introduce (sb to sb); to give a presentation; to present (sb for a job etc)","h":2},{"s":"è¿›","t":"é€²","p":"jÃ¬n","m":"to advance; to enter; to come (or go) into","h":2},{"s":"è¿‘","t":"è¿‘","p":"jÃ¬n","m":"near; close to; approximately","h":2},{"s":"å°±","t":"å°±","p":"jiÃ¹","m":"at once; right away; only","h":2},{"s":"è§‰å¾—","t":"è¦ºå¾—","p":"juÃ© de","m":"to think; to feel","h":2},{"s":"å’–å•¡","t":"å’–å•¡","p":"kÄ fÄ“i","m":"coffee; CL:æ¯[bÄ“i]","h":2},{"s":"å¼€å§‹","t":"é–‹å§‹","p":"kÄi shÇ","m":"to begin; beginning; to start","h":2},{"s":"è€ƒè¯•","t":"è€ƒè©¦","p":"kÇŽo shÃ¬","m":"to take an exam; exam; CL:æ¬¡[cÃ¬]","h":2},{"s":"å¯èƒ½","t":"å¯èƒ½","p":"kÄ› nÃ©ng","m":"might (happen); possible; probable","h":2},{"s":"å¯ä»¥","t":"å¯ä»¥","p":"kÄ› yÇ","m":"can; may; possible","h":2},{"s":"è¯¾","t":"èª²","p":"kÃ¨","m":"subject; course; CL: é–€|é—¨[mÃ©n]","h":2},{"s":"å¿«","t":"å¿«","p":"kuÃ i","m":"rapid; quick; speed","h":2},{"s":"å¿«ä¹","t":"å¿«æ¨‚","p":"kuÃ i lÃ¨","m":"happy; merry","h":2},{"s":"ç´¯","t":"çº","p":"lÃ¨i","m":"tired; weary; to strain","h":2},{"s":"ç¦»","t":"é›¢","p":"lÃ­","m":"to leave; to part from; to be away from","h":2},{"s":"ä¸¤","t":"å…©","p":"liÇŽng","m":"both; two; ounce","h":2},{"s":"è·¯","t":"è·¯","p":"lÃ¹","m":"road; CL:æ¢|æ¡[tiÃ¡o]; journey","h":2},{"s":"æ—…æ¸¸","t":"æ—…éŠ","p":"lÇš yÃ³u","m":"trip; journey; tourism","h":2},{"s":"å–","t":"è³£","p":"mÃ i","m":"to sell; to betray; to spare no effort","h":2},{"s":"æ…¢","t":"æ…¢","p":"mÃ n","m":"slow","h":2},{"s":"å¿™","t":"å¿™","p":"mÃ¡ng","m":"busy; hurriedly; to hurry","h":2},{"s":"æ¯","t":"æ¯","p":"mÄ›i","m":"each; every","h":2},{"s":"å¦¹å¦¹","t":"å¦¹å¦¹","p":"mÃ¨i mei","m":"younger sister; fig. younger woman (esp. girl friend or rival); CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"é—¨","t":"é–€","p":"mÃ©n","m":"gate; door; CL:æ‰‡[shÃ n]","h":2},{"s":"ç”·äºº","t":"ç”·äºº","p":"nÃ¡n rÃ©n","m":"a man; a male; men","h":2},{"s":"æ‚¨","t":"æ‚¨","p":"nÃ­n","m":"you (courteous; as opposed to informal ä½ )","h":2},{"s":"ç‰›å¥¶","t":"ç‰›å¥¶","p":"niÃº nÇŽi","m":"cow's milk; CL:ç“¶; æ¯[bÄ“i]","h":2},{"s":"å¥³äºº","t":"å¥³äºº","p":"nÇš rÃ©n","m":"woman","h":2},{"s":"æ—è¾¹","t":"æ—é‚Š","p":"pÃ¡ng biÄn","m":"lateral; side; to the side","h":2},{"s":"è·‘æ­¥","t":"è·‘æ­¥","p":"pÇŽo bÃ¹","m":"to walk quickly; to march; to run","h":2},{"s":"ä¾¿å®œ","t":"ä¾¿å®œ","p":"piÃ¡n yi","m":"small advantages; to let sb off lightly; cheap","h":2},{"s":"ç¥¨","t":"ç¥¨","p":"piÃ o","m":"ticket; ballot; bank note","h":2},{"s":"å¦»å­","t":"å¦»å­","p":"qÄ« zi","m":"wife; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"èµ·åºŠ","t":"èµ·åºŠ","p":"qÇ chuÃ¡ng","m":"to get out of bed; to get up","h":2},{"s":"åƒ","t":"éŸ†","p":"qiÄn","m":"a swing","h":2},{"s":"æ™´","t":"æ™´","p":"qÃ­ng","m":"clear; fine (weather)","h":2},{"s":"åŽ»å¹´","t":"åŽ»å¹´","p":"qÃ¹ niÃ¡n","m":"last year","h":2},{"s":"è®©","t":"è®“","p":"rÃ ng","m":"to yield; to permit; to let sb do sth","h":2},{"s":"ä¸Šç­","t":"ä¸Šç­","p":"shÃ ng bÄn","m":"to go to work; to be on duty; to start work","h":2},{"s":"èº«ä½“","t":"èº«é«”","p":"shÄ“n tÇ","m":"(human) body; health; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"ç”Ÿç—…","t":"ç”Ÿç—…","p":"shÄ“ng bÃ¬ng","m":"to fall ill","h":2},{"s":"ç”Ÿæ—¥","t":"ç”Ÿæ—¥","p":"shÄ“ng rÃ¬","m":"birthday; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"æ—¶é—´","t":"æ™‚é–“","p":"shÃ­ jiÄn","m":"time; period; CL:æ®µ[duÃ n]","h":2},{"s":"äº‹æƒ…","t":"äº‹æƒ…","p":"shÃ¬ qing","m":"affair; matter; thing","h":2},{"s":"æ‰‹è¡¨","t":"æ‰‹éŒ¶","p":"shÇ’u biÇŽo","m":"wrist watch; CL:å¡Š|å—; éš»|åª","h":2},{"s":"æ‰‹æœº","t":"æ‰‹æ©Ÿ","p":"shÇ’u jÄ«","m":"cell phone; mobile phone; CL:éƒ¨","h":2},{"s":"é€","t":"é€","p":"sÃ²ng","m":"to deliver; to carry; to give (as a present)","h":2},{"s":"æ‰€ä»¥","t":"æ‰€ä»¥","p":"suÇ’ yÇ","m":"therefore; as a result; so","h":2},{"s":"å®ƒ","t":"å®ƒ","p":"tÄ","m":"it","h":2},{"s":"è¸¢","t":"è¸¢","p":"tÄ«","m":"to kick; to play (e.g. soccer)","h":2},{"s":"é¢˜","t":"é¡Œ","p":"tÃ­","m":"topic; problem for discussion; exam question","h":2},{"s":"è·³èˆž","t":"è·³èˆž","p":"tiÃ o wÇ”","m":"to dance","h":2},{"s":"å¤–","t":"å¤–","p":"wÃ i","m":"outside; in addition; foreign","h":2},{"s":"å®Œ","t":"å®Œ","p":"wÃ¡n","m":"to finish; to be over; whole","h":2},{"s":"çŽ©","t":"çŽ©","p":"wÃ¡n","m":"toy; sth used for amusement; curio or antique (Taiwan pr. )","h":2},{"s":"æ™šä¸Š","t":"æ™šä¸Š","p":"wÇŽn shang","m":"evening; night; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"ä¸º","t":"ç‚º","p":"wÃ¨i","m":"variant of ç‚º|ä¸º; because of; for","h":2},{"s":"é—®","t":"å•","p":"wÃ¨n","m":"to ask","h":2},{"s":"é—®é¢˜","t":"å•é¡Œ","p":"wÃ¨n tÃ­","m":"question; problem; issue","h":2},{"s":"è¥¿ç“œ","t":"è¥¿ç“œ","p":"xÄ« guÄ","m":"watermelon; CL:æ¢|æ¡[tiÃ¡o]","h":2},{"s":"å¸Œæœ›","t":"å¸Œæœ›","p":"xÄ« wÃ ng","m":"to wish for; to desire; hope CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"æ´—","t":"æ´—","p":"xÇ","m":"to wash; to bathe; to develop (photo)","h":2},{"s":"å‘","t":"åš®","p":"xiÃ ng","m":"towards; to face; to turn towards","h":2},{"s":"å°æ—¶","t":"å°æ™‚","p":"xiÇŽo shÃ­","m":"hour; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"ç¬‘","t":"ç¬‘","p":"xiÃ o","m":"laugh; smile; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"æ–°","t":"æ–°","p":"xÄ«n","m":"new; newly; meso- (chemistry)","h":2},{"s":"å§“","t":"å§“","p":"xÃ¬ng","m":"family name; surname; name","h":2},{"s":"ä¼‘æ¯","t":"ä¼‘æ¯","p":"xiÅ« xi","m":"rest; to rest","h":2},{"s":"é›ª","t":"é›ª","p":"xuÄ›","m":"snow; snowfall; CL:å ´|åœº[chÃ¡ng]","h":2},{"s":"é¢œè‰²","t":"é¡”è‰²","p":"yÃ¡n sÃ¨","m":"color; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"çœ¼ç›","t":"çœ¼ç›","p":"yÇŽn jing","m":"eye; CL:éš»|åª; é›™|åŒ[shuÄng]","h":2},{"s":"ç¾Šè‚‰","t":"ç¾Šè‚‰","p":"yÃ¡ng rÃ²u","m":"mutton","h":2},{"s":"è¯","t":"è—¥","p":"yÃ o","m":"medicine; drug; cure","h":2},{"s":"è¦","t":"è¦","p":"yÃ o","m":"important; vital; to want","h":2},{"s":"ä¹Ÿ","t":"ä¹Ÿ","p":"yÄ›","m":"also; too; (in Classical Chinese) final particle implying affirmation","h":2},{"s":"å·²ç»","t":"å·²ç¶“","p":"yÇ jÄ«ng","m":"already","h":2},{"s":"ä¸€èµ·","t":"ä¸€èµ·","p":"yÄ« qÇ","m":"in the same place; together; with","h":2},{"s":"æ„æ€","t":"æ„æ€","p":"yÃ¬ si","m":"idea; opinion; meaning","h":2},{"s":"é˜´","t":"é™°","p":"yÄ«n","m":"overcast (weather); cloudy; shady","h":2},{"s":"å› ä¸º","t":"å› ç‚º","p":"yÄ«n wÃ¨i","m":"because; owing to; on account of","h":2},{"s":"æ¸¸æ³³","t":"éŠæ³³","p":"yÃ³u yÇ’ng","m":"swimming; to swim","h":2},{"s":"å³è¾¹","t":"å³é‚Š","p":"yÃ²u bian","m":"right side; right; to the right","h":2},{"s":"é±¼","t":"é­š","p":"yÃº","m":"fish; CL:æ¢|æ¡; å°¾[wÄ›i]","h":2},{"s":"å…ƒ","t":"å…ƒ","p":"yuÃ¡n","m":"Chinese monetary unit; dollar; primary","h":2},{"s":"è¿œ","t":"é ","p":"yuÇŽn","m":"far; distant; remote","h":2},{"s":"è¿åŠ¨","t":"é‹å‹•","p":"yÃ¹n dÃ²ng","m":"to move; to exercise; sports","h":2},{"s":"å†","t":"å†","p":"zÃ i","m":"again; once more; re-","h":2},{"s":"æ—©ä¸Š","t":"æ—©ä¸Š","p":"zÇŽo shang","m":"early morning; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"å¼ ","t":"å¼µ","p":"zhÄng","m":"to open up; to spread; sheet of paper","h":2},{"s":"é•¿","t":"é•·","p":"zhÇŽng","m":"chief; head; elder","h":2},{"s":"ä¸ˆå¤«","t":"ä¸ˆå¤«","p":"zhÃ ng fu","m":"husband; CL:å€‹|ä¸ª[gÃ¨]","h":2},{"s":"æ‰¾","t":"æ‰¾","p":"zhÇŽo","m":"to try to find; to look for; to call on sb","h":2},{"s":"ç€","t":"è‘—","p":"zhe","m":"aspect particle indicating action in progress","h":2},{"s":"çœŸ","t":"çœŸ","p":"zhÄ“n","m":"really; truly; indeed","h":2},{"s":"æ­£åœ¨","t":"æ­£åœ¨","p":"zhÃ¨ng zÃ i","m":"in the process of (doing something or happening); while (doing)","h":2},{"s":"çŸ¥é“","t":"çŸ¥é“","p":"zhÄ« dÃ o","m":"to know; to be aware of; also pron. [zhÄ« dao]","h":2},{"s":"å‡†å¤‡","t":"æº–å‚™","p":"zhÇ”n bÃ¨i","m":"preparation; to prepare; to intend","h":2},{"s":"è‡ªè¡Œè½¦","t":"è‡ªè¡Œè»Š","p":"zÃ¬ xÃ­ng chÄ“","m":"bicycle; bike; CL:è¼›|è¾†[liÃ ng]","h":2},{"s":"èµ°","t":"èµ°","p":"zÇ’u","m":"to walk; to go; to run","h":2},{"s":"æœ€","t":"æœ€","p":"zuÃ¬","m":"most; the most; -est (superlative suffix)","h":2},{"s":"å·¦è¾¹","t":"å·¦é‚Š","p":"zuÇ’ bian","m":"left; the left side; to the left of","h":2}];
  vocabCache[1]=h1; vocabCache[2]=h2;
  vocabCache['all']=[...h1,...h2];
  // HSK1 examples pre-seeded
  Object.assign(examplesCache,{"çˆ±":{"zh":"æˆ‘çˆ±æˆ‘çš„å®¶äººã€‚","py":"WÇ’ Ã i wÇ’ de jiÄrÃ©n.","en":"I love my family."},"å…«":{"zh":"æˆ‘æœ‰å…«æœ¬ä¹¦ã€‚","py":"WÇ’ yÇ’u bÄ bÄ›n shÅ«.","en":"I have eight books."},"çˆ¸çˆ¸":{"zh":"æˆ‘çˆ¸çˆ¸åœ¨å®¶é‡Œã€‚","py":"WÇ’ bÃ ba zÃ i jiÄlÇ.","en":"My dad is at home."},"æ¯å­":{"zh":"è¿™ä¸ªæ¯å­æ˜¯æˆ‘çš„ã€‚","py":"ZhÃ¨ge bÄ“izi shÃ¬ wÇ’ de.","en":"This cup is mine."},"åŒ—äº¬":{"zh":"æˆ‘æƒ³åŽ»åŒ—äº¬ã€‚","py":"WÇ’ xiÇŽng qÃ¹ BÄ›ijÄ«ng.","en":"I want to go to Beijing."},"æœ¬":{"zh":"è¿™æœ¬ä¹¦å¾ˆå¥½çœ‹ã€‚","py":"ZhÃ¨ bÄ›n shÅ« hÄ›n hÇŽokÃ n.","en":"This book is very interesting."},"ä¸å®¢æ°”":{"zh":"è°¢è°¢ä½ ï¼ä¸å®¢æ°”ã€‚","py":"XiÃ¨xie nÇ! BÃ¹ kÃ¨qi.","en":"Thank you! You're welcome."},"ä¸":{"zh":"æˆ‘ä¸å–èŒ¶ã€‚","py":"WÇ’ bÃ¹ hÄ“ chÃ¡.","en":"I don't drink tea."},"èœ":{"zh":"è¿™ä¸ªèœå¾ˆå¥½åƒã€‚","py":"ZhÃ¨ge cÃ i hÄ›n hÇŽochÄ«.","en":"This dish is delicious."},"èŒ¶":{"zh":"ä½ å–èŒ¶å—ï¼Ÿ","py":"NÇ hÄ“ chÃ¡ ma?","en":"Do you drink tea?"},"åƒ":{"zh":"æˆ‘ä»¬åŽ»åƒé¥­å§ã€‚","py":"WÇ’men qÃ¹ chÄ«fÃ n ba.","en":"Let's go eat."},"å‡ºç§Ÿè½¦":{"zh":"æˆ‘åå‡ºç§Ÿè½¦æ¥çš„ã€‚","py":"WÇ’ zuÃ² chÅ«zÅ«chÄ“ lÃ¡i de.","en":"I came by taxi."},"æ‰“ç”µè¯":{"zh":"æˆ‘ç»™ä»–æ‰“ç”µè¯ã€‚","py":"WÇ’ gÄ›i tÄ dÇŽ diÃ nhuÃ .","en":"I'll call him."},"å¤§":{"zh":"è¿™ä¸ªæˆ¿é—´å¾ˆå¤§ã€‚","py":"ZhÃ¨ge fÃ¡ngjiÄn hÄ›n dÃ .","en":"This room is very big."},"çš„":{"zh":"è¿™æ˜¯æˆ‘çš„ç”µè„‘ã€‚","py":"ZhÃ¨ shÃ¬ wÇ’ de diÃ nnÇŽo.","en":"This is my computer."},"ç‚¹":{"zh":"çŽ°åœ¨ä¸‰ç‚¹äº†ã€‚","py":"XiÃ nzÃ i sÄn diÇŽn le.","en":"It's three o'clock now."},"ç”µè„‘":{"zh":"æˆ‘çš„ç”µè„‘å¾ˆå¿«ã€‚","py":"WÇ’ de diÃ nnÇŽo hÄ›n kuÃ i.","en":"My computer is very fast."},"ç”µè§†":{"zh":"ä»–åœ¨çœ‹ç”µè§†ã€‚","py":"TÄ zÃ i kÃ n diÃ nshÃ¬.","en":"He is watching TV."},"ç”µå½±":{"zh":"æˆ‘ä»¬åŽ»çœ‹ç”µå½±å§ã€‚","py":"WÇ’men qÃ¹ kÃ n diÃ nyÇng ba.","en":"Let's go watch a movie."},"ä¸œè¥¿":{"zh":"ä½ ä¹°ä»€ä¹ˆä¸œè¥¿ï¼Ÿ","py":"NÇ mÇŽi shÃ©nme dÅngxi?","en":"What are you buying?"},"éƒ½":{"zh":"æˆ‘ä»¬éƒ½æ˜¯å­¦ç”Ÿã€‚","py":"WÇ’men dÅu shÃ¬ xuÃ©sheng.","en":"We are all students."},"è¯»":{"zh":"ä»–åœ¨è¯»ä¹¦ã€‚","py":"TÄ zÃ i dÃº shÅ«.","en":"He is reading a book."},"å¯¹ä¸èµ·":{"zh":"å¯¹ä¸èµ·ï¼Œæˆ‘æ¥æ™šäº†ã€‚","py":"DuÃ¬buqÇ, wÇ’ lÃ¡i wÇŽn le.","en":"Sorry, I'm late."},"å¤š":{"zh":"è¿™é‡Œçš„äººå¾ˆå¤šã€‚","py":"ZhÃ¨lÇ de rÃ©n hÄ›n duÅ.","en":"There are a lot of people here."},"å¤šå°‘":{"zh":"è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ","py":"ZhÃ¨ge duÅshao qiÃ¡n?","en":"How much does this cost?"},"å„¿å­":{"zh":"ä»–æœ‰ä¸€ä¸ªå„¿å­ã€‚","py":"TÄ yÇ’u yÄ«gÃ¨ Ã©rzi.","en":"He has a son."},"äºŒ":{"zh":"æˆ‘æœ‰ä¸¤ä¸ªå§å§ã€‚","py":"WÇ’ yÇ’u liÇŽng gÃ¨ jiÄ›jie.","en":"I have two older sisters."},"é¥­é¦†":{"zh":"è¿™å®¶é¥­é¦†å¾ˆå¥½ã€‚","py":"ZhÃ¨ jiÄ fÃ nguÇŽn hÄ›n hÇŽo.","en":"This restaurant is great."},"é£žæœº":{"zh":"æˆ‘åé£žæœºåŽ»ä¸Šæµ·ã€‚","py":"WÇ’ zuÃ² fÄ“ijÄ« qÃ¹ ShÃ nghÇŽi.","en":"I'm flying to Shanghai."},"åˆ†é’Ÿ":{"zh":"ç­‰ä¸€ä¸‹ï¼Œäº”åˆ†é’Ÿã€‚","py":"DÄ›ng yÄ«xiÃ , wÇ” fÄ“nzhÅng.","en":"Wait a moment, five minutes."},"é«˜å…´":{"zh":"è§åˆ°ä½ å¾ˆé«˜å…´ã€‚","py":"JiÃ n dÃ o nÇ hÄ›n gÄoxÃ¬ng.","en":"Nice to meet you."},"ä¸ª":{"zh":"æˆ‘è¦ä¸¤ä¸ªè‹¹æžœã€‚","py":"WÇ’ yÃ o liÇŽng gÃ¨ pÃ­ngguÇ’.","en":"I want two apples."},"å·¥ä½œ":{"zh":"å¥¹çš„å·¥ä½œå¾ˆå¿™ã€‚","py":"TÄ de gÅngzuÃ² hÄ›n mÃ¡ng.","en":"Her work is very busy."},"ç‹—":{"zh":"æˆ‘æœ‰ä¸€åªç‹—ã€‚","py":"WÇ’ yÇ’u yÄ« zhÄ« gÇ’u.","en":"I have a dog."},"æ±‰è¯­":{"zh":"æˆ‘åœ¨å­¦æ±‰è¯­ã€‚","py":"WÇ’ zÃ i xuÃ© HÃ nyÇ”.","en":"I'm learning Chinese."},"å¥½":{"zh":"è¿™ä¸ªæ–¹æ³•å¾ˆå¥½ã€‚","py":"ZhÃ¨ge fÄngfÇŽ hÄ›n hÇŽo.","en":"This method is very good."},"å–":{"zh":"ä½ å–ä»€ä¹ˆï¼Ÿ","py":"NÇ hÄ“ shÃ©nme?","en":"What would you like to drink?"},"å’Œ":{"zh":"æˆ‘å’Œä»–æ˜¯æœ‹å‹ã€‚","py":"WÇ’ hÃ© tÄ shÃ¬ pÃ©ngyou.","en":"He and I are friends."},"å¾ˆ":{"zh":"ä»Šå¤©å¾ˆçƒ­ã€‚","py":"JÄ«ntiÄn hÄ›n rÃ¨.","en":"It's very hot today."},"åŽé¢":{"zh":"å•†åº—åœ¨åŽé¢ã€‚","py":"ShÄngdiÃ n zÃ i hÃ²umian.","en":"The shop is at the back."},"å›ž":{"zh":"ä»–å›žå®¶äº†ã€‚","py":"TÄ huÃ­ jiÄ le.","en":"He went home."},"ä¼š":{"zh":"ä½ ä¼šè¯´æ±‰è¯­å—ï¼Ÿ","py":"NÇ huÃ¬ shuÅ HÃ nyÇ” ma?","en":"Can you speak Chinese?"},"ç«è½¦ç«™":{"zh":"ç«è½¦ç«™åœ¨å“ªé‡Œï¼Ÿ","py":"HuÇ’chÄ“zhÃ n zÃ i nÇŽlÇ?","en":"Where is the train station?"},"å‡ ":{"zh":"ä½ å®¶æœ‰å‡ å£äººï¼Ÿ","py":"NÇ jiÄ yÇ’u jÇ kÇ’u rÃ©n?","en":"How many people are in your family?"},"å®¶":{"zh":"æˆ‘ä»¬åœ¨å¥¹å®¶åƒé¥­ã€‚","py":"WÇ’men zÃ i tÄ jiÄ chÄ«fÃ n.","en":"We're eating at her place."},"å«":{"zh":"ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ","py":"NÇ jiÃ o shÃ©nme mÃ­ngzi?","en":"What's your name?"},"ä»Šå¤©":{"zh":"ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚","py":"JÄ«ntiÄn tiÄnqÃ¬ hÄ›n hÇŽo.","en":"The weather is nice today."},"ä¹":{"zh":"å¥¹ä¹å²äº†ã€‚","py":"TÄ jiÇ” suÃ¬ le.","en":"She is nine years old."},"å¼€":{"zh":"è¯·å¼€é—¨ã€‚","py":"QÇng kÄi mÃ©n.","en":"Please open the door."},"çœ‹":{"zh":"æˆ‘çœ‹äº†ä¸€æœ¬ä¹¦ã€‚","py":"WÇ’ kÃ n le yÄ« bÄ›n shÅ«.","en":"I read a book."},"çœ‹è§":{"zh":"æˆ‘çœ‹è§ä»–äº†ã€‚","py":"WÇ’ kÃ njiÃ n tÄ le.","en":"I saw him."},"å—":{"zh":"è¿™ä¸ªè¦äº”å—é’±ã€‚","py":"ZhÃ¨ge yÃ o wÇ” kuÃ i qiÃ¡n.","en":"This costs five yuan."},"æ¥":{"zh":"å¥¹ä»ŽåŒ—äº¬æ¥ã€‚","py":"TÄ cÃ³ng BÄ›ijÄ«ng lÃ¡i.","en":"She comes from Beijing."},"è€å¸ˆ":{"zh":"å¥¹æ˜¯æˆ‘çš„è€å¸ˆã€‚","py":"TÄ shÃ¬ wÇ’ de lÇŽoshÄ«.","en":"She is my teacher."},"äº†":{"zh":"æˆ‘åƒé¥­äº†ã€‚","py":"WÇ’ chÄ«fÃ n le.","en":"I've already eaten."},"å†·":{"zh":"ä»Šå¤©å¾ˆå†·ã€‚","py":"JÄ«ntiÄn hÄ›n lÄ›ng.","en":"It's very cold today."},"é‡Œ":{"zh":"ä¹¦åœ¨åŒ…é‡Œã€‚","py":"ShÅ« zÃ i bÄo lÇ.","en":"The book is in the bag."},"é›¶":{"zh":"ä»Šå¤©é›¶åº¦ã€‚","py":"JÄ«ntiÄn lÃ­ng dÃ¹.","en":"It's zero degrees today."},"å…­":{"zh":"å¥¹å…­ç‚¹èµ·åºŠã€‚","py":"TÄ liÃ¹ diÇŽn qÇchuÃ¡ng.","en":"She gets up at six."},"å¦ˆå¦ˆ":{"zh":"å¦ˆå¦ˆåœ¨åšé¥­ã€‚","py":"MÄma zÃ i zuÃ²fÃ n.","en":"Mom is cooking."},"å—":{"zh":"ä½ æ˜¯å­¦ç”Ÿå—ï¼Ÿ","py":"NÇ shÃ¬ xuÃ©sheng ma?","en":"Are you a student?"},"ä¹°":{"zh":"æˆ‘åŽ»ä¹°æ°´æžœã€‚","py":"WÇ’ qÃ¹ mÇŽi shuÇguÇ’.","en":"I'm going to buy fruit."},"çŒ«":{"zh":"é‚£åªçŒ«æ˜¯ç™½è‰²çš„ã€‚","py":"NÃ  zhÄ« mÄo shÃ¬ bÃ¡isÃ¨ de.","en":"That cat is white."},"æ²¡":{"zh":"æˆ‘æ²¡æœ‰é’±ã€‚","py":"WÇ’ mÃ©iyÇ’u qiÃ¡n.","en":"I don't have money."},"æ²¡å…³ç³»":{"zh":"å¯¹ä¸èµ·ï¼æ²¡å…³ç³»ã€‚","py":"DuÃ¬buqÇ! MÃ©iguÄnxi.","en":"Sorry! It's fine."},"ç±³é¥­":{"zh":"æˆ‘æƒ³åƒç±³é¥­ã€‚","py":"WÇ’ xiÇŽng chÄ« mÇfÃ n.","en":"I want to eat rice."},"æ˜Žå¤©":{"zh":"æ˜Žå¤©è§ï¼","py":"MÃ­ngtiÄn jiÃ n!","en":"See you tomorrow!"},"åå­—":{"zh":"ä½ çš„åå­—å«ä»€ä¹ˆï¼Ÿ","py":"NÇ de mÃ­ngzi jiÃ o shÃ©nme?","en":"What is your name?"},"å“ª":{"zh":"ä½ æ˜¯å“ªå›½äººï¼Ÿ","py":"NÇ shÃ¬ nÇŽ guÃ³ rÃ©n?","en":"What country are you from?"},"é‚£":{"zh":"é‚£æœ¬ä¹¦æ˜¯æˆ‘çš„ã€‚","py":"NÃ  bÄ›n shÅ« shÃ¬ wÇ’ de.","en":"That book is mine."},"å‘¢":{"zh":"æˆ‘å¾ˆå¥½ï¼Œä½ å‘¢ï¼Ÿ","py":"WÇ’ hÄ›n hÇŽo, nÇ ne?","en":"I'm fine, and you?"},"èƒ½":{"zh":"æˆ‘èƒ½å¸®ä½ å—ï¼Ÿ","py":"WÇ’ nÃ©ng bÄng nÇ ma?","en":"Can I help you?"},"ä½ ":{"zh":"ä½ å¥½ï¼Œä½ å«ä»€ä¹ˆï¼Ÿ","py":"NÇ hÇŽo, nÇ jiÃ o shÃ©nme?","en":"Hi, what's your name?"},"å¹´":{"zh":"ä»Šå¹´æ˜¯å“ªå¹´ï¼Ÿ","py":"JÄ«nniÃ¡n shÃ¬ nÇŽ niÃ¡n?","en":"What year is it this year?"},"å¥³å„¿":{"zh":"å¥¹æ˜¯æˆ‘çš„å¥³å„¿ã€‚","py":"TÄ shÃ¬ wÇ’ de nÇšÃ©r.","en":"She is my daughter."},"æœ‹å‹":{"zh":"ä»–æ˜¯æˆ‘çš„å¥½æœ‹å‹ã€‚","py":"TÄ shÃ¬ wÇ’ de hÇŽo pÃ©ngyou.","en":"He is my good friend."},"æ¼‚äº®":{"zh":"å¥¹å¾ˆæ¼‚äº®ã€‚","py":"TÄ hÄ›n piÃ oliang.","en":"She is very pretty."},"è‹¹æžœ":{"zh":"æˆ‘å–œæ¬¢åƒè‹¹æžœã€‚","py":"WÇ’ xÇhuan chÄ« pÃ­ngguÇ’.","en":"I like eating apples."},"ä¸ƒ":{"zh":"æˆ‘ä¸ƒç‚¹èµ·åºŠã€‚","py":"WÇ’ qÄ« diÇŽn qÇchuÃ¡ng.","en":"I get up at seven."},"é’±":{"zh":"ä½ æœ‰å¤šå°‘é’±ï¼Ÿ","py":"NÇ yÇ’u duÅshao qiÃ¡n?","en":"How much money do you have?"},"å‰é¢":{"zh":"å­¦æ ¡åœ¨å‰é¢ã€‚","py":"XuÃ©xiÃ o zÃ i qiÃ¡nmiÃ n.","en":"The school is ahead."},"è¯·":{"zh":"è¯·è¿›ï¼","py":"QÇng jÃ¬n!","en":"Please come in!"},"åŽ»":{"zh":"æˆ‘è¦åŽ»å›¾ä¹¦é¦†ã€‚","py":"WÇ’ yÃ o qÃ¹ tÃºshÅ«guÇŽn.","en":"I'm going to the library."},"çƒ­":{"zh":"ä»Šå¤©å¾ˆçƒ­ã€‚","py":"JÄ«ntiÄn hÄ›n rÃ¨.","en":"It's very hot today."},"äºº":{"zh":"é‚£ä¸ªäººæ˜¯è°ï¼Ÿ","py":"NÃ gÃ¨ rÃ©n shÃ¬ shÃ©i?","en":"Who is that person?"},"è®¤è¯†":{"zh":"å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚","py":"HÄ›n gÄoxÃ¬ng rÃ¨nshi nÇ.","en":"Nice to meet you."},"æ—¥":{"zh":"ä»Šå¤©æ˜¯å‡ æœˆå‡ æ—¥ï¼Ÿ","py":"JÄ«ntiÄn shÃ¬ jÇ yuÃ¨ jÇ rÃ¬?","en":"What's today's date?"},"ä¸‰":{"zh":"æˆ‘æœ‰ä¸‰ä¸ªæœ‹å‹ã€‚","py":"WÇ’ yÇ’u sÄn gÃ¨ pÃ©ngyou.","en":"I have three friends."},"å•†åº—":{"zh":"å•†åº—å‡ ç‚¹å¼€é—¨ï¼Ÿ","py":"ShÄngdiÃ n jÇ diÇŽn kÄimÃ©n?","en":"When does the shop open?"},"ä¸Š":{"zh":"ä¹¦åœ¨æ¡Œå­ä¸Šã€‚","py":"ShÅ« zÃ i zhuÅzi shÃ ng.","en":"The book is on the table."},"ä¸Šåˆ":{"zh":"æˆ‘ä¸ŠåˆåŽ»åŒ»é™¢ã€‚","py":"WÇ’ shÃ ngwÇ” qÃ¹ yÄ«yuÃ n.","en":"I'm going to the hospital in the morning."},"å°‘":{"zh":"è¿™é‡Œçš„äººå¾ˆå°‘ã€‚","py":"ZhÃ¨lÇ de rÃ©n hÄ›n shÇŽo.","en":"There are few people here."},"è°":{"zh":"é‚£æ˜¯è°ï¼Ÿ","py":"NÃ  shÃ¬ shÃ©i?","en":"Who is that?"},"ä»€ä¹ˆ":{"zh":"ä½ åœ¨æƒ³ä»€ä¹ˆï¼Ÿ","py":"NÇ zÃ i xiÇŽng shÃ©nme?","en":"What are you thinking about?"},"å":{"zh":"æˆ‘ç­‰äº†ååˆ†é’Ÿã€‚","py":"WÇ’ dÄ›ng le shÃ­ fÄ“nzhÅng.","en":"I waited ten minutes."},"æ—¶å€™":{"zh":"ä½ ä»€ä¹ˆæ—¶å€™æ¥ï¼Ÿ","py":"NÇ shÃ©nme shÃ­hou lÃ¡i?","en":"When will you come?"},"æ˜¯":{"zh":"å¥¹æ˜¯æˆ‘çš„è€å¸ˆã€‚","py":"TÄ shÃ¬ wÇ’ de lÇŽoshÄ«.","en":"She is my teacher."},"ä¹¦":{"zh":"è¿™æœ¬ä¹¦å¾ˆæœ‰è¶£ã€‚","py":"ZhÃ¨ bÄ›n shÅ« hÄ›n yÇ’uqÃ¹.","en":"This book is very interesting."},"æ°´":{"zh":"æˆ‘è¦ä¸€æ¯æ°´ã€‚","py":"WÇ’ yÃ o yÄ« bÄ“i shuÇ.","en":"I'd like a glass of water."},"æ°´æžœ":{"zh":"æˆ‘å–œæ¬¢åƒæ°´æžœã€‚","py":"WÇ’ xÇhuan chÄ« shuÇguÇ’.","en":"I like eating fruit."},"ç¡è§‰":{"zh":"ä»–åç‚¹ç¡è§‰ã€‚","py":"TÄ shÃ­ diÇŽn shuÃ¬jiÃ o.","en":"He goes to sleep at ten."},"è¯´è¯":{"zh":"è¯·ä¸è¦è¯´è¯ã€‚","py":"QÇng bÃ¹yÃ o shuÅhuÃ .","en":"Please don't talk."},"å››":{"zh":"æˆ‘å®¶æœ‰å››å£äººã€‚","py":"WÇ’ jiÄ yÇ’u sÃ¬ kÇ’u rÃ©n.","en":"My family has four people."},"å²":{"zh":"ä½ ä»Šå¹´å¤šå°‘å²ï¼Ÿ","py":"NÇ jÄ«nniÃ¡n duÅshao suÃ¬?","en":"How old are you this year?"},"ä»–":{"zh":"ä»–æ˜¯æˆ‘çš„åŒå­¦ã€‚","py":"TÄ shÃ¬ wÇ’ de tÃ³ngxuÃ©.","en":"He is my classmate."},"å¥¹":{"zh":"å¥¹å¾ˆæ¼‚äº®ã€‚","py":"TÄ hÄ›n piÃ oliang.","en":"She is very pretty."},"å¤ª":{"zh":"è¿™ä¸ªå¤ªè´µäº†ã€‚","py":"ZhÃ¨ge tÃ i guÃ¬ le.","en":"This is too expensive."},"å¤©æ°”":{"zh":"ä»Šå¤©å¤©æ°”æ€Žä¹ˆæ ·ï¼Ÿ","py":"JÄ«ntiÄn tiÄnqÃ¬ zÄ›nmeyÃ ng?","en":"What's the weather like today?"},"å¬":{"zh":"æˆ‘å–œæ¬¢å¬éŸ³ä¹ã€‚","py":"WÇ’ xÇhuan tÄ«ng yÄ«nyuÃ¨.","en":"I like listening to music."},"åŒå­¦":{"zh":"å¥¹æ˜¯æˆ‘çš„åŒå­¦ã€‚","py":"TÄ shÃ¬ wÇ’ de tÃ³ngxuÃ©.","en":"She is my classmate."},"å–‚":{"zh":"å–‚ï¼Œä½ å¥½ï¼","py":"WÃ¨i, nÇ hÇŽo!","en":"Hello! (on the phone)"},"æˆ‘":{"zh":"æˆ‘æ˜¯ä¸­å›½äººã€‚","py":"WÇ’ shÃ¬ ZhÅngguÃ³ rÃ©n.","en":"I am Chinese."},"æˆ‘ä»¬":{"zh":"æˆ‘ä»¬ä¸€èµ·åŽ»å§ã€‚","py":"WÇ’men yÄ«qÇ qÃ¹ ba.","en":"Let's go together."},"äº”":{"zh":"ä»–äº”å²äº†ã€‚","py":"TÄ wÇ” suÃ¬ le.","en":"He is five years old."},"å–œæ¬¢":{"zh":"æˆ‘å–œæ¬¢å­¦æ±‰è¯­ã€‚","py":"WÇ’ xÇhuan xuÃ© HÃ nyÇ”.","en":"I like learning Chinese."},"ä¸‹":{"zh":"çŒ«åœ¨æ¡Œå­ä¸‹ã€‚","py":"MÄo zÃ i zhuÅzi xiÃ .","en":"The cat is under the table."},"ä¸‹åˆ":{"zh":"ä¸‹åˆæˆ‘æœ‰è¯¾ã€‚","py":"XiÃ wÇ” wÇ’ yÇ’u kÃ¨.","en":"I have class in the afternoon."},"ä¸‹é›¨":{"zh":"ä»Šå¤©ä¸‹é›¨äº†ã€‚","py":"JÄ«ntiÄn xiÃ  yÇ” le.","en":"It's raining today."},"å…ˆç”Ÿ":{"zh":"çŽ‹å…ˆç”Ÿï¼Œä½ å¥½ï¼","py":"WÃ¡ng xiÄnsheng, nÇ hÇŽo!","en":"Hello, Mr. Wang!"},"çŽ°åœ¨":{"zh":"çŽ°åœ¨å‡ ç‚¹äº†ï¼Ÿ","py":"XiÃ nzÃ i jÇ diÇŽn le?","en":"What time is it now?"},"æƒ³":{"zh":"æˆ‘æƒ³åŽ»åŒ—äº¬ã€‚","py":"WÇ’ xiÇŽng qÃ¹ BÄ›ijÄ«ng.","en":"I want to go to Beijing."},"å°":{"zh":"è¿™ä¸ªæˆ¿é—´å¾ˆå°ã€‚","py":"ZhÃ¨ge fÃ¡ngjiÄn hÄ›n xiÇŽo.","en":"This room is very small."},"å°å§":{"zh":"è¿™ä½å°å§ï¼Œè¯·é—®â€¦","py":"ZhÃ¨ wÃ¨i xiÇŽojiÄ›, qÇngwÃ¨nâ€¦","en":"Excuse me, missâ€¦"},"äº›":{"zh":"ä¹°ä¸€äº›è‹¹æžœå§ã€‚","py":"MÇŽi yÄ«xiÄ“ pÃ­ngguÇ’ ba.","en":"Let's buy some apples."},"å†™":{"zh":"è¯·å†™ä½ çš„åå­—ã€‚","py":"QÇng xiÄ› nÇ de mÃ­ngzi.","en":"Please write your name."},"è°¢è°¢":{"zh":"è°¢è°¢ä½ çš„å¸®åŠ©ï¼","py":"XiÃ¨xie nÇ de bÄngzhÃ¹!","en":"Thank you for your help!"},"æ˜ŸæœŸ":{"zh":"ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ","py":"JÄ«ntiÄn xÄ«ngqÄ« jÇ?","en":"What day of the week is it?"},"å­¦ç”Ÿ":{"zh":"ä»–æ˜¯å¤§å­¦ç”Ÿã€‚","py":"TÄ shÃ¬ dÃ xuÃ©shÄ“ng.","en":"He is a university student."},"å­¦ä¹ ":{"zh":"æˆ‘æ¯å¤©å­¦ä¹ æ±‰è¯­ã€‚","py":"WÇ’ mÄ›itiÄn xuÃ©xÃ­ HÃ nyÇ”.","en":"I study Chinese every day."},"å­¦æ ¡":{"zh":"æˆ‘çš„å­¦æ ¡å¾ˆå¤§ã€‚","py":"WÇ’ de xuÃ©xiÃ o hÄ›n dÃ .","en":"My school is very big."},"ä¸€":{"zh":"æˆ‘åªæœ‰ä¸€ä¸ªé—®é¢˜ã€‚","py":"WÇ’ zhÇ yÇ’u yÄ«gÃ¨ wÃ¨ntÃ­.","en":"I only have one question."},"è¡£æœ":{"zh":"è¿™ä»¶è¡£æœå¾ˆå¥½çœ‹ã€‚","py":"ZhÃ¨ jiÃ n yÄ«fu hÄ›n hÇŽokÃ n.","en":"This piece of clothing looks great."},"åŒ»ç”Ÿ":{"zh":"æˆ‘è¦åŽ»çœ‹åŒ»ç”Ÿã€‚","py":"WÇ’ yÃ o qÃ¹ kÃ n yÄ«shÄ“ng.","en":"I need to see a doctor."},"åŒ»é™¢":{"zh":"åŒ»é™¢åœ¨å“ªé‡Œï¼Ÿ","py":"YÄ«yuÃ n zÃ i nÇŽlÇ?","en":"Where is the hospital?"},"æ¤…å­":{"zh":"è¯·ååœ¨æ¤…å­ä¸Šã€‚","py":"QÇng zuÃ² zÃ i yÇzi shÃ ng.","en":"Please sit on the chair."},"æœ‰":{"zh":"æˆ‘æœ‰ä¸€ä¸ªé—®é¢˜ã€‚","py":"WÇ’ yÇ’u yÄ«gÃ¨ wÃ¨ntÃ­.","en":"I have a question."},"æœˆ":{"zh":"æˆ‘ä¸‰æœˆåŽ»ä¸­å›½ã€‚","py":"WÇ’ sÄn yuÃ¨ qÃ¹ ZhÅngguÃ³.","en":"I'm going to China in March."},"åœ¨":{"zh":"ä»–åœ¨å›¾ä¹¦é¦†ã€‚","py":"TÄ zÃ i tÃºshÅ«guÇŽn.","en":"He is at the library."},"å†è§":{"zh":"å†è§ï¼Œæ˜Žå¤©è§ï¼","py":"ZÃ ijiÃ n, mÃ­ngtiÄn jiÃ n!","en":"Goodbye, see you tomorrow!"},"æ€Žä¹ˆ":{"zh":"è¿™ä¸ªå­—æ€Žä¹ˆå†™ï¼Ÿ","py":"ZhÃ¨ge zÃ¬ zÄ›nme xiÄ›?","en":"How do you write this character?"},"æ€Žä¹ˆæ ·":{"zh":"ä½ æ€Žä¹ˆæ ·ï¼Ÿ","py":"NÇ zÄ›nmeyÃ ng?","en":"How are you doing?"},"è¿™":{"zh":"è¿™æ˜¯ä»€ä¹ˆï¼Ÿ","py":"ZhÃ¨ shÃ¬ shÃ©nme?","en":"What is this?"},"ä¸­å›½":{"zh":"ä»–æ¥è‡ªä¸­å›½ã€‚","py":"TÄ lÃ¡izÃ¬ ZhÅngguÃ³.","en":"He is from China."},"ä¸­åˆ":{"zh":"ä¸­åˆæˆ‘ä»¬åŽ»åƒé¥­ã€‚","py":"ZhÅngwÇ” wÇ’men qÃ¹ chÄ«fÃ n.","en":"We're going to eat at noon."},"ä½":{"zh":"ä½ ä½åœ¨å“ªé‡Œï¼Ÿ","py":"NÇ zhÃ¹ zÃ i nÇŽlÇ?","en":"Where do you live?"},"æ¡Œå­":{"zh":"ä¹¦åœ¨æ¡Œå­ä¸Šã€‚","py":"ShÅ« zÃ i zhuÅzi shÃ ng.","en":"The book is on the desk."},"å­—":{"zh":"è¿™ä¸ªå­—æ€Žä¹ˆè¯»ï¼Ÿ","py":"ZhÃ¨ge zÃ¬ zÄ›nme dÃº?","en":"How do you read this character?"},"æ˜¨å¤©":{"zh":"æ˜¨å¤©æˆ‘åŽ»çœ‹ç”µå½±ã€‚","py":"ZuÃ³tiÄn wÇ’ qÃ¹ kÃ n diÃ nyÇng.","en":"Yesterday I went to see a movie."},"å":{"zh":"è¯·åï¼","py":"QÇng zuÃ²!","en":"Please sit down!"},"åš":{"zh":"ä½ åœ¨åšä»€ä¹ˆï¼Ÿ","py":"NÇ zÃ i zuÃ² shÃ©nme?","en":"What are you doing?"}});
  examplesCache['_loaded1']=true;
})();


async function fetchLevel(level) {
  if (vocabCache[level]) return vocabCache[level];
  const url = level === 'all'
    ? 'vocab.json'
    : `vocab-hsk${level}.json`;
  const res  = await fetch(url);
  const data = await res.json();
  vocabCache[level] = data;
  if (level !== 'all') {
    // also merge into the 'all' cache as levels arrive
    vocabCache['all'] = Object.values(
      Object.fromEntries(
        [...(vocabCache['all']||[]), ...data].map(w => [w.s+w.h, w])
      )
    );
  }
  return data;
}

async function fetchExamples(level) {
  if (level === 'all') { for (let l=1;l<=6;l++) fetchExamples(l); return; }
  if (examplesCache[`_loaded${level}`]) return;
  try {
    const res = await fetch(`examples-hsk${level}.json`);
    if (!res.ok) return;
    const data = await res.json();
    Object.assign(examplesCache, data);
    examplesCache[`_loaded${level}`] = true;
  } catch(e) {}
}

async function loadVocab() {
  try {
    // Load active level first so cards appear immediately
    const firstLevel = currentLevel === 'all' ? 1 : currentLevel;
    const firstBatch = await fetchLevel(firstLevel);
    fetchExamples(firstLevel); // load examples in background

    if (currentLevel === 'all') {
      allVocab = firstBatch;  // show HSK1 cards while rest loads
    } else {
      allVocab = firstBatch;
    }
    initQueue();

    // Background: load remaining levels silently
    if (currentLevel === 'all') {
      const remaining = [2, 3, 4, 5, 6];
      for (const lvl of remaining) {
        fetchExamples(lvl); // preload examples for all levels
        fetchLevel(lvl).then(words => {
          allVocab = [...allVocab, ...words];
          vocabCache['all'] = allVocab;
          // Update due count as more words load in
          document.getElementById('statDue').textContent = queue.length + (allVocab.length - queue.length - doneCount > 0 ? '+' : '');
        }).catch(() => {});
      }
    }
  } catch(e) {
    document.getElementById('cardContainer').innerHTML='<div class="done-state"><div class="done-char">ï¼</div><div class="done-title">Could not load vocabulary</div><div class="done-subtitle">Check your internet connection and try refreshing.</div></div>';
  }
}

// â”€â”€â”€ Settings state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSettings = {};
let pendingSettings  = {};

// â”€â”€â”€ User & Settings loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUser(){
  // â”€â”€ Auth check via Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let sbUser = null;
  if (window._sb) {
    try {
      const { data: { session } } = await window._sb.auth.getSession();
      if (!session) {
        const loginPage = location.pathname.endsWith('.html')
          ? 'login.html' : '/login';
        window.location.href = loginPage;
        return;
      }
      sbUser = session.user;
    } catch { /* Supabase not configured â€” allow localStorage-only mode */ }
  }

  // â”€â”€ Build a normalised user object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const user = sbUser ? {
    name:   sbUser.user_metadata?.full_name  || sbUser.email?.split('@')[0] || 'Learner',
    email:  sbUser.email || '',
    avatar: sbUser.user_metadata?.avatar_url || sbUser.user_metadata?.picture || null,
  } : { name: 'Learner', email: '', avatar: null };

  // â”€â”€ Render avatar + name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setAvatarEl('userAvatar', user);
  setAvatarEl('settingsAvatar', user);
  const nameEl = document.getElementById('userName');
  if (nameEl) nameEl.textContent = user.name.split(' ')[0];
  const sNameEl = document.getElementById('settingsUserName');
  if (sNameEl) sNameEl.textContent = user.name  || 'â€”';
  const sEmailEl = document.getElementById('settingsUserEmail');
  if (sEmailEl) sEmailEl.textContent = user.email || 'â€”';

  // â”€â”€ Load settings (Supabase first, localStorage fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let sbSettings = null;
  if (window._sb && sbUser) {
    try {
      const { data } = await window._sb
        .from('user_settings')
        .select('*')
        .eq('user_id', sbUser.id)
        .single();
      if (data) {
        sbSettings = {
          dailyTarget:     data.daily_target,
          preferredScript: data.script,
          defaultLevel:    data.default_level,
          autoPlayAudio:   data.auto_play_audio,
          voiceName:       data.voice_name,
          speechRate:      data.speech_rate,
        };
      }
    } catch {}
  }

  // Merge: Supabase wins, then localStorage, then defaults
  const lsRaw = localStorage.getItem('hsk_settings');
  const lsSettings = lsRaw ? JSON.parse(lsRaw) : {};
  currentSettings = Object.assign({ dailyTarget: 20 }, lsSettings, sbSettings || {});
  applySettings(currentSettings);
}

function setAvatarEl(id, user) {
  const el = document.getElementById(id);
  if (!el) return;
  if (user.avatar) {
    el.innerHTML = `<img src="${user.avatar}" alt="${user.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
  } else {
    el.textContent = (user.name?.[0] || 'æ¼¢').toUpperCase();
  }
}

function applySettings(s) {
  // Daily bar
  dailyDone = 0;
  targetNotified = false;
  initDailyBar(s.dailyTarget || 20);

  // Script
  if (s.preferredScript) {
    script = s.preferredScript;
    document.querySelectorAll('.script-btn').forEach(b => {
      b.classList.toggle('active', b.textContent.toLowerCase().includes(script));
    });
  }

  // Default level
  if (s.defaultLevel !== undefined) {
    currentLevel = s.defaultLevel === 'all' ? 'all' : parseInt(s.defaultLevel);
    document.querySelectorAll('.level-btn').forEach(b => {
      const lvl = b.textContent.includes('All') ? 'all' : parseInt(b.textContent.replace('HSK ',''));
      b.classList.toggle('active', lvl === currentLevel || (lvl === 'all' && currentLevel === 'all'));
    });
  }

  // Populate settings panel controls
  const ti = document.getElementById('settingsTarget');
  if (ti) ti.value = s.dailyTarget || 20;

  const ss = document.getElementById('settingsSound');
  if (ss) ss.checked = s.soundEnabled !== false;

  const sap = document.getElementById('settingsAutoPlay');
  if (sap) sap.checked = s.autoPlayAudio !== false;

  const st = document.getElementById('settingsTracking');
  if (st) st.checked = s.trackingEnabled !== false;

  const sel = document.getElementById('settingsLevel');
  if (sel) sel.value = s.defaultLevel || 'all';

  // Script segment
  const scriptSeg = document.getElementById('scriptSegment');
  if (scriptSeg) {
    scriptSeg.querySelectorAll('.segment-btn').forEach(b => {
      b.classList.toggle('active', b.textContent.toLowerCase().trim() === (s.preferredScript || 'simplified'));
    });
  }

  // Speech speed segment
  const speedSeg = document.getElementById('speedSegment');
  if (speedSeg) {
    const rate = typeof s.speechRate === 'number' ? s.speechRate : 0.85;
    speedSeg.querySelectorAll('.segment-btn').forEach(b => {
      const bRate = parseFloat(b.getAttribute('onclick')?.match(/[\d.]+/)?.[0] || '0.85');
      b.classList.toggle('active', Math.abs(bRate - rate) < 0.01);
    });
  }

  // Voice selector â€” repopulate in case voices changed
  if (voicesReady) populateVoiceSelector();
  else initVoices();
}

// â”€â”€â”€ Onboarding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showOnboarding(name) {
  const title = document.getElementById('onboardingTitle');
  if (title && name) title.textContent = `Welcome, ${name.split(' ')[0]}!`;
  document.getElementById('overlay').classList.add('show');
  document.getElementById('onboardingModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function setOnboardingTarget(val) {
  const slider  = document.getElementById('onboardingSlider');
  const display = document.getElementById('onboardingTargetDisplay');
  slider.value  = val;
  display.textContent = val;
  const pct = ((val - 5) / (100 - 5)) * 100;
  slider.style.setProperty('--pct', pct + '%');
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.textContent) === val);
  });
}

function onboardingSliderChange(val) {
  const v = parseInt(val);
  const display = document.getElementById('onboardingTargetDisplay');
  display.textContent = v;
  const pct = ((v - 5) / (100 - 5)) * 100;
  document.getElementById('onboardingSlider').style.setProperty('--pct', pct + '%');
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.textContent) === v);
  });
}

async function completeOnboarding() {
  const target = parseInt(document.getElementById('onboardingSlider').value) || 20;
  await fetch('/api/onboarding/complete', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ dailyTarget: target })
  });
  currentSettings.dailyTarget = target;
  initDailyBar(target);
  closeAll();
  // Clean URL
  history.replaceState({}, '', '/app');
}

// â”€â”€â”€ Settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSettings() {
  pendingSettings = { ...currentSettings };
  document.getElementById('overlay').classList.add('show');
  document.getElementById('settingsPanel').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeSettings() {
  document.getElementById('settingsPanel').classList.remove('show');
  document.getElementById('overlay').classList.remove('show');
  document.body.style.overflow = '';
}

function closeAll() {
  document.getElementById('overlay').classList.remove('show');
  document.getElementById('onboardingModal').classList.remove('show');
  document.getElementById('settingsPanel').classList.remove('show');
  document.body.style.overflow = '';
}

function settingChanged(key, value) {
  pendingSettings[key] = value;
}

function setSegment(containerId, btn, key, value) {
  document.getElementById(containerId).querySelectorAll('.segment-btn')
    .forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  pendingSettings[key] = value;
}

function stepTarget(delta) {
  const input = document.getElementById('settingsTarget');
  const val   = Math.max(5, Math.min(200, (parseInt(input.value) || 20) + delta));
  input.value = val;
  pendingSettings.dailyTarget = val;
}

function clampTarget() {
  const input = document.getElementById('settingsTarget');
  const val   = Math.max(5, Math.min(200, parseInt(input.value) || 20));
  input.value = val;
  pendingSettings.dailyTarget = val;
}

function saveSettings(){
  const target   = parseInt(document.getElementById('settingsTarget').value)||20;
  const sound    = document.getElementById('settingsSound')?.checked??true;
  const autoplay = document.getElementById('settingsAutoPlay').checked;
  const tracking = document.getElementById('settingsTracking').checked;
  const level    = document.getElementById('settingsLevel').value;
  const scriptSeg = document.getElementById('scriptSegment');
  const scriptVal = scriptSeg?.querySelector('.segment-btn.active')?.textContent.toLowerCase().trim()||'simplified';
  const voiceSel  = document.getElementById('settingsVoice');
  const voiceName = voiceSel?.value||'';
  const speedSeg  = document.getElementById('speedSegment');
  const speechRate = parseFloat(speedSeg?.querySelector('.segment-btn.active')?.getAttribute('onclick')?.match(/[\d.]+/)?.[0]||'0.85');
  const updates = {dailyTarget:target,soundEnabled:sound,autoPlayAudio:autoplay,trackingEnabled:tracking,defaultLevel:level,preferredScript:scriptVal,voiceName,speechRate,...pendingSettings,dailyTarget:target};
  window._LS.set('hsk_settings',updates);
  currentSettings=updates;
  applySettings(currentSettings);
  closeSettings();
}

async function logout(){
  await endSession();
  if (window._sb) await sbSignOut();
  const loginPage = location.pathname.endsWith('.html') ? 'login.html' : '/login';
  window.location.href = loginPage;
}

// â”€â”€â”€ Swipe & keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keyboard: â† = didn't know, â†’ = got it, Space/â†“ = reveal
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowLeft')  { if (currentCard && document.getElementById('cardAnswer')) recall('again'); }
  else if (e.key === 'ArrowRight') { if (currentCard && document.getElementById('cardAnswer')) recall('good'); }
  else if ((e.key === ' ' || e.key === 'ArrowDown') && currentCard) {
    e.preventDefault();
    if (!document.querySelector('.card-answer')) revealCard();
  }
});

// Swipe: left = didn't know, right = got it
(function(){
  let sx=0, sy=0;
  document.addEventListener('touchstart', e=>{sx=e.touches[0].clientX; sy=e.touches[0].clientY;}, {passive:true});
  document.addEventListener('touchend', e=>{
    if(!currentCard) return;
    const dx=e.changedTouches[0].clientX-sx;
    const dy=e.changedTouches[0].clientY-sy;
    if(Math.abs(dx)<50||Math.abs(dx)<Math.abs(dy)*1.5) return; // too short or too vertical
    const revealed = document.querySelector('.card-answer');
    if(!revealed){ revealCard(); return; }
    if(dx<0) recall('again');
    else recall('good');
  }, {passive:true});
})();
async function initQueue(){
  await endSession();
  const fsrs=loadFsrs();
  const today=todayStr();
  const vocab=currentLevel==='all'?[...allVocab]:allVocab.filter(v=>v.h===currentLevel);

  // Due reviews: have state and due date is today or earlier
  const due=vocab.filter(v=>fsrs[v.s]&&fsrs[v.s].due<=today)
    .sort((a,b)=>fsrs[a.s].due.localeCompare(fsrs[b.s].due));

  // New cards: never reviewed, limited to NEW_PER_DAY
  const newCards=vocab.filter(v=>!fsrs[v.s])
    .sort(()=>Math.random()-0.5)
    .slice(0,NEW_PER_DAY);

  sessionNewSet=new Set(newCards.map(v=>v.s));
  queue=[...due,...newCards];
  doneCount=0; reviewed=0; cardsCorrect=0; levelBreakdown={};
  updateStats();
  await startSession();
  showNext();
}

async function setLevel(l, btn) {
  // â”€â”€ Entitlement check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const FREE = ['1','2','3'];
  const lStr = String(l);
  if (!FREE.includes(lStr)) {
    const hasAccess = window.sbHasAccess ? await sbHasAccess(lStr) : true;
    if (!hasAccess) {
      showPaywall(lStr);
      return;
    }
  }

  currentLevel = l === 'all' ? 'all' : parseInt(l);
  document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  fetchExamples(currentLevel); // preload examples for this level

  // Use cache if available, else fetch (shows spinner briefly)
  if (currentLevel === 'all' && vocabCache['all']?.length) {
    allVocab = vocabCache['all'];
    initQueue();
  } else if (currentLevel !== 'all' && vocabCache[currentLevel]) {
    allVocab = vocabCache[currentLevel];
    initQueue();
  } else {
    document.getElementById('cardContainer').innerHTML =
      '<div class="loading"><div class="loading-char">æ¼¢</div><div class="loading-text">Loading HSK '+(l==='all'?'words':'level '+l)+'â€¦</div></div>';
    const words = await fetchLevel(currentLevel === 'all' ? 'all' : currentLevel);
    allVocab = words;
    initQueue();
  }
}

function setScript(s,btn){
  script=s;
  document.querySelectorAll('.script-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(currentCard) renderCard(currentCard);
}

// â”€â”€â”€ In-app paywall (shown when a level button is clicked without access) â”€â”€â”€â”€
const PW_INFO = {
  '4':   { char:'å››', name:'HSK 4 â€” Intermediate',       words:'600 words',   price:'Â£2', product:'hsk4' },
  '5':   { char:'äº”', name:'HSK 5 â€” Upper-Intermediate', words:'1,300 words', price:'Â£2', product:'hsk5' },
  '6':   { char:'å…­', name:'HSK 6 â€” Advanced',           words:'2,500 words', price:'Â£2', product:'hsk6' },
  'all': { char:'å…¨', name:'All Levels â€” Full Access',   words:'5,000 words', price:'Â£5', product:'all'  },
};

function showPaywall(level) {
  const info = PW_INFO[String(level)];
  if (!info) return;

  const alsoHtml = info.product !== 'all'
    ? `<div class="pw-also">Or get <a onclick="showPaywall('all')">all levels for Â£5</a></div>`
    : '';

  document.getElementById('cardContainer').innerHTML = `
    <div class="paywall-state">
      <span class="pw-char">${info.char}</span>
      <div class="pw-title">${info.name}</div>
      <div class="pw-desc">${info.words} of Mandarin vocabulary, unlocked forever.</div>
      <div class="pw-price">${info.price}</div>
      <div class="pw-note">One-time payment Â· No subscription</div>
      <button class="pw-buy" id="pwBuyBtn" onclick="paywallCheckout('${info.product}', this)">
        Buy now &rarr;
      </button>
      ${alsoHtml}
    </div>`;
}

async function paywallCheckout(productKey, btn) {
  btn.disabled = true;
  btn.textContent = 'Redirectingâ€¦';
  try {
    const url = await sbBuyLevel(productKey);
    window.location.href = url;
  } catch (err) {
    btn.disabled = false;
    btn.textContent = 'Buy now â†’';
    alert(err.message || 'Could not start checkout. Please try again.');
  }
}

function updateStats(){
  const newInQ=queue.filter(v=>sessionNewSet.has(v.s)).length;
  const revInQ=queue.length-newInQ;
  const total=queue.length+doneCount;
  document.getElementById('statDue').textContent=queue.length;
  document.getElementById('countNew').textContent=newInQ;
  document.getElementById('countReview').textContent=revInQ;
  document.getElementById('countDone').textContent=doneCount;
  document.getElementById('statReviewed').textContent=reviewed;
  document.getElementById('progressBar').style.width=(total>0?(doneCount/total*100):0)+'%';
}

// â”€â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNext(){
  if(!queue.length){showDone();return;}
  currentCard=queue[0]; renderCard(currentCard);
}

function cardHTML(card, revealed){
  const isTrad=script==='traditional';
  const chinese=isTrad?card.t:card.s;
  const alt=isTrad?card.s:card.t;
  const showAlt=alt!==chinese;
  const chars=[...chinese];
  const charsHTML=chars.length>1?`
    <div class="section-label">Character Breakdown</div>
    <div class="chars-grid">${chars.map(c=>`<div class="char-tile"><span class="char-tile-char">${c}</span></div>`).join('')}</div>`:'';

  const topHTML=`
      <div class="hsk-badge">HSK ${card.h}</div>
      <div class="card-top">
        <div class="card-chinese">${chinese}</div>
        <div class="card-pinyin">${card.p}</div>
        ${showAlt?`<div class="card-alt-label">${isTrad?'Simplified':'Traditional'}: <span>${alt}</span></div>`:''}
      </div>`;

  if(!revealed){
    return `<div class="card">${topHTML}
      <button class="reveal-btn" onclick="revealCard()">Tap to reveal meaning</button>
    </div>`;
  }

  return `<div class="card">${topHTML}
      <div class="card-answer">
        <div class="card-meaning">${card.m}</div>
        ${(()=>{const ex=examplesCache[card.s];return ex?`<div class="card-example"><div class="card-example-label">Example</div><div class="card-example-zh">${ex.zh}</div><div class="card-example-py">${ex.py}</div><div class="card-example-en">${ex.en}</div></div>`:''})()}
        <hr class="card-divider">
        <div class="speak-row">
          <button class="speak-btn" onclick="speakWord()">
            <svg class="speak-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15.536 8.464a5 5 0 010 7.072M9 9.5l-2 1.5H4v3h3l2 1.5V9.5z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Speak word
          </button>

        </div>
        ${charsHTML}
        ${(()=>{
          const fsrs=loadFsrs();
          const st=fsrs[card.s]||null;
          const iAgain=fsrsNext(st,1).interval;
          const iGood =fsrsNext(st,3).interval;
          return `<div class="recall-row">
          <button class="recall-btn recall-again" onclick="recall('again')">
            <span class="recall-icon">âœ•</span><span class="recall-btn-label">Didn't know</span>
          </button>
          <button class="recall-btn recall-good" onclick="recall('good')">
            <span class="recall-icon">âœ“</span><span class="recall-btn-label">Got it</span>
          </button>
        </div>`;
        })()}
      </div>
    </div>`;
}

function renderCard(card){
  document.getElementById('cardContainer').innerHTML = cardHTML(card, false);
  if(currentSettings.autoPlayAudio !== false) speakWordThenSentence();
}

function revealCard(){
  if(!currentCard) return;
  document.getElementById('cardContainer').innerHTML = cardHTML(currentCard, true);
  if(currentSettings.autoPlayAudio !== false) speakWordThenSentence();
}

function speakWordThenSentence() {
  if (!currentCard) return;
  const simplified = currentCard.s;
  const example = examplesCache[simplified];
  if (!example) {
    _playWordAudio(simplified);
    return;
  }
  _playWordAudioWithCallback(simplified, () => {
    setTimeout(() => _ttsSpeak(example.zh), 600);
  });
}

function _playWordAudioWithCallback(simplified, onEnd) {
  if (_audioCache[simplified] === 'failed') {
    _ttsSpeak(simplified);
    if (onEnd) setTimeout(onEnd, 1200);
    return;
  }

  const url = 'https://dict.youdao.com/dictvoice?audio=' + encodeURIComponent(simplified) + '&type=1';
  const audio = new Audio(url);
  audio.playbackRate = typeof currentSettings.speechRate === 'number'
    ? currentSettings.speechRate : 1.0;

  audio.addEventListener('canplaythrough', () => {
    _audioCache[simplified] = 'ok';
    audio.play().catch(() => {
      _audioCache[simplified] = 'failed';
      _ttsSpeak(simplified);
      if (onEnd) setTimeout(onEnd, 1200);
    });
  }, { once: true });

  audio.addEventListener('ended', () => {
    if (onEnd) onEnd();
  }, { once: true });

  audio.addEventListener('error', () => {
    _audioCache[simplified] = 'failed';
    _ttsSpeak(simplified);
    if (onEnd) setTimeout(onEnd, 1200);
  }, { once: true });

  audio.load();
}

function recall(type){
  if(!currentCard) return;
  const grade=type==='again'?1:3;
  const today=todayStr();
  const fsrs=loadFsrs();
  const key=currentCard.s;
  const {s,d,interval}=fsrsNext(fsrs[key]||null,grade);

  levelBreakdown[currentCard.h]=(levelBreakdown[currentCard.h]||0)+1;
  queue.shift(); reviewed++;

  // Always save updated state to localStorage + sync to Supabase
  fsrs[key]={s,d,due:addDays(today,interval),rev:today};
  saveFsrs(fsrs);
  sbSyncCard(key, fsrs[key]);  // non-blocking background sync

  if(grade===1){
    // Re-insert for same-session retry (still "due" in queue)
    queue.splice(Math.min(queue.length,5+Math.floor(Math.random()*5)),0,currentCard);
  } else {
    doneCount++; cardsCorrect++;
    dailyDone++; updateDailyBar();
  }
  updateStats(); showNext();
}

// â”€â”€â”€ Speech â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Friendly labels for known voice names across platforms
const VOICE_LABELS = {
  // macOS / iOS
  'Tingting':  'Tingting â€” Mainland â™€',
  'Sinji':     'Sinji â€” Hong Kong â™€',  // zh-HK, filtered out at selection
  'Meijia':    'Meijia â€” Taiwan â™€',
  'Lili':      'Lili â€” Mainland â™€',
  // Chrome cloud voices
  'Google æ™®é€šè¯ï¼ˆä¸­å›½å¤§é™†ï¼‰':          'Google â€” Mainland Standard',
  'Google ä¸­æ–‡ï¼ˆæ™®é€šè©±ï¼‰ï¼ˆå°ç£ï¼‰':      'Google â€” Taiwan Standard',
  // Windows / Edge
  'Microsoft Huihui - Chinese (Simplified, PRC)':  'Microsoft Huihui â€” Mainland â™€',
  'Microsoft Yaoyao - Chinese (Simplified, PRC)':  'Microsoft Yaoyao â€” Mainland â™€',
  'Microsoft Kangkang - Chinese (Simplified, PRC)':'Microsoft Kangkang â€” Mainland â™‚',
  'Microsoft Danny - Chinese (Traditional, Taiwan)':'Microsoft Danny â€” Taiwan â™‚',
  'Microsoft Yating - Chinese (Traditional, Taiwan)':'Microsoft Yating â€” Taiwan â™€',
  'Microsoft Zhiwei - Chinese (Traditional, Taiwan)':'Microsoft Zhiwei â€” Taiwan â™‚',
  // Edge Neural (online)
  'Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland)': 'Microsoft Xiaoxiao â€” Neural â™€',
  'Microsoft Yunxi Online (Natural) - Chinese (Mainland)':    'Microsoft Yunxi â€” Neural â™‚',
  'Microsoft Xiaoyi Online (Natural) - Chinese (Mainland)':   'Microsoft Xiaoyi â€” Neural â™€',
  'Microsoft Yunyang Online (Natural) - Chinese (Mainland)':  'Microsoft Yunyang â€” Neural â™‚',
  'Microsoft HsiaoChen Online (Natural) - Chinese (Taiwan)':  'Microsoft HsiaoChen â€” Taiwan â™€',
  'Microsoft HsiaoYu Online (Natural) - Chinese (Taiwan)':    'Microsoft HsiaoYu â€” Taiwan â™€',
  'Microsoft YunJhe Online (Natural) - Chinese (Taiwan)':     'Microsoft YunJhe â€” Taiwan â™‚',
};

let zhVoices = [];     // all zh-* voices available on this device
let voicesReady = false;

// Load voices â€” handles Chrome's async loading and Firefox/Safari sync loading
function initVoices() {
  return new Promise(resolve => {
    function process() {
      const all = speechSynthesis.getVoices();
      // Normalise Android underscores, then filter for any zh locale
      // Only Mandarin voices (zh-CN, zh-TW) â€” exclude Cantonese (zh-HK)
      zhVoices = all.filter(v => {
        const lang = v.lang.replace('_','-').toLowerCase();
        return lang.startsWith('zh') && !lang.startsWith('zh-hk');
      });
      voicesReady = true;
      populateVoiceSelector();
      resolve();
    }
    const immediate = speechSynthesis.getVoices();
    if (immediate.length) { process(); return; }
    // Chrome fires onvoiceschanged when cloud voices arrive
    speechSynthesis.addEventListener('voiceschanged', function handler() {
      speechSynthesis.removeEventListener('voiceschanged', handler);
      process();
    });
    // Fallback: some browsers never fire the event
    setTimeout(() => { if (!voicesReady) process(); }, 1500);
  });
}

function populateVoiceSelector() {
  const sel = document.getElementById('settingsVoice');
  if (!sel) return;
  sel.innerHTML = '';

  if (!zhVoices.length) {
    document.getElementById('voiceNoSupportRow').style.display = '';
    sel.style.display = 'none';
    return;
  }

  // Group: local (offline) voices first, then online/cloud
  const local  = zhVoices.filter(v => v.localService);
  const remote = zhVoices.filter(v => !v.localService);

  function addGroup(voices, label) {
    if (!voices.length) return;
    const grp = document.createElement('optgroup');
    grp.label = label;
    voices.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = VOICE_LABELS[v.name] || v.name;
      grp.appendChild(opt);
    });
    sel.appendChild(grp);
  }

  addGroup(local,  'On-device voices');
  addGroup(remote, 'Online voices (higher quality)');

  // Restore saved preference, or pick best default
  const saved = currentSettings.voiceName;
  if (saved && zhVoices.find(v => v.name === saved)) {
    sel.value = saved;
  } else {
    // Prefer a local zh-CN voice, else first available
    const best = local.find(v => v.lang.startsWith('zh-CN') || v.lang.startsWith('zh_CN'))
              || local[0] || remote[0];
    if (best) sel.value = best.name;
    // Auto-save the default so it's persisted
    if (best) settingChanged('voiceName', best.name);
  }
}

function getSelectedVoice() {
  const name = currentSettings.voiceName
    || document.getElementById('settingsVoice')?.value;
  if (!name) return zhVoices[0] || null;
  // Always re-query â€” voice objects may have been replaced after voiceschanged
  return speechSynthesis.getVoices().find(v => v.name === name)
    || zhVoices[0] || null;
}

// â”€â”€â”€ Audio: MP3-first, TTS fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Audio system: Youdao Dictionary API â†’ browser TTS fallback
// Youdao serves genuine native Mandarin recordings for Chinese words.
// No files to host. Falls back to browser TTS if fetch fails.

let _audioCache = {};  // word â†’ 'ok' | 'failed'

function speakText(text) {
  // Always use TTS for multi-sentence text (test voice, conversation page, etc.)
  _ttsSpeak(text);
}

function speakWord() {
  if (!currentCard) return;
  const simplified = currentCard.s;
  _playWordAudio(simplified);
}

function _playWordAudio(simplified) {
  if (_audioCache[simplified] === 'failed') {
    _ttsSpeak(simplified);
    return;
  }

  // Youdao Dictionary audio: type=1 female voice, type=2 male voice
  const url = 'https://dict.youdao.com/dictvoice?audio=' + encodeURIComponent(simplified) + '&type=1';

  const audio = new Audio(url);
  audio.playbackRate = typeof currentSettings.speechRate === 'number'
    ? currentSettings.speechRate : 1.0;

  audio.addEventListener('canplaythrough', () => {
    _audioCache[simplified] = 'ok';
    audio.play().catch(() => {
      _audioCache[simplified] = 'failed';
      _ttsSpeak(simplified);
    });
  }, { once: true });

  audio.addEventListener('error', () => {
    _audioCache[simplified] = 'failed';
    _ttsSpeak(simplified);
  }, { once: true });

  audio.load();
}

function _ttsSpeak(text) {
  if (!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const utt   = new SpeechSynthesisUtterance(text);
  const voice = getSelectedVoice();
  if (voice) {
    utt.voice = voice;
    utt.lang  = voice.lang.replace('_', '-');
  } else {
    utt.lang = 'zh-CN';
  }
  utt.rate = typeof currentSettings.speechRate === 'number' ? currentSettings.speechRate : 0.85;
  speechSynthesis.speak(utt);
}

function testVoice() {
  // Save pending voice selection before testing
  const sel = document.getElementById('settingsVoice');
  if (sel) currentSettings.voiceName = sel.value;
  _ttsSpeak('ä½ å¥½ï¼Œæ¬¢è¿Žå­¦ä¹ æ±‰è¯­ï¼');
}

// â”€â”€â”€ Done screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showDone(){
  await endSession();
  currentCard=null;
  const lvl=currentLevel==='all'?'All HSK':`HSK ${currentLevel}`;
  const accuracy=reviewed>0?Math.round((cardsCorrect/reviewed)*100):0;

  // Find next due date
  const fsrs=loadFsrs();
  const vocab=currentLevel==='all'?[...allVocab]:allVocab.filter(v=>v.h===currentLevel);
  const today=todayStr();
  const upcoming=vocab.filter(v=>fsrs[v.s]).map(v=>fsrs[v.s].due).sort();
  const nextDue=upcoming.find(d=>d>today);
  const newRemaining=vocab.filter(v=>!fsrs[v.s]).length;
  let nextLine='';
  if(nextDue){
    const days=daysBetween(today,nextDue);
    nextLine=`<div style="margin-top:12px;font-size:14px;color:var(--ink-muted);font-style:italic">${days<=1?'More cards due tomorrow':'Next review in '+days+' days'} Â· ${newRemaining} new cards remaining</div>`;
  } else if(newRemaining>0){
    nextLine=`<div style="margin-top:12px;font-size:14px;color:var(--ink-muted);font-style:italic">${newRemaining} new cards waiting</div>`;
  }

  document.getElementById('cardContainer').innerHTML=`
    <div class="done-state">
      <div class="done-char">å®Œ</div>
      <div class="done-title">${reviewed===0?'All caught up!':'Session Complete!'}</div>
      <div class="done-subtitle">
        ${reviewed>0?`You reviewed <strong>${reviewed}</strong> ${lvl} card${reviewed!==1?'s':''} with <strong>${accuracy}%</strong> accuracy. å¾ˆå¥½ï¼`:'No cards due right now. Great work keeping up!'}
        ${nextLine}
      </div>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px">
        <button class="restart-btn" onclick="initQueue()">Check Again</button>
      </div>
    </div>`;
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadUser();
loadVocab();
initVoices();
sbSyncInit(); // pull card states from Supabase in background (non-blocking)

// Handle return from Stripe Checkout (success or cancel)
(function(){
  const params = new URLSearchParams(location.search);
  if (params.get('payment') === 'success') {
    sbClearEntitlementCache();  // force re-check of what they now own
    history.replaceState({}, '', location.pathname);
    // Show a brief success toast then re-load the purchased level
    const product = params.get('product') || '';
    const levelMap = {hsk4:'4', hsk5:'5', hsk6:'6', all:'all'};
    const paidLevel = levelMap[product];
    if (paidLevel) {
      setTimeout(() => {
        const btn = paidLevel === 'all'
          ? document.querySelector('.level-btn[onclick*="all"]')
          : document.querySelector(`.level-btn[onclick*="setLevel(${paidLevel},"]`);
        if (btn) btn.click();
      }, 200);
    }
  }
})();

// Auto-select level from URL param e.g. /app?level=3 or /app?level=all
(function(){
  const p=new URLSearchParams(location.search).get('level');
  if(!p) return;
  if(p==='all'){
    const btn=document.querySelector('.level-btn[onclick*="setLevel(\'all\'"]') || document.querySelector('.level-btn[onclick*="setLevel(\"all\""]');
    if(btn) btn.click();
  } else if(['1','2','3','4','5','6'].includes(p)){
    const btn=document.querySelector(`.level-btn[onclick*="setLevel(${p},"]`) || document.querySelector(`.level-btn[onclick*="setLevel('${p}'"]`);
    if(btn) btn.click();
  }
})();
</script>
</body>
</html>
