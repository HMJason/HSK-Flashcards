<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign In — HSK Flashcards</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

<style>
  :root {
    --cream: #f0ebe0;
    --gold: #8b6914;
    --gold-light: #c4a035;
    --red: #8b1a1a;
    --ink: #2c2416;
    --ink-light: #5a4e3a;
    --ink-muted: #8a7a62;
    --card-bg: #faf7f2;
    --border: rgba(139,105,20,0.2);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'EB Garamond', Georgia, serif;
    background: var(--cream);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background-image:
      radial-gradient(ellipse at 15% 40%, rgba(139,26,26,0.06) 0%, transparent 55%),
      radial-gradient(ellipse at 85% 70%, rgba(139,105,20,0.06) 0%, transparent 55%),
      radial-gradient(ellipse at 50% 10%, rgba(139,105,20,0.03) 0%, transparent 40%);
  }

  /* Decorative background characters */
  .bg-chars {
    position: fixed;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: 0;
  }

  .bg-char {
    position: absolute;
    font-family: 'Noto Serif SC', serif;
    color: rgba(139,105,20,0.06);
    font-weight: 700;
    user-select: none;
    animation: floatChar linear infinite;
  }

  @keyframes floatChar {
    from { transform: translateY(0) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    to { transform: translateY(-100px) rotate(5deg); opacity: 0; }
  }

  /* Main card */
  .login-card {
    position: relative;
    z-index: 1;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 52px 48px;
    width: 100%;
    max-width: 420px;
    box-shadow:
      0 8px 40px rgba(44,36,22,0.08),
      0 2px 8px rgba(44,36,22,0.04),
      inset 0 1px 0 rgba(255,255,255,0.6);
    animation: cardIn 0.5s cubic-bezier(0.2,0.8,0.3,1);
  }

  @keyframes cardIn {
    from { opacity: 0; transform: translateY(20px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* Header */
  .card-header { text-align: center; margin-bottom: 40px; }

  .logo-char {
    font-family: 'Noto Serif SC', serif;
    font-size: 64px;
    color: var(--red);
    font-weight: 700;
    line-height: 1;
    display: block;
    margin-bottom: 12px;
    filter: drop-shadow(0 2px 8px rgba(139,26,26,0.2));
  }

  .app-title {
    font-family: 'EB Garamond', serif;
    font-size: 11px;
    letter-spacing: 0.3em;
    color: var(--ink-muted);
    text-transform: uppercase;
    margin-bottom: 24px;
  }

  .divider-line {
    width: 40px;
    height: 1px;
    background: var(--border);
    margin: 0 auto 24px;
  }

  .welcome-title {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    color: var(--ink);
    font-weight: 400;
    margin-bottom: 8px;
  }

  .welcome-sub {
    font-size: 15px;
    color: var(--ink-muted);
    font-style: italic;
    line-height: 1.5;
  }

  /* Auth buttons */
  .auth-buttons { display: flex; flex-direction: column; gap: 12px; margin-bottom: 32px; }

  .auth-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    padding: 14px 24px;
    border-radius: 4px;
    font-family: 'EB Garamond', serif;
    font-size: 16px;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.22s ease;
    position: relative;
    overflow: hidden;
  }

  .auth-btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0);
    transition: background 0.2s;
  }

  .auth-btn:hover::after { background: rgba(255,255,255,0.08); }
  .auth-btn:active { transform: scale(0.99); }

  /* Google */
  .btn-google {
    background: #fff;
    border: 1px solid #dadce0;
    color: #3c4043;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .btn-google:hover {
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    border-color: #bbb;
  }

  .google-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  /* Apple */
  .btn-apple {
    background: #000;
    border: 1px solid #000;
    color: #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  }
  .btn-apple:hover {
    background: #1a1a1a;
    box-shadow: 0 2px 10px rgba(0,0,0,0.25);
  }

  .apple-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    fill: #fff;
  }

  /* Divider */
  .or-divider {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 24px;
    color: var(--ink-muted);
    font-size: 13px;
    letter-spacing: 0.1em;
  }
  .or-divider::before, .or-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Footer */
  .card-footer {
    text-align: center;
    font-size: 13px;
    color: var(--ink-muted);
    line-height: 1.6;
    border-top: 1px solid var(--border);
    padding-top: 24px;
  }

  .card-footer a {
    color: var(--gold);
    text-decoration: none;
  }
  .card-footer a:hover { text-decoration: underline; }

  /* Loading state */
  .btn-loading { opacity: 0.6; pointer-events: none; }
  .btn-loading span { display: none; }

  /* Error */
  .error-msg {
    background: rgba(139,26,26,0.06);
    border: 1px solid rgba(139,26,26,0.2);
    color: #8b1a1a;
    border-radius: 3px;
    padding: 10px 14px;
    font-size: 14px;
    margin-bottom: 16px;
    display: none;
    text-align: center;
  }

  /* Config warning */
  .config-warning {
    background: rgba(139,105,20,0.07);
    border: 1px solid rgba(139,105,20,0.25);
    border-radius: 4px;
    padding: 14px 16px;
    font-size: 13px;
    color: var(--gold);
    margin-bottom: 20px;
    line-height: 1.5;
  }
  .config-warning strong { display: block; margin-bottom: 4px; font-size: 14px; }
  .config-warning code { background: rgba(139,105,20,0.1); padding: 1px 5px; border-radius: 2px; font-family: monospace; font-size: 12px; }

  @media (max-width: 480px) {
    .login-card { padding: 36px 24px; }
    .logo-char { font-size: 52px; }
    .welcome-title { font-size: 22px; }
  }
</style>
</head>
<body>

<!-- Decorative floating characters -->
<div class="bg-chars" id="bgChars"></div>

<div class="login-card">
  <div class="card-header">
    <span class="logo-char">漢</span>
    <div class="app-title">HSK Flashcards</div>
    <div class="divider-line"></div>
    <div class="welcome-title">Welcome back</div>
    <div class="welcome-sub">Sign in to continue your Mandarin journey</div>
  </div>

  <div id="configWarning" class="config-warning" style="display:none">
    <strong>⚙️ Setup required</strong>
    OAuth credentials not yet configured. Copy <code>.env.example</code> to <code>.env</code> and add your Google/Apple credentials.
  </div>

  <div id="errorMsg" class="error-msg"></div>

  <div class="auth-buttons">
    <!-- Google Sign In -->
    <button class="auth-btn btn-google" id="googleBtn" onclick="signInWithGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span>Continue with Google</span>
    </button>

    <!-- Apple Sign In -->
    <button class="auth-btn btn-apple" id="appleBtn" onclick="signInWithApple()">
      <svg class="apple-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98l-.09.06c-.22.14-2.19 1.28-2.17 3.83.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.36 2.75M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
      </svg>
      <span>Continue with Apple</span>
    </button>
  </div>

  <div class="card-footer">
    By signing in, you agree to our <a href="#">Terms of Service</a>
    and <a href="#">Privacy Policy</a>.<br>
    Your progress is saved to your account.
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="supabase-client.js"></script>
<script>
// ─── Floating background characters ──────────────────────────────────────────
const chars = ['学','习','中','文','汉','字','读','写','听','说','语','言','考','试','词','拼','音','声','调','笔'];
const bg = document.getElementById('bgChars');
chars.forEach((c, i) => {
  const el = document.createElement('div');
  el.className = 'bg-char';
  el.textContent = c;
  el.style.cssText = `
    left: ${5 + (i * 4.5) % 90}%;
    top: ${10 + (i * 7) % 80}%;
    font-size: ${40 + (i % 4) * 20}px;
    animation-duration: ${18 + (i % 7) * 4}s;
    animation-delay: ${-(i % 9) * 3}s;
  `;
  bg.appendChild(el);
});

// ─── UI helpers ──────────────────────────────────────────────────────────────
function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 6000);
}
function setLoading(btnId, on) {
  document.getElementById(btnId).classList.toggle('btn-loading', on);
}
function goToApp() {
  // Detect whether we're in static/GitHub Pages or server mode
  const isGhPages = location.hostname.includes('github.io');
  window.location.href = isGhPages ? 'flashcards.html' : '/home';
}

// ─── Auth state change listener ───────────────────────────────────────────────
// Catches the session when the user returns from an OAuth redirect
window._sb.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN' && session) {
    goToApp();
  }
});

// ─── Check if already logged in ──────────────────────────────────────────────
(async () => {
  const { data: { session } } = await window._sb.auth.getSession();
  if (session) goToApp();

  // Show config warning if Supabase not yet configured
  if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
    document.getElementById('configWarning').style.display = '';
    document.getElementById('configWarning').innerHTML = `
      <strong>⚙️ Supabase not configured</strong>
      Open <code>public/supabase-client.js</code> and replace
      <code>YOUR_SUPABASE_URL</code> and <code>YOUR_SUPABASE_ANON_KEY</code>
      with your project's values from the Supabase dashboard.
    `;
  }
})();

// ─── Sign in with Google ──────────────────────────────────────────────────────
async function signInWithGoogle() {
  setLoading('googleBtn', true);
  try {
    await sbSignInGoogle();
    // OAuth redirect flow — page will reload after redirect
  } catch (err) {
    showError(err.message || 'Google sign-in failed. Please try again.');
    setLoading('googleBtn', false);
  }
}

// ─── Sign in with Apple ───────────────────────────────────────────────────────
async function signInWithApple() {
  setLoading('appleBtn', true);
  try {
    await sbSignInApple();
  } catch (err) {
    showError(err.message || 'Apple sign-in failed. Please try again.');
    setLoading('appleBtn', false);
  }
}
</script>
</body>
</html>
