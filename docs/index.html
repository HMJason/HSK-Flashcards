<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¼¢ HSK Flashcards â€” Learn Mandarin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Noto+Serif+SC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f0ebe0; --cream-dark: #e5dfd2; --cream-mid: #ede8dc;
    --gold: #8b6914; --gold-light: #c4a035; --gold-faint: rgba(139,105,20,0.08);
    --red: #8b1a1a; --red-light: #c0392b;
    --ink: #2c2416; --ink-light: #5a4e3a; --ink-muted: #8a7a62;
    --green: #2d5a3d; --card-bg: #faf7f2; --border: rgba(139,105,20,0.18);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'EB Garamond', Georgia, serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    background: var(--cream);
    border-bottom: 1px solid var(--border);
    padding: 0 48px;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px; position: sticky; top: 0; z-index: 10;
  }
  .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
  .logo-char { font-family: 'Noto Serif SC', serif; font-size: 32px; color: var(--red); font-weight: 700; line-height: 1; }
  .logo-text { font-size: 11px; letter-spacing: 0.22em; color: var(--ink-muted); text-transform: uppercase; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border); background: var(--cream-dark); display: flex; align-items: center; justify-content: center; font-family: 'Noto Serif SC', serif; font-size: 14px; color: var(--gold); overflow: hidden; }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-name { font-size: 14px; color: var(--ink-light); }
  .sign-out-btn { border: 1px solid var(--border); background: none; border-radius: 30px; padding: 5px 14px; font-family: 'EB Garamond', serif; font-size: 13px; color: var(--ink-muted); cursor: pointer; transition: all 0.2s; }
  .sign-out-btn:hover { border-color: var(--red); color: var(--red); }

  /* â”€â”€ Hero â”€â”€ */
  .hero {
    flex: 1;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 60px 24px 48px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: 'ä¸­';
    font-family: 'Noto Serif SC', serif;
    font-size: clamp(200px, 35vw, 420px);
    font-weight: 700;
    color: rgba(139,26,26,0.04);
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    user-select: none;
    line-height: 1;
  }
  .hero-eyebrow {
    font-size: 11px; letter-spacing: 0.3em; color: var(--gold);
    text-transform: uppercase; margin-bottom: 20px;
    animation: fadeUp 0.6s ease both;
  }
  .hero-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(28px, 5vw, 52px);
    color: var(--ink);
    line-height: 1.2;
    max-width: 700px;
    margin-bottom: 16px;
    animation: fadeUp 0.7s 0.1s ease both;
  }
  .hero-title em { font-style: italic; color: var(--red); }
  .hero-sub {
    font-size: clamp(16px, 2vw, 20px);
    color: var(--ink-muted);
    font-style: italic;
    max-width: 520px;
    line-height: 1.6;
    margin-bottom: 56px;
    animation: fadeUp 0.7s 0.2s ease both;
  }

  /* â”€â”€ Choice cards â”€â”€ */
  .choices {
    display: flex;
    flex-direction: column;
    gap: 28px;
    width: 100%;
    max-width: 800px;
    animation: fadeUp 0.7s 0.3s ease both;
    position: relative;
    z-index: 1;
  }
  .section-heading {
    font-size: 11px; letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 14px;
  }
  .level-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  .level-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 32px 28px 28px;
    text-decoration: none;
    color: inherit;
    display: flex; flex-direction: column; align-items: flex-start; gap: 0;
    transition: all 0.25s cubic-bezier(0.2, 0.8, 0.3, 1);
    cursor: pointer;
    position: relative; overflow: hidden;
  }
  .level-card::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, var(--gold-faint) 0%, transparent 60%);
    opacity: 0; transition: opacity 0.3s;
  }
  .level-card:hover { transform: translateY(-3px); box-shadow: 0 10px 32px rgba(44,36,22,0.10), 0 2px 10px rgba(139,105,20,0.08); border-color: var(--gold-light); }
  .level-card:hover::before { opacity: 1; }
  .level-char {
    font-family: 'Noto Serif SC', serif;
    font-size: 52px; color: var(--red); line-height: 1;
    margin-bottom: 16px;
    transition: transform 0.25s;
  }
  .level-card:hover .level-char { transform: scale(1.08); }
  .level-num {
    font-family: 'Playfair Display', serif;
    font-size: 20px; color: var(--ink); font-weight: 600;
    margin-bottom: 4px;
  }
  .level-words {
    font-size: 12px; color: var(--gold); letter-spacing: 0.08em; text-transform: uppercase;
    margin-bottom: 12px;
  }
  .level-desc {
    font-size: 14px; color: var(--ink-muted);
    line-height: 1.55; font-style: italic;
  }
  .level-card-all {
    grid-column: 1 / -1;
    flex-direction: row; align-items: center; gap: 24px;
    padding: 28px 32px;
  }
  .level-card-all .level-char { font-size: 44px; margin-bottom: 0; flex-shrink: 0; }
  .level-card-all .level-all-body { flex: 1; }
  .level-card-all .level-num { font-size: 22px; margin-bottom: 4px; }
  .level-card-all .level-words { margin-bottom: 6px; }
  .level-card-all .level-desc { margin: 0; }
  .level-card-all-arrow {
    font-size: 13px; color: var(--gold); letter-spacing: 0.06em;
    display: flex; align-items: center; gap: 8px; flex-shrink: 0;
    transition: gap 0.2s;
  }
  .level-card-all-arrow svg { width: 16px; height: 16px; transition: transform 0.2s; }
  .level-card-all:hover .level-card-all-arrow { gap: 12px; }
  .level-card-all:hover .level-card-all-arrow svg { transform: translateX(2px); }

  /* â”€â”€ Free / paid badges â”€â”€ */
  .level-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase;
    padding: 3px 9px; border-radius: 20px;
    margin-bottom: 10px; font-style: normal;
    position: relative; z-index: 1;
  }
  .badge-free  { background: rgba(45,90,61,0.10); color: var(--green); border: 1px solid rgba(45,90,61,0.18); }
  .badge-paid  { background: rgba(139,105,20,0.10); color: var(--gold); border: 1px solid rgba(139,105,20,0.22); }
  .badge-owned { background: rgba(45,90,61,0.10); color: var(--green); border: 1px solid rgba(45,90,61,0.18); }
  .level-card.locked { cursor: pointer; opacity: 0.88; }
  .level-card.locked:hover { opacity: 1; }

  /* â”€â”€ Paywall modal â”€â”€ */
  .paywall-backdrop {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(44,36,22,0.55);
    backdrop-filter: blur(3px);
    display: flex; align-items: center; justify-content: center;
    padding: 24px;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .paywall-backdrop.open { opacity: 1; pointer-events: auto; }
  .paywall-modal {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 40px 36px;
    max-width: 420px; width: 100%;
    box-shadow: 0 24px 64px rgba(44,36,22,0.18);
    transform: translateY(20px) scale(0.97);
    transition: transform 0.28s cubic-bezier(0.2, 0.8, 0.3, 1);
  }
  .paywall-backdrop.open .paywall-modal { transform: translateY(0) scale(1); }
  .paywall-char {
    font-family: 'Noto Serif SC', serif;
    font-size: 56px; color: var(--red); line-height: 1;
    margin-bottom: 16px; display: block;
  }
  .paywall-title {
    font-family: 'Playfair Display', serif;
    font-size: 22px; color: var(--ink); font-weight: 600;
    margin-bottom: 8px;
  }
  .paywall-desc { font-size: 15px; color: var(--ink-muted); font-style: italic; line-height: 1.55; margin-bottom: 24px; }
  .paywall-price { font-family: 'Playfair Display', serif; font-size: 36px; color: var(--ink); font-weight: 600; margin-bottom: 4px; }
  .paywall-price-note { font-size: 13px; color: var(--ink-muted); margin-bottom: 28px; }
  .paywall-buy-btn {
    width: 100%; padding: 15px;
    background: var(--red); color: #fff;
    border: none; border-radius: 5px;
    font-family: 'EB Garamond', serif; font-size: 17px; letter-spacing: 0.04em;
    cursor: pointer; transition: background 0.2s, transform 0.15s; margin-bottom: 10px;
  }
  .paywall-buy-btn:hover { background: #a01e1e; }
  .paywall-buy-btn:active { transform: scale(0.99); }
  .paywall-buy-btn:disabled { opacity: 0.6; pointer-events: none; }
  .paywall-cancel {
    width: 100%; padding: 11px;
    background: none; border: 1px solid var(--border); border-radius: 5px;
    color: var(--ink-muted); font-family: 'EB Garamond', serif; font-size: 15px;
    cursor: pointer; transition: border-color 0.2s, color 0.2s;
  }
  .paywall-cancel:hover { border-color: var(--ink-muted); color: var(--ink); }
  .paywall-also { font-size: 13px; color: var(--ink-muted); text-align: center; margin-top: 14px; line-height: 1.5; }
  .paywall-also a { color: var(--gold); cursor: pointer; text-decoration: none; }
  .paywall-also a:hover { text-decoration: underline; }
  .paywall-error {
    background: rgba(139,26,26,0.06); border: 1px solid rgba(139,26,26,0.2);
    color: #8b1a1a; border-radius: 3px; padding: 9px 13px;
    font-size: 13px; margin-bottom: 14px; display: none; text-align: center;
  }

  .choice-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 28px 32px;
    text-decoration: none;
    color: inherit;
    display: flex; flex-direction: row; align-items: center; gap: 24px;
    transition: all 0.28s cubic-bezier(0.2, 0.8, 0.3, 1);
    cursor: pointer;
    position: relative; overflow: hidden;
  }
  .choice-card::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, var(--gold-faint) 0%, transparent 60%);
    opacity: 0; transition: opacity 0.3s;
  }
  .choice-card:hover { transform: translateY(-3px); box-shadow: 0 10px 32px rgba(44,36,22,0.10), 0 2px 10px rgba(139,105,20,0.08); border-color: var(--gold-light); }
  .choice-card:hover::before { opacity: 1; }
  .choice-card:active { transform: translateY(-1px); }
  .choice-icon {
    font-family: 'Noto Serif SC', serif;
    font-size: 44px; color: var(--red); line-height: 1;
    flex-shrink: 0;
    filter: drop-shadow(0 2px 8px rgba(139,26,26,0.15));
    transition: transform 0.3s;
  }
  .choice-card:hover .choice-icon { transform: scale(1.08) rotate(-2deg); }
  .choice-body { flex: 1; }
  .choice-label {
    font-size: 10px; letter-spacing: 0.25em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 6px;
  }
  .choice-title {
    font-family: 'Playfair Display', serif;
    font-size: 20px; color: var(--ink); margin-bottom: 6px;
  }
  .choice-desc {
    font-size: 14px; color: var(--ink-muted);
    line-height: 1.5; font-style: italic;
  }
  .choice-cta {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: var(--gold);
    letter-spacing: 0.06em; flex-shrink: 0;
    transition: gap 0.2s;
  }
  .choice-card:hover .choice-cta { gap: 12px; }
  .choice-cta svg { width: 16px; height: 16px; transition: transform 0.2s; }
  .choice-card:hover .choice-cta svg { transform: translateX(2px); }

  /* â”€â”€ Footer â”€â”€ */
  footer {
    text-align: center;
    padding: 24px;
    font-size: 13px;
    color: var(--ink-muted);
    border-top: 1px solid var(--border);
  }
  footer a { color: var(--gold); text-decoration: none; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(18px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @media (max-width: 600px) {
    header { padding: 0 20px; }
    .hero { padding: 40px 20px 32px; }
    .level-grid { grid-template-columns: 1fr; }
    .level-card-all { flex-direction: column; align-items: flex-start; gap: 12px; }
    .choice-card { flex-direction: column; align-items: flex-start; gap: 12px; }
    .user-name { display: none; }
  }
</style>
</head>
<body>
<header>
  <a class="logo" href="index.html">
    <div class="logo-char">æ¼¢</div>
    <div class="logo-text">HSK Flashcards</div>
  </a>
  <div class="header-right">
    <div class="user-avatar" id="userAvatar">æ¼¢</div>
    <span class="user-name" id="userName"></span>
    <button class="sign-out-btn" onclick="signOut()">Sign out</button>
  </div>
</header>

<main class="hero">
  <div class="hero-eyebrow">Your journey starts here</div>
  <h1 class="hero-title">Learning Mandarin is not as <em>difficult</em> as you think</h1>
  <p class="hero-sub">We're here to help. What would you like to do today?</p>

  <div class="choices">
    <!-- Flashcard levels -->
    <div>
      <div class="section-heading">Flashcards â€” choose your level</div>
      <div class="level-grid" id="levelGrid">

        <!-- HSK 1 â€” Free -->
        <a class="level-card" href="flashcards.html?level=1" data-level="1">
          <span class="level-badge badge-free">Free</span>
          <span class="level-char">ä¸€</span>
          <span class="level-num">HSK 1</span>
          <span class="level-words">150 words</span>
          <span class="level-desc">Complete beginner. Everyday basics â€” greetings, numbers, family, simple questions.</span>
        </a>

        <!-- HSK 2 â€” Free -->
        <a class="level-card" href="flashcards.html?level=2" data-level="2">
          <span class="level-badge badge-free">Free</span>
          <span class="level-char">äºŒ</span>
          <span class="level-num">HSK 2</span>
          <span class="level-words">150 words</span>
          <span class="level-desc">Elementary. Short conversations about daily life â€” shopping, travel, time.</span>
        </a>

        <!-- HSK 3 â€” Free -->
        <a class="level-card" href="flashcards.html?level=3" data-level="3">
          <span class="level-badge badge-free">Free</span>
          <span class="level-char">ä¸‰</span>
          <span class="level-num">HSK 3</span>
          <span class="level-words">300 words</span>
          <span class="level-desc">Pre-intermediate. Handle most situations while travelling or living in China.</span>
        </a>

        <!-- HSK 4 â€” Paid -->
        <a class="level-card locked" href="#" data-level="4" data-product="hsk4" data-price="Â£2"
           data-char="å››" data-words="600 words"
           data-desc="Intermediate. Discuss a wide range of topics with native speakers fluently.">
          <span class="level-badge badge-paid">ðŸ”’ Â£2</span>
          <span class="level-char">å››</span>
          <span class="level-num">HSK 4</span>
          <span class="level-words">600 words</span>
          <span class="level-desc">Intermediate. Discuss a wide range of topics with native speakers fluently.</span>
        </a>

        <!-- HSK 5 â€” Paid -->
        <a class="level-card locked" href="#" data-level="5" data-product="hsk5" data-price="Â£2"
           data-char="äº”" data-words="1,300 words"
           data-desc="Upper-intermediate. Read newspapers, watch films, and express opinions naturally.">
          <span class="level-badge badge-paid">ðŸ”’ Â£2</span>
          <span class="level-char">äº”</span>
          <span class="level-num">HSK 5</span>
          <span class="level-words">1,300 words</span>
          <span class="level-desc">Upper-intermediate. Read newspapers, watch films, and express opinions naturally.</span>
        </a>

        <!-- HSK 6 â€” Paid -->
        <a class="level-card locked" href="#" data-level="6" data-product="hsk6" data-price="Â£2"
           data-char="å…­" data-words="2,500 words"
           data-desc="Advanced. Near-native fluency â€” understand complex written and spoken Chinese.">
          <span class="level-badge badge-paid">ðŸ”’ Â£2</span>
          <span class="level-char">å…­</span>
          <span class="level-num">HSK 6</span>
          <span class="level-words">2,500 words</span>
          <span class="level-desc">Advanced. Near-native fluency â€” understand complex written and spoken Chinese.</span>
        </a>

        <!-- All Levels â€” Paid -->
        <a class="level-card level-card-all locked" href="#" data-level="all" data-product="all" data-price="Â£5"
           data-char="å…¨" data-words="5,000 words"
           data-desc="Study the full HSK vocabulary set together â€” ideal once you've covered the individual levels.">
          <span class="level-char">å…¨</span>
          <div class="level-all-body">
            <span class="level-num">All Levels</span>
            <span class="level-words">5,000 words</span>
            <span class="level-badge badge-paid" style="margin-bottom:8px">ðŸ”’ Â£5 one-time</span>
            <span class="level-desc">Study the full HSK vocabulary set together â€” ideal once you've covered the individual levels.</span>
          </div>
          <div class="level-card-all-arrow">
            Unlock all
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </div>
        </a>

      </div>
    </div>

  </div>
</main>

<footer>
  5,000 words across HSK 1â€“6 &nbsp;Â·&nbsp; Progress saved to your account
</footer>

<!-- â”€â”€ Paywall Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="paywall-backdrop" id="paywallBackdrop" onclick="closePaywall(event)">
  <div class="paywall-modal" id="paywallModal">
    <span class="paywall-char" id="paywallChar">å››</span>
    <div class="paywall-title" id="paywallTitle">HSK 4 â€” Intermediate</div>
    <div class="paywall-desc" id="paywallDesc">600 words Â· Discuss a wide range of topics with native speakers fluently.</div>
    <div class="paywall-price" id="paywallPrice">Â£2</div>
    <div class="paywall-price-note" id="paywallNote">One-time payment Â· Yours forever Â· No subscription</div>
    <div class="paywall-error" id="paywallError"></div>
    <button class="paywall-buy-btn" id="paywallBuyBtn" onclick="startCheckout()">
      Buy now &rarr;
    </button>
    <button class="paywall-cancel" onclick="closePaywallModal()">Maybe later</button>
    <div class="paywall-also" id="paywallAlso"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="supabase-client.js"></script>
<script>

// â”€â”€ Product catalogue (mirrors Edge Function) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRODUCTS = {
  hsk4: { name: 'HSK 4 â€” Intermediate',       price: 'Â£2', char: 'å››', words: '600 words',   desc: 'Intermediate. Discuss a wide range of topics with native speakers fluently.',        note: 'One-time payment Â· Yours forever Â· No subscription' },
  hsk5: { name: 'HSK 5 â€” Upper-Intermediate', price: 'Â£2', char: 'äº”', words: '1,300 words', desc: 'Upper-intermediate. Read newspapers, watch films, and express opinions naturally.',  note: 'One-time payment Â· Yours forever Â· No subscription' },
  hsk6: { name: 'HSK 6 â€” Advanced',           price: 'Â£2', char: 'å…­', words: '2,500 words', desc: 'Advanced. Near-native fluency â€” understand complex written and spoken Chinese.',     note: 'One-time payment Â· Yours forever Â· No subscription' },
  all:  { name: 'All HSK Levels â€” Full Access', price: 'Â£5', char: 'å…¨', words: '5,000 words', desc: 'Complete Mandarin vocabulary. Every word across HSK 1â€“6 in one place.',           note: 'One-time Â· Includes HSK 4, 5, and 6 Â· No subscription' },
};

let _currentProduct = null;

// â”€â”€ Auth + entitlements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUser() {
  if (window._sb) {
    try {
      const { data: { session } } = await window._sb.auth.getSession();
      if (!session) {
        const loginPage = location.pathname.endsWith('.html') ? 'login.html' : '/login';
        window.location.href = loginPage; return;
      }
      const user = {
        name:   session.user.user_metadata?.full_name  || session.user.email?.split('@')[0] || 'Learner',
        avatar: session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture || null,
      };
      document.getElementById('userName').textContent = user.name.split(' ')[0] || '';
      const av = document.getElementById('userAvatar');
      if (user.avatar) {
        av.innerHTML = `<img src="${user.avatar}" alt="${user.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
      } else {
        av.textContent = (user.name?.[0] || 'æ¼¢').toUpperCase();
      }
    } catch {}
  }

  // Check URL for payment return
  const params = new URLSearchParams(location.search);
  if (params.get('payment') === 'success') {
    sbClearEntitlementCache();   // force re-fetch after purchase
    history.replaceState({}, '', location.pathname); // clean URL
  }

  await applyEntitlements();
}

async function applyEntitlements() {
  // Show spinner on locked cards while loading
  let owned = [];
  try { owned = await sbGetEntitlements(); } catch {}

  const hasAll = owned.includes('all');

  document.querySelectorAll('.level-card[data-level]').forEach(card => {
    const level = card.dataset.level;
    const product = card.dataset.product;

    // Free levels â€” always unlocked, no changes needed
    if (!product) return;

    // Check access
    const unlocked = hasAll ||
      (level === 'all' ? ['4','5','6'].every(l => owned.includes(l)) : owned.includes(level));

    if (unlocked) {
      // Unlock the card â€” turn it into a real link
      card.classList.remove('locked');
      card.classList.add('unlocked');
      const badge = card.querySelector('.level-badge');
      if (badge) { badge.className = 'level-badge badge-owned'; badge.textContent = 'âœ“ Owned'; }
      // Set the href properly
      const dest = level === 'all' ? '/app?level=all' : `/app?level=${level}`;
      card.setAttribute('href', dest);
      card.onclick = null;
    } else {
      // Keep locked â€” attach paywall click handler
      card.onclick = (e) => { e.preventDefault(); openPaywall(product); };
    }
  });
}

async function signOut() {
  if (window._sb) await sbSignOut();
  const loginPage = location.pathname.endsWith('.html') ? 'login.html' : '/login';
  window.location.href = loginPage;
}

// â”€â”€ Paywall modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPaywall(productKey) {
  _currentProduct = productKey;
  const p = PRODUCTS[productKey];
  if (!p) return;

  document.getElementById('paywallChar').textContent  = p.char;
  document.getElementById('paywallTitle').textContent = p.name;
  document.getElementById('paywallDesc').textContent  = p.words + ' Â· ' + p.desc;
  document.getElementById('paywallPrice').textContent = p.price;
  document.getElementById('paywallNote').textContent  = p.note;
  document.getElementById('paywallError').style.display = 'none';

  // "Also available" hint â€” if buying individual, mention the Â£5 bundle
  const alsoEl = document.getElementById('paywallAlso');
  if (productKey !== 'all') {
    alsoEl.innerHTML = `Or get <a onclick="openPaywall('all')">all levels for Â£5</a> â€” save Â£1 per level.`;
  } else {
    alsoEl.textContent = '';
  }

  document.getElementById('paywallBuyBtn').disabled = false;
  document.getElementById('paywallBuyBtn').textContent = 'Buy now â†’';
  document.getElementById('paywallBackdrop').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closePaywallModal() {
  document.getElementById('paywallBackdrop').classList.remove('open');
  document.body.style.overflow = '';
  _currentProduct = null;
}

function closePaywall(e) {
  if (e.target === document.getElementById('paywallBackdrop')) closePaywallModal();
}

// Close on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePaywallModal(); });

async function startCheckout() {
  if (!_currentProduct) return;
  const btn = document.getElementById('paywallBuyBtn');
  const errEl = document.getElementById('paywallError');
  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Redirecting to checkoutâ€¦';

  try {
    const url = await sbBuyLevel(_currentProduct);
    window.location.href = url;   // hand off to Stripe-hosted checkout
  } catch (err) {
    errEl.textContent = err.message || 'Something went wrong. Please try again.';
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Buy now â†’';
  }
}

loadUser();
</script>
</body>
</html>
