<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HSK Flashcards</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Noto+Serif+SC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f0ebe0; --cream-dark: #e5dfd2; --cream-mid: #ede8dc;
    --gold: #8b6914; --gold-light: #c4a035; --red: #8b1a1a; --red-light: #c0392b;
    --ink: #2c2416; --ink-light: #5a4e3a; --ink-muted: #8a7a62;
    --green: #2d5a3d; --blue: #1a3a5c; --card-bg: #faf7f2; --border: rgba(139,105,20,0.2);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'EB Garamond', Georgia, serif; background: var(--cream); color: var(--ink); min-height: 100vh; background-image: radial-gradient(ellipse at 20% 50%, rgba(139,105,20,0.04) 0%, transparent 60%), radial-gradient(ellipse at 80% 20%, rgba(139,26,26,0.03) 0%, transparent 50%); }
  header { background: var(--cream); border-bottom: 1px solid var(--border); padding: 0 48px; display: flex; align-items: center; justify-content: space-between; height: 70px; position: sticky; top: 0; z-index: 100; }
  .logo { display: flex; align-items: center; gap: 14px; }
  .logo-char { font-family: 'Noto Serif SC', serif; font-size: 36px; color: var(--red); font-weight: 700; line-height: 1; }
  .logo-text { font-size: 12px; letter-spacing: 0.25em; color: var(--ink-muted); text-transform: uppercase; }
  .header-stats { display: flex; gap: 40px; }
  .stat { text-align: center; }
  .stat-num { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 600; color: var(--ink); line-height: 1; }
  .stat-label { font-size: 10px; letter-spacing: 0.18em; color: var(--ink-muted); text-transform: uppercase; margin-top: 2px; }
  .script-toggle { display: flex; background: var(--cream-dark); border-radius: 40px; padding: 4px; border: 1px solid var(--border); }
  .script-btn { background: none; border: none; font-family: 'EB Garamond', serif; font-size: 13px; letter-spacing: 0.08em; padding: 6px 16px; border-radius: 30px; cursor: pointer; color: var(--ink-muted); transition: all 0.25s; }
  .script-btn.active { background: var(--card-bg); color: var(--gold); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .user-area { display: flex; align-items: center; gap: 10px; }
  .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border); object-fit: cover; background: var(--cream-dark); display: flex; align-items: center; justify-content: center; font-family: 'Noto Serif SC', serif; font-size: 14px; color: var(--gold); overflow: hidden; }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-name { font-size: 14px; color: var(--ink-light); max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .logout-btn { border: 1px solid var(--border); background: none; border-radius: 30px; padding: 5px 14px; font-family: 'EB Garamond', serif; font-size: 13px; color: var(--ink-muted); cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em; }
  .logout-btn:hover { border-color: var(--red); color: var(--red); }
  nav { border-bottom: 1px solid var(--border); padding: 0 48px; display: flex; align-items: center; gap: 6px; background: var(--cream); flex-wrap: wrap; }
  .nav-label { font-size: 11px; letter-spacing: 0.2em; color: var(--ink-muted); text-transform: uppercase; margin-right: 10px; }
  .level-btn { border: 1px solid transparent; background: none; padding: 10px 18px; font-family: 'EB Garamond', serif; font-size: 14px; cursor: pointer; color: var(--ink-light); border-radius: 4px; transition: all 0.2s; margin: 8px 2px; }
  .level-btn:hover { border-color: var(--border); }
  .level-btn.active { background: var(--gold); color: #fff; border-color: var(--gold); }
  main { max-width: 740px; margin: 0 auto; padding: 36px 24px 60px; }
  .progress-counters { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .counter-pill { display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); border-radius: 30px; padding: 6px 18px; font-size: 14px; color: var(--ink-light); background: var(--card-bg); }
  .counter-dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot-red { background: var(--red-light); } .dot-blue { background: var(--blue); } .dot-green { background: var(--green); }
  .progress-bar-wrap { height: 6px; background: var(--cream-dark); border-radius: 3px; margin-bottom: 32px; overflow: hidden; }
  .progress-bar { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--red) 0%, var(--gold) 100%); transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
  .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; padding: 40px 44px; box-shadow: 0 4px 24px rgba(44,36,22,0.06); animation: fadeSlide 0.35s ease; }
  @keyframes fadeSlide { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .hsk-badge { display: inline-block; font-size: 10px; letter-spacing: 0.15em; border: 1px solid var(--gold-light); color: var(--gold); padding: 2px 8px; border-radius: 2px; margin-bottom: 12px; }
  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 20px; }
  .card-chinese { font-family: 'Noto Serif SC', serif; font-size: 56px; color: var(--ink); font-weight: 400; line-height: 1.1; }
  .card-alt-label { font-size: 13px; color: var(--ink-muted); margin-top: 6px; }
  .card-alt-label span { font-family: 'Noto Serif SC', serif; font-size: 15px; color: var(--ink-light); }
  .card-right { text-align: right; flex-shrink: 0; }
  .card-pinyin { font-family: 'Playfair Display', serif; font-size: 22px; font-style: italic; color: var(--red); }
  .card-meaning { font-size: 16px; color: var(--ink-light); margin-top: 4px; max-width: 220px; }
  .card-divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
  .speak-row { display: flex; gap: 10px; margin-bottom: 24px; }
  .speak-btn { display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); background: none; border-radius: 3px; padding: 9px 18px; font-family: 'EB Garamond', serif; font-size: 15px; color: var(--ink-light); cursor: pointer; transition: all 0.2s; }
  .speak-btn:hover { background: var(--cream-dark); color: var(--ink); }
  .speak-icon { width: 18px; height: 18px; }
  .section-label { font-size: 10px; letter-spacing: 0.25em; color: var(--ink-muted); text-transform: uppercase; text-align: center; display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .section-label::before, .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .chars-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 32px; }
  .char-tile { border: 1px solid var(--border); border-radius: 3px; padding: 12px 18px; text-align: center; background: var(--card-bg); min-width: 66px; transition: all 0.2s; }
  .char-tile:hover { border-color: var(--gold-light); box-shadow: 0 2px 8px rgba(139,105,20,0.1); }
  .char-tile-char { font-family: 'Noto Serif SC', serif; font-size: 30px; color: var(--ink); display: block; }
  .recall-row { display: flex; gap: 10px; }
  .recall-btn { flex: 1; border: 1px solid var(--border); background: none; padding: 12px 10px; border-radius: 3px; font-family: 'EB Garamond', serif; cursor: pointer; transition: all 0.22s; color: var(--ink-light); }
  .recall-btn .recall-label { font-size: 11px; display: block; color: var(--ink-muted); margin-bottom: 2px; letter-spacing: 0.12em; }
  .recall-btn .recall-name { font-size: 15px; }
  .recall-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(44,36,22,0.1); }
  .recall-again:hover { border-color: var(--red-light); color: var(--red); background: rgba(139,26,26,0.03); }
  .recall-good:hover { border-color: var(--blue); color: var(--blue); background: rgba(26,58,92,0.03); }
  .recall-perfect:hover { border-color: var(--green); color: var(--green); background: rgba(45,90,61,0.03); }
  .loading { text-align: center; padding: 80px; }
  .loading-char { font-family: 'Noto Serif SC', serif; font-size: 56px; color: var(--gold); animation: pulse 1.5s ease infinite; }
  @keyframes pulse { 0%,100%{opacity:.3} 50%{opacity:1} }
  .loading-text { color: var(--ink-muted); font-size: 15px; margin-top: 12px; font-style: italic; }
  .done-state { text-align: center; padding: 60px 40px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; animation: fadeSlide 0.4s ease; }
  .done-char { font-family: 'Noto Serif SC', serif; font-size: 72px; color: var(--gold); margin-bottom: 16px; }
  .done-title { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--ink); margin-bottom: 10px; }
  .done-subtitle { color: var(--ink-muted); font-size: 16px; font-style: italic; }
  .restart-btn { margin-top: 28px; border: 1px solid var(--gold); background: none; padding: 12px 32px; border-radius: 3px; font-family: 'EB Garamond', serif; font-size: 16px; color: var(--gold); cursor: pointer; letter-spacing: 0.08em; transition: all 0.2s; }
  .restart-btn:hover { background: var(--gold); color: #fff; }

  /* â”€â”€ Daily Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .daily-bar-section {
    position: relative;
    margin-bottom: 28px;
  }
  .daily-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 10px;
  }
  .daily-bar-label {
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }
  .daily-bar-count {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    color: var(--ink-light);
    transition: color 0.6s ease;
  }
  .daily-bar-count.complete { color: #2d7a4f; font-weight: 600; }

  .daily-bar-track {
    height: 10px;
    background: var(--cream-dark);
    border-radius: 99px;
    overflow: visible;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(44,36,22,0.08);
  }
  .daily-bar-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
    transition: width 0.7s cubic-bezier(0.4, 0, 0.2, 1), background 0.8s ease;
    position: relative;
    min-width: 0;
    box-shadow: 0 1px 4px rgba(139,105,20,0.35);
  }
  .daily-bar-fill.complete {
    background: linear-gradient(90deg, #2d7a4f 0%, #4aaa76 100%);
    box-shadow: 0 1px 8px rgba(45,122,79,0.4);
  }
  /* Shimmer animation while in progress */
  .daily-bar-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 99px;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    background-size: 200% 100%;
    animation: shimmer 2.2s ease infinite;
  }
  .daily-bar-fill.complete::after { display: none; }
  @keyframes shimmer {
    0%   { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }
  /* Glowing dot at the tip */
  .daily-bar-fill::before {
    content: '';
    position: absolute;
    right: -1px;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--gold-light);
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px var(--gold-light), 0 2px 6px rgba(139,105,20,0.4);
    transition: background 0.8s ease, box-shadow 0.8s ease;
    opacity: 1;
  }
  .daily-bar-fill.complete::before {
    background: #4aaa76;
    box-shadow: 0 0 0 2px #4aaa76, 0 2px 8px rgba(45,122,79,0.5);
  }
  /* Hide dot when bar is empty */
  .daily-bar-fill[style*="width: 0"]::before,
  .daily-bar-fill[style*="width:0"]::before { opacity: 0; }

  /* Milestone ticks */
  .daily-bar-ticks {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 10px;
    pointer-events: none;
  }
  .daily-bar-tick {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background: rgba(255,255,255,0.5);
  }

  /* â”€â”€ Toast Notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #fff;
    border-radius: 16px;
    padding: 18px 28px 18px 22px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow:
      0 8px 32px rgba(44,36,22,0.14),
      0 2px 8px rgba(44,36,22,0.08),
      0 0 0 1px rgba(45,122,79,0.15);
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.2,0.8,0.3,1);
    max-width: 420px;
    width: calc(100vw - 48px);
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }
  .toast-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2d7a4f 0%, #4aaa76 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    animation: toastPop 0.5s cubic-bezier(0.2,0.8,0.3,1) 0.1s both;
  }
  @keyframes toastPop {
    from { transform: scale(0.5); opacity: 0; }
    to   { transform: scale(1);   opacity: 1; }
  }
  .toast-icon svg { width: 22px; height: 22px; stroke: #fff; }
  .toast-body { flex: 1; min-width: 0; }
  .toast-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    color: #1a3a2a;
    font-weight: 600;
    margin-bottom: 3px;
  }
  .toast-msg {
    font-family: 'EB Garamond', serif;
    font-size: 14px;
    color: #5a7a68;
    line-height: 1.4;
  }
  .toast-close {
    background: none;
    border: none;
    cursor: pointer;
    color: #aaa;
    padding: 4px;
    border-radius: 50%;
    transition: color 0.2s;
    flex-shrink: 0;
    line-height: 1;
  }
  .toast-close:hover { color: #555; }

  /* Confetti burst */
  .confetti-canvas {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9998;
  }

  @media (max-width: 600px) {
    header { padding: 12px 16px; height: auto; flex-wrap: wrap; gap: 10px; }
    nav { padding: 0 16px; } main { padding: 20px 12px; }
    .card { padding: 24px 18px; } .card-chinese { font-size: 40px; }
    .header-stats { gap: 20px; } .recall-label { display: none !important; }
    .toast { bottom: 20px; }
  }
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-char">æ¼¢</div>
    <div class="logo-text">HSK Flashcards</div>
  </div>
  <div class="header-stats">
    <div class="stat"><div class="stat-num" id="statDue">â€”</div><div class="stat-label">Due Today</div></div>
    <div class="stat"><div class="stat-num" id="statReviewed">0</div><div class="stat-label">Reviewed</div></div>
    <div class="stat"><div class="stat-num" id="statStreak">1</div><div class="stat-label">Streak</div></div>
  </div>
  <div class="script-toggle">
    <button class="script-btn active" onclick="setScript('simplified',this)">Simplified</button>
    <button class="script-btn" onclick="setScript('traditional',this)">Traditional</button>
  </div>
  <div class="user-area">
    <div class="user-avatar" id="userAvatar">æ¼¢</div>
    <span class="user-name" id="userName"></span>
    <button class="logout-btn" onclick="logout()">Sign out</button>
  </div>
</header>
<nav>
  <span class="nav-label">Level:</span>
  <button class="level-btn active" onclick="setLevel('all',this)">All HSK</button>
  <button class="level-btn" onclick="setLevel(1,this)">HSK 1</button>
  <button class="level-btn" onclick="setLevel(2,this)">HSK 2</button>
  <button class="level-btn" onclick="setLevel(3,this)">HSK 3</button>
  <button class="level-btn" onclick="setLevel(4,this)">HSK 4</button>
  <button class="level-btn" onclick="setLevel(5,this)">HSK 5</button>
  <button class="level-btn" onclick="setLevel(6,this)">HSK 6</button>
</nav>
<main>
  <!-- Daily Progress Bar -->
  <div class="daily-bar-section">
    <div class="daily-bar-header">
      <span class="daily-bar-label">Daily Target</span>
      <span class="daily-bar-count" id="dailyBarCount">0 / 20 cards</span>
    </div>
    <div class="daily-bar-track">
      <div class="daily-bar-fill" id="dailyBarFill" style="width:0%"></div>
      <div class="daily-bar-ticks" id="dailyBarTicks"></div>
    </div>
  </div>

  <div class="progress-counters">
    <div class="counter-pill"><span class="counter-dot dot-red"></span><span id="countNew">â€”</span> New</div>
    <div class="counter-pill"><span class="counter-dot dot-blue"></span><span id="countReview">0</span> Review</div>
    <div class="counter-pill"><span class="counter-dot dot-green"></span><span id="countDone">0</span> Done</div>
  </div>
  <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
  <div id="cardContainer">
    <div class="loading"><div class="loading-char">æ¼¢</div><div class="loading-text">Loading 5,000 wordsâ€¦</div></div>
  </div>
</main>

<!-- Toast notification -->
<div class="toast" id="toast" role="alert" aria-live="polite">
  <div class="toast-icon">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20 6L9 17l-5-5"/>
    </svg>
  </div>
  <div class="toast-body">
    <div class="toast-title">Daily target reached! ğŸ‰</div>
    <div class="toast-msg">Well done â€” your daily target is met! Now keep going!</div>
  </div>
  <button class="toast-close" onclick="dismissToast()" aria-label="Dismiss">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
  </button>
</div>
<canvas class="confetti-canvas" id="confettiCanvas"></canvas>
<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allVocab=[], script='simplified', currentLevel='all';
let queue=[], doneCount=0, reviewCount=0, reviewed=0, cardsCorrect=0, currentCard=null;

// â”€â”€â”€ Daily Target â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAILY_TARGET_DEFAULT = 20;
let dailyTarget = DAILY_TARGET_DEFAULT;
let dailyDone   = 0;          // cards completed today (correct only = good + perfect)
let targetNotified = false;   // only fire the toast once per session

function initDailyBar(target) {
  dailyTarget = target || DAILY_TARGET_DEFAULT;
  // Draw milestone ticks at 25%, 50%, 75%
  const ticks = document.getElementById('dailyBarTicks');
  ticks.innerHTML = [25, 50, 75].map(p =>
    `<div class="daily-bar-tick" style="left:${p}%"></div>`
  ).join('');
  updateDailyBar();
}

function updateDailyBar() {
  const pct  = Math.min(100, (dailyDone / dailyTarget) * 100);
  const fill = document.getElementById('dailyBarFill');
  const lbl  = document.getElementById('dailyBarCount');
  const done = pct >= 100;

  fill.style.width = pct + '%';
  fill.classList.toggle('complete', done);
  lbl.classList.toggle('complete', done);
  lbl.textContent = `${dailyDone} / ${dailyTarget} cards${done ? ' âœ“' : ''}`;

  if (done && !targetNotified) {
    targetNotified = true;
    setTimeout(showToast, 400);   // slight delay so bar animation finishes first
  }
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;

function showToast() {
  const el = document.getElementById('toast');
  el.classList.add('show');
  launchConfetti();
  clearTimeout(toastTimer);
  toastTimer = setTimeout(dismissToast, 6000);
}

function dismissToast() {
  document.getElementById('toast').classList.remove('show');
  clearTimeout(toastTimer);
}

// â”€â”€â”€ Confetti burst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchConfetti() {
  const canvas = document.getElementById('confettiCanvas');
  const ctx    = canvas.getContext('2d');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;

  const COLOURS = ['#8b6914','#c4a035','#2d7a4f','#4aaa76','#8b1a1a','#f0ebe0','#1a3a5c'];
  const pieces  = Array.from({ length: 90 }, () => ({
    x:   Math.random() * canvas.width,
    y:   Math.random() * canvas.height * 0.4 - canvas.height * 0.2,
    r:   4 + Math.random() * 5,
    d:   1.5 + Math.random() * 2.5,
    c:   COLOURS[Math.floor(Math.random() * COLOURS.length)],
    t:   Math.random() * Math.PI * 2,
    s:   (Math.random() - 0.5) * 3,
    rot: Math.random() * Math.PI,
    rsp: (Math.random() - 0.5) * 0.1,
  }));

  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.globalAlpha = Math.max(0, 1 - frame / 140);
      ctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r * 0.5);
      ctx.restore();
      p.y   += p.d;
      p.x   += p.s;
      p.rot += p.rsp;
      p.t   += 0.05;
    });
    frame++;
    if (frame < 150) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

// â”€â”€â”€ Session Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sessionId=null, sessionStart=null, levelBreakdown={};

async function startSession(){
  sessionStart = Date.now();
  levelBreakdown = {};
  cardsCorrect = 0;
  try {
    const res = await fetch('/api/session/start', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ level: currentLevel })
    });
    const data = await res.json();
    sessionId = data.sessionId;
  } catch(e){ sessionId = null; }
}

async function endSession(){
  if(!sessionStart) return;
  const duration = Math.round((Date.now() - sessionStart) / 1000);
  try {
    await fetch('/api/session/end', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        sessionId,
        cardsReviewed: reviewed,
        cardsCorrect,
        durationSeconds: duration,
        levelBreakdown,
      })
    });
  } catch(e){}
  sessionId=null; sessionStart=null;
}

// End session on page close
window.addEventListener('beforeunload', () => {
  if(sessionStart && reviewed > 0) {
    const duration = Math.round((Date.now()-sessionStart)/1000);
    navigator.sendBeacon('/api/session/end', JSON.stringify({
      sessionId, cardsReviewed:reviewed, cardsCorrect, durationSeconds:duration, levelBreakdown
    }));
  }
});

// â”€â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVocab(){
  try {
    const res = await fetch('/app-assets/vocab.json');
    allVocab = await res.json();
    initQueue();
  } catch(e) {
    document.getElementById('cardContainer').innerHTML='<div class="done-state"><div class="done-char">ï¼</div><div class="done-title">Could not load vocabulary</div><div class="done-subtitle">Make sure the server is running: <code>npm start</code></div></div>';
  }
}

async function loadUser(){
  try {
    const res = await fetch('/auth/me');
    if (!res.ok) { window.location.href='/login'; return; }
    const user = await res.json();
    document.getElementById('userName').textContent = user.name?.split(' ')[0] || '';
    const avatarEl = document.getElementById('userAvatar');
    if (user.avatar) {
      avatarEl.innerHTML = `<img src="${user.avatar}" alt="${user.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    } else {
      avatarEl.textContent = (user.name?.[0] || 'æ¼¢').toUpperCase();
    }
  } catch { window.location.href='/login'; return; }

  // Load progress to seed daily bar
  try {
    const res = await fetch('/api/progress');
    if (!res.ok) { initDailyBar(20); return; }
    const { progress } = await res.json();

    // Daily target = weeklyTarget / 7, rounded up, minimum 5
    const weeklyTarget = progress?.weeklyTarget || 140;
    const target = Math.max(5, Math.ceil(weeklyTarget / 7));

    // Cards done today = weeklyProgress if weekStart is this week, else 0
    // We use today's session count from the server â€” fall back to 0 for new users
    const todayStr = new Date().toISOString().split('T')[0];
    const weekStart = progress?.weekStart;
    // weeklyProgress resets each Monday â€” use it as a rough today proxy
    // For a precise "today" count we'd need a daily sub-collection; for now
    // seed from 0 each page load (Firebase tracks the real total)
    dailyDone = 0;
    targetNotified = false;
    initDailyBar(target);
  } catch {
    initDailyBar(20);
  }
}

async function logout(){
  await endSession();
  await fetch('/auth/logout', { method:'POST' });
  window.location.href='/login';
}

// â”€â”€â”€ Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initQueue(){
  await endSession(); // close previous session if any
  queue = (currentLevel==='all' ? [...allVocab] : allVocab.filter(v=>v.h===currentLevel)).sort(()=>Math.random()-0.5);
  doneCount=0; reviewCount=0; reviewed=0; cardsCorrect=0; levelBreakdown={};
  updateStats();
  await startSession();
  showNext();
}

function setLevel(l,btn){
  currentLevel = l==='all'?'all':parseInt(l);
  document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(allVocab.length) initQueue();
}

function setScript(s,btn){
  script=s;
  document.querySelectorAll('.script-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(currentCard) renderCard(currentCard);
}

function updateStats(){
  const total=queue.length+doneCount;
  document.getElementById('statDue').textContent=queue.length;
  document.getElementById('countNew').textContent=Math.max(0,queue.length-reviewCount);
  document.getElementById('countReview').textContent=reviewCount;
  document.getElementById('countDone').textContent=doneCount;
  document.getElementById('statReviewed').textContent=reviewed;
  document.getElementById('progressBar').style.width=(total>0?(doneCount/total*100):0)+'%';
}

// â”€â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNext(){
  if(!queue.length){showDone();return;}
  currentCard=queue[0]; renderCard(currentCard);
}

function renderCard(card){
  const isTrad=script==='traditional';
  const chinese=isTrad?card.t:card.s;
  const alt=isTrad?card.s:card.t;
  const showAlt=alt!==chinese;
  const chars=[...chinese];
  const charsHTML=chars.length>1?`
    <div class="section-label">Character Breakdown</div>
    <div class="chars-grid">${chars.map(c=>`<div class="char-tile"><span class="char-tile-char">${c}</span></div>`).join('')}</div>`:'';

  document.getElementById('cardContainer').innerHTML=`
    <div class="card">
      <div class="hsk-badge">HSK ${card.h}</div>
      <div class="card-top">
        <div>
          <div class="card-chinese">${chinese}</div>
          ${showAlt?`<div class="card-alt-label">${isTrad?'Simplified':'Traditional'}: <span>${alt}</span></div>`:''}
        </div>
        <div class="card-right">
          <div class="card-pinyin">${card.p}</div>
          <div class="card-meaning">${card.m}</div>
        </div>
      </div>
      <hr class="card-divider">
      <div class="speak-row">
        <button class="speak-btn" onclick="speakWord()">
          <svg class="speak-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15.536 8.464a5 5 0 010 7.072M9 9.5l-2 1.5H4v3h3l2 1.5V9.5z" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Speak word
        </button>
        <button class="speak-btn" onclick="speakPinyin()">
          <svg class="speak-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 8v4M12 16h.01" stroke-linecap="round"/></svg>
          Pinyin hint
        </button>
        <a href="/dashboard" class="speak-btn" style="text-decoration:none">
          <svg class="speak-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          My Stats
        </a>
      </div>
      ${charsHTML}
      <div class="recall-row">
        <button class="recall-btn recall-again" onclick="recall('again')"><span class="recall-label">AGAIN</span><span class="recall-name">Tomorrow</span></button>
        <button class="recall-btn recall-good" onclick="recall('good')"><span class="recall-label">GOOD</span><span class="recall-name">Recall</span></button>
        <button class="recall-btn recall-perfect" onclick="recall('perfect')"><span class="recall-label">PERFECT</span><span class="recall-name">Recall</span></button>
      </div>
    </div>`;
}

function recall(type){
  if(!currentCard) return;
  const cardLevel = currentCard.h;
  levelBreakdown[cardLevel] = (levelBreakdown[cardLevel]||0) + 1;
  queue.shift(); reviewed++;
  if(type==='again'){
    queue.splice(Math.min(queue.length,5+Math.floor(Math.random()*5)),0,currentCard);
    reviewCount++;
  } else {
    doneCount++;
    if(type==='good'||type==='perfect'){
      cardsCorrect++;
      dailyDone++;
      updateDailyBar();
    }
  }
  updateStats(); showNext();
}

// â”€â”€â”€ Speech â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function speakWord(){
  if(!currentCard||!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const utt=new SpeechSynthesisUtterance(script==='traditional'?currentCard.t:currentCard.s);
  utt.lang='zh-CN'; utt.rate=0.8; speechSynthesis.speak(utt);
}

function speakPinyin(){
  if(!currentCard||!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const utt=new SpeechSynthesisUtterance(currentCard.p);
  utt.lang='en-US'; utt.rate=0.75; speechSynthesis.speak(utt);
}

// â”€â”€â”€ Done screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showDone(){
  await endSession();
  currentCard=null;
  const lvl=currentLevel==='all'?'All HSK':`HSK ${currentLevel}`;
  const accuracy=reviewed>0?Math.round((cardsCorrect/reviewed)*100):0;
  document.getElementById('cardContainer').innerHTML=`
    <div class="done-state">
      <div class="done-char">å®Œ</div>
      <div class="done-title">Session Complete!</div>
      <div class="done-subtitle">
        You reviewed <strong>${reviewed}</strong> ${lvl} card${reviewed!==1?'s':''} with <strong>${accuracy}%</strong> accuracy. å¾ˆå¥½ï¼
      </div>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px">
        <button class="restart-btn" onclick="initQueue()">Study Again</button>
        <a href="/dashboard" class="restart-btn" style="text-decoration:none">View Stats</a>
      </div>
    </div>`;
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadUser();
loadVocab();
</script>
</body>
</html>
