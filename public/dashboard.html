<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Stats â€” HSK Flashcards</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #f0ebe0; --cream-dark: #e5dfd2; --cream-mid: #ede8dc;
    --gold: #8b6914; --gold-light: #c4a035; --red: #8b1a1a; --red-light: #c0392b;
    --ink: #2c2416; --ink-light: #5a4e3a; --ink-muted: #8a7a62;
    --green: #2d5a3d; --green-light: #4a9062; --blue: #1a3a5c;
    --card-bg: #faf7f2; --border: rgba(139,105,20,0.2);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'EB Garamond', Georgia, serif; background: var(--cream); color: var(--ink); min-height: 100vh; }

  /* HEADER */
  header { background: var(--cream); border-bottom: 1px solid var(--border); padding: 0 48px; display: flex; align-items: center; justify-content: space-between; height: 70px; position: sticky; top: 0; z-index: 10; }
  .logo { display: flex; align-items: center; gap: 14px; text-decoration: none; color: inherit; }
  .logo-char { font-family: 'Noto Serif SC', serif; font-size: 34px; color: var(--red); font-weight: 700; line-height: 1; }
  .logo-text { font-size: 12px; letter-spacing: 0.25em; color: var(--ink-muted); text-transform: uppercase; }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .back-btn { display: flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: none; border-radius: 3px; padding: 8px 16px; font-family: 'EB Garamond', serif; font-size: 14px; color: var(--ink-light); cursor: pointer; text-decoration: none; transition: all 0.2s; }
  .back-btn:hover { border-color: var(--gold); color: var(--gold); }
  .user-chip { display: flex; align-items: center; gap: 8px; }
  .user-avatar { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border); background: var(--cream-dark); display: flex; align-items: center; justify-content: center; font-size: 13px; color: var(--gold); overflow: hidden; font-family: 'Noto Serif SC', serif; }
  .user-name { font-size: 14px; color: var(--ink-light); }

  /* MAIN */
  main { max-width: 900px; margin: 0 auto; padding: 40px 24px 80px; }

  .page-title { font-family: 'Playfair Display', serif; font-size: 32px; color: var(--ink); margin-bottom: 4px; }
  .page-sub { font-size: 16px; color: var(--ink-muted); font-style: italic; margin-bottom: 36px; }

  /* GRID */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; padding: 22px 20px; }
  .stat-card-label { font-size: 10px; letter-spacing: 0.2em; color: var(--ink-muted); text-transform: uppercase; margin-bottom: 8px; }
  .stat-card-value { font-family: 'Playfair Display', serif; font-size: 34px; color: var(--ink); line-height: 1; }
  .stat-card-sub { font-size: 13px; color: var(--ink-muted); margin-top: 4px; font-style: italic; }
  .stat-card.highlight { border-color: var(--gold-light); background: linear-gradient(135deg, var(--card-bg) 0%, rgba(196,160,53,0.05) 100%); }
  .stat-card.highlight .stat-card-value { color: var(--gold); }

  /* SECTION */
  .section { margin-bottom: 28px; }
  .section-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--ink); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* WEEKLY TARGET */
  .target-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; padding: 28px 28px 24px; }
  .target-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 20px; }
  .target-label { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 6px; }
  .target-progress-text { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--ink); }
  .target-pct { font-size: 15px; color: var(--ink-muted); margin-top: 2px; font-style: italic; }
  .target-form { display: flex; align-items: center; gap: 10px; }
  .target-input { border: 1px solid var(--border); background: var(--cream); border-radius: 3px; padding: 8px 12px; font-family: 'EB Garamond', serif; font-size: 15px; color: var(--ink); width: 90px; text-align: center; }
  .target-input:focus { outline: none; border-color: var(--gold); }
  .target-save { border: 1px solid var(--gold); background: none; border-radius: 3px; padding: 8px 18px; font-family: 'EB Garamond', serif; font-size: 15px; color: var(--gold); cursor: pointer; transition: all 0.2s; }
  .target-save:hover { background: var(--gold); color: #fff; }
  .progress-track { height: 10px; background: var(--cream-dark); border-radius: 5px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--green) 0%, var(--green-light) 100%); transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }

  /* HSK BREAKDOWN */
  .levels-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
  .level-stat { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; padding: 16px 12px; text-align: center; transition: all 0.2s; }
  .level-stat:hover { border-color: var(--gold-light); }
  .level-stat.top-level { border-color: var(--gold-light); background: linear-gradient(135deg, var(--card-bg) 0%, rgba(196,160,53,0.07) 100%); }
  .level-stat-badge { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink-muted); margin-bottom: 6px; }
  .level-stat-char { font-family: 'Noto Serif SC', serif; font-size: 22px; color: var(--ink); margin-bottom: 4px; }
  .level-stat-num { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--gold); line-height: 1; }
  .level-stat-sub { font-size: 11px; color: var(--ink-muted); margin-top: 3px; }
  .level-bar { height: 4px; background: var(--cream-dark); border-radius: 2px; margin-top: 10px; overflow: hidden; }
  .level-bar-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%); transition: width 1s ease; }

  /* RECENT SESSIONS */
  .sessions-table { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
  .sessions-header { display: grid; grid-template-columns: 1fr 100px 90px 90px 90px; gap: 8px; padding: 12px 20px; border-bottom: 1px solid var(--border); font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--ink-muted); }
  .session-row { display: grid; grid-template-columns: 1fr 100px 90px 90px 90px; gap: 8px; padding: 14px 20px; border-bottom: 1px solid rgba(139,105,20,0.08); font-size: 15px; color: var(--ink-light); transition: background 0.15s; }
  .session-row:last-child { border-bottom: none; }
  .session-row:hover { background: var(--cream-mid); }
  .session-level { font-weight: 500; color: var(--gold); }
  .session-accurate { color: var(--green); }
  .empty-state { text-align: center; padding: 48px; color: var(--ink-muted); font-style: italic; font-size: 16px; }

  /* LOADING */
  .loading-overlay { text-align: center; padding: 80px; }
  .loading-char { font-family: 'Noto Serif SC', serif; font-size: 48px; color: var(--gold); animation: pulse 1.5s ease infinite; }
  @keyframes pulse { 0%,100%{opacity:.3} 50%{opacity:1} }
  .loading-text { color: var(--ink-muted); font-size: 15px; margin-top: 12px; font-style: italic; }

  /* STREAK */
  .streak-flame { font-size: 28px; line-height: 1; }

  @media(max-width:700px){
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .levels-grid { grid-template-columns: repeat(3,1fr); }
    header { padding: 0 16px; }
    main { padding: 24px 12px; }
    .sessions-header, .session-row { grid-template-columns: 1fr 80px 70px; }
    .session-row > *:nth-child(4), .session-row > *:nth-child(5),
    .sessions-header > *:nth-child(4), .sessions-header > *:nth-child(5) { display: none; }
  }
</style>
</head>
<body>
<header>
  <a href="/app" class="logo">
    <div class="logo-char">æ¼¢</div>
    <div class="logo-text">HSK Flashcards</div>
  </a>
  <div class="header-right">
    <a href="/app" class="back-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Study
    </a>
    <div class="user-chip">
      <div class="user-avatar" id="userAvatar">æ¼¢</div>
      <span class="user-name" id="userName"></span>
    </div>
  </div>
</header>

<main>
  <div id="content">
    <div class="loading-overlay">
      <div class="loading-char">æ¼¢</div>
      <div class="loading-text">Loading your statsâ€¦</div>
    </div>
  </div>
</main>

<script>
const LEVEL_CHARS = { 1:'ä¸€', 2:'äºŒ', 3:'ä¸‰', 4:'å››', 5:'äº”', 6:'å…­' };
const LEVEL_SIZES = { 1:150, 2:150, 3:299, 4:601, 5:1300, 6:2500 };

function fmt(seconds) {
  if (!seconds) return '0m';
  const h = Math.floor(seconds/3600);
  const m = Math.floor((seconds%3600)/60);
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

function fmtDate(ts) {
  if (!ts) return 'â€”';
  const d = ts._seconds ? new Date(ts._seconds*1000) : new Date(ts);
  return d.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
}

function fmtTime(ts) {
  if (!ts) return 'â€”';
  const d = ts._seconds ? new Date(ts._seconds*1000) : new Date(ts);
  return d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
}

async function loadUser() {
  try {
    const res = await fetch('/auth/me');
    if (!res.ok) { window.location.href='/login'; return; }
    const user = await res.json();
    document.getElementById('userName').textContent = user.name?.split(' ')[0] || '';
    const el = document.getElementById('userAvatar');
    if (user.avatar) el.innerHTML=`<img src="${user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    else el.textContent = (user.name?.[0]||'æ¼¢').toUpperCase();
  } catch { window.location.href='/login'; }
}

async function loadStats() {
  try {
    const res  = await fetch('/api/progress');
    const data = await res.json();
    render(data);
  } catch(e) {
    document.getElementById('content').innerHTML = `<div class="empty-state">Could not load stats. Make sure the server and Firebase are configured.</div>`;
  }
}

function render({ progress, user, sessions, topLevel }) {
  const ls       = progress?.levelStats || {};
  const allStats = ls['all'] || { reviewed:0, correct:0, time:0 };
  const accuracy = allStats.reviewed > 0 ? Math.round((allStats.correct/allStats.reviewed)*100) : 0;
  const streak   = progress?.dailyStreak || 0;
  const weekly   = progress?.weeklyProgress || 0;
  const target   = progress?.weeklyTarget || 100;
  const weekPct  = Math.min(100, Math.round((weekly/target)*100));

  // Top level bar chart: find max reviewed for relative scaling
  const levelReviews = [1,2,3,4,5,6].map(l => (ls[String(l)]||{}).reviewed||0);
  const maxReviews   = Math.max(...levelReviews, 1);
  const topLevelKey  = topLevel?.level;

  // Level breakdown cards
  const levelsHTML = [1,2,3,4,5,6].map(l => {
    const s   = ls[String(l)] || { reviewed:0, correct:0, time:0 };
    const pct = Math.round((s.reviewed / Math.max(maxReviews,1)) * 100);
    const acc = s.reviewed > 0 ? Math.round((s.correct/s.reviewed)*100) : 0;
    const isTop = String(l) === String(topLevelKey);
    return `
      <div class="level-stat ${isTop?'top-level':''}">
        ${isTop?'<div style="font-size:10px;color:var(--gold);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px">â˜… Favourite</div>':''}
        <div class="level-stat-badge">HSK ${l}</div>
        <div class="level-stat-char">${LEVEL_CHARS[l]}</div>
        <div class="level-stat-num">${s.reviewed.toLocaleString()}</div>
        <div class="level-stat-sub">${acc}% accuracy</div>
        <div class="level-bar"><div class="level-bar-fill" style="width:${pct}%"></div></div>
      </div>`;
  }).join('');

  // Session rows
  const sessionRows = sessions?.length ? sessions.map(s => {
    const lvl   = s.level === 'all' ? 'All HSK' : `HSK ${s.level}`;
    const dur   = s.durationSeconds ? fmt(s.durationSeconds) : 'â€”';
    const cards = s.cardsReviewed || 0;
    const acc   = cards > 0 ? Math.round(((s.cardsCorrect||0)/cards)*100) : 0;
    const date  = fmtDate(s.startedAt);
    const time  = fmtTime(s.startedAt);
    return `
      <div class="session-row">
        <div>${date} <span style="color:var(--ink-muted);font-size:13px">${time}</span></div>
        <div class="session-level">${lvl}</div>
        <div>${cards} cards</div>
        <div class="session-accurate">${acc}%</div>
        <div style="color:var(--ink-muted)">${dur}</div>
      </div>`;
  }).join('') : `<div class="empty-state">No sessions yet â€” start studying to see your history!</div>`;

  const memberSince = user?.createdAt ? fmtDate(user.createdAt) : 'â€”';

  document.getElementById('content').innerHTML = `
    <div class="page-title">My Statistics</div>
    <div class="page-sub">Tracking your Mandarin journey since ${memberSince}</div>

    <div class="stats-grid">
      <div class="stat-card highlight">
        <div class="stat-card-label">Total Cards</div>
        <div class="stat-card-value">${(user?.totalCards||0).toLocaleString()}</div>
        <div class="stat-card-sub">lifetime reviewed</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">Accuracy</div>
        <div class="stat-card-value">${accuracy}%</div>
        <div class="stat-card-sub">correct recall</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">Time Studying</div>
        <div class="stat-card-value">${fmt(user?.totalTime||0)}</div>
        <div class="stat-card-sub">lifetime total</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">Daily Streak</div>
        <div class="stat-card-value" style="display:flex;align-items:baseline;gap:8px">
          ${streak} <span class="streak-flame">${streak >= 7 ? 'ðŸ”¥' : streak >= 3 ? 'âœ¨' : 'ðŸ“–'}</span>
        </div>
        <div class="stat-card-sub">day${streak!==1?'s':''} in a row</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Weekly Target</div>
      <div class="target-card">
        <div class="target-top">
          <div>
            <div class="target-label">Progress this week</div>
            <div class="target-progress-text">${weekly.toLocaleString()} / ${target.toLocaleString()} cards</div>
            <div class="target-pct">${weekPct}% of weekly goal ${weekPct >= 100 ? 'ðŸŽ‰' : ''}</div>
          </div>
          <div>
            <div class="target-label">Set weekly goal</div>
            <div class="target-form">
              <input class="target-input" type="number" id="targetInput" value="${target}" min="10" max="5000">
              <button class="target-save" onclick="saveTarget()">Save</button>
            </div>
          </div>
        </div>
        <div class="progress-track">
          <div class="progress-fill" style="width:${weekPct}%"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">HSK Level Breakdown</div>
      <div class="levels-grid">${levelsHTML}</div>
    </div>

    <div class="section">
      <div class="section-title">Recent Sessions</div>
      <div class="sessions-table">
        <div class="sessions-header">
          <div>Date</div>
          <div>Level</div>
          <div>Cards</div>
          <div>Accuracy</div>
          <div>Duration</div>
        </div>
        ${sessionRows}
      </div>
    </div>
  `;
}

async function saveTarget() {
  const val = parseInt(document.getElementById('targetInput')?.value);
  if (!val || val < 10) return;
  await fetch('/api/progress/target', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ target: val })
  });
  loadStats(); // refresh
}

loadUser();
loadStats();
</script>
</body>
</html>
